<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To√°n & Ti·∫øng Vi·ªát T√≠ Hon (Supabase)</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ƒê·ªãnh nghƒ©a font ch·ªØ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .game-input:focus, .admin-input:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.4);
        }
        .primary-btn {
            background-color: #ef4444;
            transition: background-color 0.2s, transform 0.1s;
        }
        .primary-btn:hover { background-color: #dc2626; }
        .primary-btn:active { transform: scale(0.98); }
        .subject-btn {
             background-color: #4f46e5; 
             transition: background-color 0.2s, transform 0.1s;
        }
        .subject-btn:hover { background-color: #4338ca; }
        .select-btn {
             background-color: #4f46e5;
             transition: background-color 0.2s, transform 0.1s, opacity 0.3s;
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
             word-break: break-word;
             text-align: left;
        }
        .select-btn:hover { opacity: 0.9; }
        .read-btn {
            background-color: #10b981;
            transition: background-color 0.2s, transform 0.1s;
        }
        .read-btn:hover { background-color: #059669; }
        
        .admin-nav-btn {
            background-color: #3b82f6; /* Blue 500 */
        }
        .admin-nav-btn:hover {
            background-color: #2563eb; /* Blue 600 */
        }
        .danger-btn {
            background-color: #f43f5e; /* Rose 500 */
            transition: background-color 0.2s;
        }
        .danger-btn:hover {
            background-color: #e11d48; /* Rose 600 */
        }
        .admin-section-header {
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 1.25rem; /* text-xl */
            color: #1d4ed8; /* blue-700 */
            border-bottom: 2px solid #93c5fd; /* blue-300 */
            padding-bottom: 0.5rem;
        }
        /* Style cho n√∫t ch·ªØ c√°i M·∫´u Gi√°o */
        .alphabet-btn {
            background-color: #f97316; /* Orange 500 */
            transition: background-color 0.2s, transform 0.1s;
            font-size: 2.5rem; /* text-4xl */
            font-weight: 900;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .alphabet-btn:hover {
            background-color: #ea580c; /* Orange 600 */
            transform: scale(1.05);
        }
        .alphabet-btn:active {
            transform: scale(0.98);
        }
        /* Style cho Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        /* NEW: Class ƒë·ªÉ tƒÉng k√≠ch th∆∞·ªõc emoji trong n√∫t ch·ªçn h·ªçc sinh */
        #student-name-input button {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #student-name-input button span {
            font-size: 1.5rem; /* TƒÉng k√≠ch th∆∞·ªõc emoji */
            margin-right: 0.5rem;
        }

        /* NEW: Style cho n√∫t t·ª´ v·ª±ng (ENGLISH mode) */
        .vocab-btn {
            background-color: #1d4ed8; /* Blue 700 */
            transition: background-color 0.2s, transform 0.1s, opacity 0.3s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
        }
        .vocab-btn:hover {
            background-color: #1e40af; /* Blue 800 */
        }
    </style>
    
    <script type="module">
        // ƒê√°nh d·∫•u ƒë√£ s·∫µn s√†ng ngay l·∫≠p l·∫≠p t·ª©c v√¨ kh√¥ng c·∫ßn ch·ªù Auth
        window.isAuthReady = true; 
    </script>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div id="app" class="w-full max-w-lg bg-white rounded-3xl shadow-2xl p-6 sm:p-10 border-b-8 border-red-500">
        
        <!-- TI√äU ƒê·ªÄ CHUNG -->
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 text-center mb-2">
            üß† H·ªçc M√† Ch∆°i C√πng T√≠ Hon
        </h1>
        <p class="text-center text-sm text-red-500 font-semibold mb-6">Phi√™n b·∫£n l∆∞u tr·ªØ Supabase (Cloud)</p>

        <!-- K·∫æT QU·∫¢ V√Ä ƒêI·ªÇM S·ªê -->
        <div id="stats-display" class="flex justify-between items-center bg-red-50 p-3 rounded-xl mb-6 shadow-inner hidden">
            <div class="text-center">
                <span class="block text-2xl font-bold text-green-700" id="score">0</span>
                <span class="text-xs font-medium text-gray-600">ƒê√∫ng</span>
            </div>
            <div class="text-center">
                <span class="block text-2xl font-bold text-red-700" id="missed">0</span>
                <span class="text-xs font-medium text-gray-600">Sai</span>
            </div>
            <div class="text-center">
                <span class="block text-2xl font-bold text-gray-700" id="current-info">Ch·ªçn L·ªõp</span>
                <span class="text-xs font-medium text-gray-600">C·∫•p ƒë·ªô</span>
            </div>
        </div>
        
        <!-- 0. M√ÄN H√åNH NH·∫¨P T√äN H·ªåC SINH (UPDATED) -->
        <div id="student-name-input" class="space-y-4 mb-8">
            <h2 class="text-lg font-bold text-gray-700 text-center">Con t√™n l√† g√¨? Ch·ªçn t√™n con ƒë·ªÉ b·∫Øt ƒë·∫ßu:</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="selectStudentAndGrade('Th·∫£o Huy·ªÅn', 1)" class="subject-btn w-full p-4 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl bg-pink-500 hover:bg-pink-600">
                    <span class="text-2xl">üå∏</span> Th·∫£o Huy·ªÅn (L·ªõp 1)
                </button>
                <button onclick="selectStudentAndGrade('H·∫±ng Nga', 2)" class="subject-btn w-full p-4 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl bg-orange-500 hover:bg-orange-600">
                    <span class="text-2xl">üåà</span> H·∫±ng Nga (L·ªõp 2)
                </button>
            </div>
            
            <!-- Re-added: Vinh Quang Button for M·∫´u Gi√°o (Grade 0) -->
            <button onclick="selectStudentAndGrade('Vinh Quang', 0)" class="subject-btn w-full p-4 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl bg-green-500 hover:bg-green-600">
                <span class="text-2xl">üöÄ</span> Vinh Quang (M·∫´u Gi√°o)
            </button>
            <!-- END Re-added -->
            
            <button onclick="showScreen('login-area')" class="w-full text-sm font-medium text-blue-600 hover:text-blue-800 transition pt-2">
                üîë ƒêƒÉng nh·∫≠p Admin
            </button>
        </div>

        <!-- 0.5. M√ÄN H√åNH ƒêƒÇNG NH·∫¨P ADMIN -->
        <div id="login-area" class="hidden space-y-4 mb-8">
            <h2 class="text-lg font-bold text-gray-700 text-center">ƒêƒÉng nh·∫≠p Qu·∫£n tr·ªã</h2>
            <input type="text" id="admin-user" placeholder="T√™n ƒëƒÉng nh·∫≠p (admin)" value="admin" class="admin-input w-full p-3 border-2 border-gray-300 rounded-xl outline-none transition duration-200">
            <input type="password" id="admin-pass" placeholder="M·∫≠t kh·∫©u (admin)" value="admin" class="admin-input w-full p-3 border-2 border-gray-300 rounded-xl outline-none transition duration-200" onkeydown="if(event.key === 'Enter') adminLogin()">
            <button onclick="adminLogin()" class="subject-btn w-full p-3 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl">
                ƒêƒÉng Nh·∫≠p
            </button>
            <p id="login-error" class="text-sm text-red-500 text-center"></p>
            <button onclick="showScreen('student-name-input')" class="w-full text-sm font-medium text-indigo-600 hover:text-indigo-800 transition pt-2">
                Quay l·∫°i
            </button>
        </div>

        <!-- 1. CH·ªåN L·ªöP (PLAYER) (Gi·ªù ch·ªâ d√πng cho t√™n nh·∫≠p th·ªß c√¥ng) -->
        <div id="grade-selection" class="space-y-4 mb-8 hidden">
            <h2 class="text-lg font-bold text-gray-700 text-center">Con h·ªçc L·ªõp m·∫•y?</h2>
            <button onclick="selectGrade(1)" class="primary-btn w-full p-4 text-xl font-bold text-white rounded-xl shadow-lg hover:shadow-xl">
                üåü L·ªõp 1
            </button>
            <button onclick="selectGrade(2)" class="primary-btn w-full p-4 text-xl font-bold text-white rounded-xl shadow-lg hover:shadow-xl">
                üöÄ L·ªõp 2
            </button>
            <button onclick="showScreen('student-name-input')" class="w-full text-sm font-medium text-red-600 hover:text-red-800 transition pt-2">
                Quay l·∫°i Nh·∫≠p T√™n
            </button>
        </div>

        <!-- 2. CH·ªåN M√îN H·ªåC (PLAYER) -->
        <div id="subject-selection" class="hidden space-y-4 mb-8">
            <h2 class="text-lg font-bold text-gray-700 text-center">Con mu·ªën luy·ªán t·∫≠p M√¥n g√¨?</h2>
            <button onclick="selectSubject('TOAN')" class="subject-btn w-full p-3 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl">
                üßÆ To√°n H·ªçc
            </button>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button onclick="selectSubject('SPELL')" class="subject-btn w-full p-3 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl bg-purple-600 hover:bg-purple-700">
                    üáªüá≥ Ch√≠nh T·∫£ (Ch·ªçn)
                </button>
                <button onclick="selectSubject('READ')" class="subject-btn w-full p-3 text-lg font-bold text-white rounded-xl shadow-lg hover:bg-teal-700 bg-teal-600">
                    üéß Luy·ªán ƒê·ªçc (Nghe & Ch·ªçn)
                </button>
            </div>
            <!-- ENGLISH BUTTON -->
            <button onclick="selectSubject('ENGLISH')" class="subject-btn w-full p-3 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl bg-blue-600 hover:bg-blue-700">
                üá¨üáß Ti·∫øng Anh (Luy·ªán T·ª´)
            </button>
            <!-- END ENGLISH BUTTON -->
            <button onclick="showScreen('student-name-input')" class="w-full text-sm font-medium text-red-600 hover:text-red-800 transition pt-2">
                Quay l·∫°i Ch·ªçn L·ªõp
            </button>
        </div>
        
        <!-- 3. KHU V·ª∞C THI·∫æT L·∫¨P B√ÄI (PLAYER) -->
        <div id="setup-area" class="hidden text-center">
            <h2 class="text-xl font-bold text-gray-700 mb-4" id="setup-title"></h2>
            
            <div class="p-4 border border-indigo-200 rounded-xl mb-6 bg-indigo-50">
                <p class="text-sm text-indigo-700 font-semibold mb-2" id="setup-limit-text">Gi·ªõi h·∫°n: M·ªói l·∫ßn luy·ªán t·∫≠p c√≥ 30 c√¢u h·ªèi.</p>
                <div class="flex justify-center items-center gap-4">
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-600 mb-1">B√†i B·∫Øt ƒê·∫ßu:</label>
                        <select id="start-lesson" class="game-input w-full p-2 text-center border-2 rounded-lg outline-none"></select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-600 mb-1">B√†i K·∫øt Th√∫c:</label>
                        <select id="end-lesson" class="game-input w-full p-2 text-center border-2 rounded-lg outline-none"></select>
                    </div>
                </div>
                <p class="Ëá™Ë∫´ÁöÑxs text-red-500 mt-2" id="lesson-error"></p>
                <button onclick="checkLessonRange()" class="subject-btn mt-4 w-full p-2 text-md font-bold text-white rounded-xl">
                    Ki·ªÉm tra & C·∫≠p nh·∫≠t
                </button>
            </div>

            <button onclick="startLessonSet()" class="primary-btn w-full p-3 text-xl font-bold text-white rounded-xl shadow-lg hover:shadow-xl">
                ‚ñ∂Ô∏è B·∫Øt ƒê·∫ßu Luy·ªán T·∫≠p (30 c√¢u)
            </button>
            <button onclick="showScreen('subject-selection')" class="w-full text-sm font-medium text-red-600 hover:text-red-800 transition pt-3">
                Quay l·∫°i Ch·ªçn M√¥n
            </button>
        </div>

        <!-- 4. KHU V·ª∞C CH∆†I GAME (PLAYER) -->
        <div id="game-area" class="hidden text-center">
            
            <div id="feedback" class="h-8 mb-4 text-center font-bold text-lg"></div>

            <!-- HI·ªÇN TH·ªä C√ÇU H·ªéI -->
            <div class="bg-yellow-100 p-6 rounded-2xl mb-6 shadow-md border-2 border-dashed border-red-300 min-h-[150px] flex flex-col justify-center">
                <p class="text-2xl sm:text-3xl font-black text-gray-800 mb-2" id="question-text">
                    S·∫µn s√†ng...
                </p>
                <div id="image-hint" class="text-base font-medium text-gray-600 my-2"></div>
                
                <!-- N√öT CHO PH√âP ƒê·ªåC V√Ä D·ªäCH -->
                <div id="reading-controls" class="hidden mt-4 space-y-2">
                    <button id="read-button" onclick="playAudio()" class="read-btn p-3 text-lg font-bold text-white rounded-xl shadow-md disabled:bg-gray-400 w-full sm:w-1/2 mx-auto">
                        üîä ƒê·ªçc L·∫°i
                    </button>
                    <!-- NEW: N√∫t Gi·∫£i th√≠ch (ch·ªâ cho Ti·∫øng Anh) -->
                    <button id="explain-btn" onclick="getVocabularyExplanation()" class="subject-btn p-3 text-sm font-bold text-white rounded-xl shadow-md disabled:bg-gray-400 w-full sm:w-1/2 mx-auto bg-green-600 hover:bg-green-700 hidden flex items-center justify-center">
                        <span id="explain-text">ü§ñ H·ªèi AI Gi·∫£i Th√≠ch</span>
                        <svg id="explain-loading" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    </button>
                    <!-- X√≥a n√∫t D·ªãch & ƒê·ªçc c≈© (translate-btn) -->
                </div>
            </div>
            
            <!-- NEW: Khu v·ª±c hi·ªÉn th·ªã gi·∫£i th√≠ch AI -->
            <div id="ai-explanation-output" class="p-4 bg-gray-50 rounded-xl mb-6 border border-gray-200 text-left hidden">
                <p class="text-gray-600 font-bold">Gi·∫£i th√≠ch t·ª´:</p>
            </div>
            <!-- END NEW -->

            <!-- KHU V·ª∞C TR·∫¢ L·ªúI B·∫∞NG CH·ªåN N√öT (S·∫Ω d√πng ƒë·ªÉ hi·ªÉn th·ªã t·ª´ v·ª±ng trong ch·∫ø ƒë·ªô ENGLISH) -->
            <div id="selection-controls" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <!-- N√∫t ƒë√°p √°n / N√∫t t·ª´ v·ª±ng s·∫Ω ƒë∆∞·ª£c ch√®n ·ªü ƒë√¢y b·∫±ng JavaScript -->
            </div>

            <!-- HI·ªÇN TH·ªä TR·∫†NG TH√ÅI B√ÄI THI (·∫®n cho Ti·∫øng Anh Vocab) -->
            <p id="lesson-progress" class="text-sm font-bold text-indigo-600 mb-4">
                C√¢u: 1 / 30
            </p>

            <!-- C·∫¨P NH·∫¨T: Th√™m ID ƒë·ªÉ nh·∫Øm m·ª•c ti√™u ch√≠nh x√°c -->
            <button id="quit-game-btn" onclick="endLessonSet()" class="w-full text-sm font-medium text-red-600 hover:text-red-800 transition">
                D·ª´ng Luy·ªán T·∫≠p & Quay l·∫°i Ch·ªçn B√†i
            </button>
        </div>
        
        <!-- 5. M√ÄN H√åNH ADMIN -->
        <div id="admin-panel" class="hidden space-y-4 mb-8">
            <h2 class="text-2xl font-bold text-blue-700 text-center">B·∫£ng Qu·∫£n Tr·ªã N·ªôi Dung</h2>
            <p class="text-xs text-center text-red-600 font-semibold mb-3">L∆∞u tr·ªØ b·∫±ng Supabase (y√™u c·∫ßu c·∫•u h√¨nh)</p>

            <!-- 1. T·∫†O C·∫§U TR√öC B√ÄI H·ªåC M·ªöI -->
            <div class="bg-indigo-50 p-4 rounded-xl shadow-inner">
                <h3 class="admin-section-header text-indigo-700 border-indigo-300 mt-0">1. T·∫°o C·∫•u Tr√∫c B√†i H·ªçc M·ªõi</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">L·ªõp</label>
                        <select id="new-lesson-grade" class="admin-input w-full p-2 border-2 rounded-lg">
                            <option value="1">L·ªõp 1</option>
                            <option value="2">L·ªõp 2</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">M√¥n</label>
                        <select id="new-lesson-subject" class="admin-input w-full p-2 border-2 rounded-lg">
                            <option value="TOAN">To√°n H·ªçc</option>
                            <option value="SPELL">Ch√≠nh T·∫£</option>
                            <option value="READ">Luy·ªán ƒê·ªçc</option>
                            <option value="ENGLISH">Ti·∫øng Anh</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">S·ªë B√†i H·ªçc</label>
                    <input type="number" id="new-lesson-number" class="admin-input w-full p-2 border-2 rounded-lg" placeholder="VD: 3">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">T√™n B√†i H·ªçc (VD: Ph√©p c·ªông c√≥ nh·ªõ)</label>
                    <input type="text" id="new-lesson-name-input" class="admin-input w-full p-2 border-2 rounded-lg" placeholder="Nh·∫≠p t√™n b√†i h·ªçc">
                </div>
                
                <button onclick="createNewLessonStructure()" class="subject-btn w-full p-3 text-white font-bold rounded-xl flex items-center justify-center">
                    ‚ûï T·∫°o C·∫•u Tr√∫c B√†i H·ªçc
                </button>
            </div>


            <!-- 2. T·∫†O C√ÇU H·ªéI B·∫∞NG AI (V·∫™N GI·ªÆ NGUY√äN) -->
            <div class="p-4 border border-blue-400 rounded-xl space-y-3">
                <h3 class="admin-section-header text-blue-700 border-blue-300">2. T·∫°o C√¢u H·ªèi B·∫±ng AI (Gemini)</h3>
                <div class="bg-yellow-50 p-3 rounded-lg text-sm text-yellow-800 font-medium">
                    <span id="ai-target-info">Vui l√≤ng ch·ªçn B√†i H·ªçc ·ªü m·ª•c 3 tr∆∞·ªõc khi t·∫°o c√¢u h·ªèi.</span>
                </div>
                
                <textarea id="ai-prompt" rows="3" placeholder="V√≠ d·ª•: T·∫°o 30 ph√©p tr·ª´ c√≥ nh·ªõ trong ph·∫°m vi 100. Ho·∫∑c: T·∫°o 30 c√¢u ch√≠nh t·∫£ ph√¢n bi·ªát s/x. (V·ªõi Ti·∫øng Anh: Ch·ªâ c·∫ßn nh·∫≠p 30 t·ª´ v·ª±ng c∆° b·∫£n, m·ªói t·ª´ m·ªôt d√≤ng)" class="admin-input w-full p-2 border-2 rounded-lg"></textarea>
                
                <button onclick="generateAndSaveQuestions()" class="admin-nav-btn w-full p-3 text-white font-bold rounded-xl flex items-center justify-center disabled:bg-gray-400" id="ai-generate-btn">
                    <span id="ai-generate-text">‚ú® T·∫°o & L∆∞u 30 C√¢u H·ªèi M·ªõi</span>
                    <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                </button>
                <!-- NEW: Th√¥ng b√°o tr·∫°ng th√°i AI ngay d∆∞·ªõi n√∫t -->
                <p id="ai-status-message" class="text-sm font-semibold text-center mt-2"></p>
                <p id="ai-result-preview" class="text-xs text-gray-600 whitespace-pre-wrap mt-2"></p>
            </div>
            
            <!-- 3. QU·∫¢N L√ù N·ªòI DUNG HI·ªÜN C√ì -->
             <div class="bg-blue-50 p-4 rounded-xl shadow-inner">
                <h3 class="admin-section-header text-blue-700 border-blue-300">3. Qu·∫£n L√Ω N·ªôi Dung Hi·ªán C√≥</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">L·ªõp</label>
                        <select id="admin-grade" class="admin-input w-full p-2 border-2 rounded-lg" onchange="loadLessonOptions()">
                            <option value="1">L·ªõp 1</option>
                            <option value="2">L·ªõp 2</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">M√¥n</label>
                        <select id="admin-subject" onchange="loadLessonOptions()" class="admin-input w-full p-2 border-2 rounded-lg">
                            <option value="TOAN">To√°n H·ªçc</option>
                            <option value="SPELL">Ch√≠nh T·∫£</option>
                            <option value="READ">Luy·ªán ƒê·ªçc</option>
                            <option value="ENGLISH">Ti·∫øng Anh</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">B√†i H·ªçc</label>
                    <div class="flex gap-2">
                        <select id="admin-lesson" class="admin-input flex-grow p-2 border-2 rounded-lg" onchange="previewLesson()">
                        </select>
                    </div>
                </div>

                <div id="lesson-name-control" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700">T√™n B√†i H·ªçc:</label>
                    <div class="flex gap-2">
                        <input type="text" id="admin-lesson-name" class="admin-input flex-grow p-2 border-2 rounded-lg" placeholder="Nh·∫≠p t√™n b√†i h·ªçc (VD: Ph√©p c·ªông c√≥ nh·ªõ)">
                        <button onclick="updateLessonName()" class="admin-nav-btn text-white p-2 rounded-lg text-sm font-bold">L∆∞u T√™n</button>
                    </div>
                </div>

                <!-- ƒê√É X√ìA: TO√ÄN B·ªò PH·∫¶N C·∫§U H√åNH GI·ªöI H·∫†N B√ÄI H·ªåC CHO PLAYER -->
                
                <p id="lesson-preview" class="text-sm font-medium text-gray-700">T·ªïng s·ªë c√¢u trong b√†i n√†y: 0</p>
                <div class="grid grid-cols-2 gap-2 mt-4">
                    <!-- NEW: N√∫t Xem Chi Ti·∫øt C√¢u H·ªèi -->
                    <button onclick="showQuestionDetailsModal()" id="detail-question-btn" class="subject-btn p-3 text-white font-bold rounded-xl disabled:bg-gray-400">
                        üìù Xem Chi Ti·∫øt C√¢u H·ªèi
                    </button>
                    <button onclick="confirmDeleteLesson()" class="danger-btn p-3 text-white font-bold rounded-xl">
                        ‚ö†Ô∏è X√≥a TO√ÄN B·ªò B√†i H·ªçc n√†y
                    </button>
                </div>
            </div>

            <!-- 4. L·ªäCH S·ª¨ L√ÄM B√ÄI -->
            <div id="history-management" class="p-4 border border-green-400 rounded-xl space-y-3 bg-green-50">
                <h3 class="admin-section-header text-green-700 border-green-300">4. L·ªãch S·ª≠ L√†m B√†i C·ªßa H·ªçc Sinh</h3>
                
                <!-- NEW: N√∫t ·∫©n/hi·ªán L·ªãch s·ª≠ -->
                <button id="history-toggle-btn" onclick="toggleHistoryContent()" class="w-full p-2 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-150">
                    ‚ñ∂Ô∏è Hi·ªÉn th·ªã L·ªãch S·ª≠
                </button>

                <!-- NEW: N·ªôi dung L·ªãch s·ª≠ ƒë∆∞·ª£c ·∫©n ban ƒë·∫ßu -->
                <div id="history-content" class="hidden space-y-3 pt-3">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">L·ªçc theo T√™n HS:</label>
                            <select id="history-filter-name" class="admin-input w-full p-2 border-2 rounded-lg" onchange="displayHistory()"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">L·ªçc theo M√¥n:</label>
                            <select id="history-filter-subject" class="admin-input w-full p-2 border-2 rounded-lg" onchange="displayHistory()">
                                <option value="ALL">T·∫•t c·∫£</option>
                                <option value="TOAN">To√°n H·ªçc</option>
                                <option value="SPELL">Ch√≠nh T·∫£</option>
                                <option value="READ">Luy·ªán ƒê·ªçc</option>
                                <option value="ENGLISH">Ti·∫øng Anh</option>
                            </select>
                        </div>
                    </div>
                    <div id="history-list" class="space-y-4 pt-4 text-center">
                        <p class="text-sm text-gray-600">L·ªãch s·ª≠ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y sau khi h·ªçc sinh l√†m b√†i.</p>
                    </div>
                </div>
            </div>

            <!-- 5. QU·∫¢N L√ù API KEYS GEMINI (NEW) -->
            <div class="p-4 border border-purple-400 rounded-xl space-y-3 bg-purple-50">
                <h3 class="admin-section-header text-purple-700 border-purple-300">5. Qu·∫£n L√Ω API Keys Gemini</h3>
                <p class="text-xs text-gray-700">Th√™m nhi·ªÅu keys ƒë·ªÉ c√≥ c∆° ch·∫ø t·ª± ƒë·ªông chuy·ªÉn ƒë·ªïi khi m·ªôt key b·ªã l·ªói ho·∫∑c qu√° t·∫£i.</p>
                
                <div class="flex gap-2 mb-2">
                    <input type="text" id="gemini-key-input" class="admin-input flex-grow p-2 border-2 rounded-lg" placeholder="Nh·∫≠p API Key Gemini m·ªõi...">
                    <button onclick="addGeminiKey()" class="admin-nav-btn text-white p-2 rounded-lg text-sm font-bold bg-purple-600 hover:bg-purple-700">Th√™m Key</button>
                </div>

                <div id="gemini-keys-list" class="space-y-2 max-h-48 overflow-y-auto p-2 bg-purple-100 rounded-lg border border-purple-200">
                    <!-- Danh s√°ch keys s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
            </div>
            
            <p id="admin-status" class="text-sm text-green-600 font-semibold text-center pt-4"></p>

            <button onclick="adminLogout()" class="w-full text-sm font-medium text-red-600 hover:text-red-800 transition pt-3">
                ƒêƒÉng Xu·∫•t & Quay l·∫°i
            </button>
        </div>

    </div>

    <!-- MODAL HI·ªÇN TH·ªä CHI TI·∫æT C√ÇU H·ªéI -->
    <div id="question-detail-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-blue-700 mb-4 border-b pb-2" id="modal-lesson-title">Chi Ti·∫øt C√¢u H·ªèi B√†i X</h3>
            <div id="modal-questions-list" class="space-y-4">
                <!-- N·ªôi dung chi ti·∫øt c√¢u h·ªèi ƒë∆∞·ª£c ch√®n b·ªüi JavaScript -->
                <p class="text-gray-500 text-center">ƒêang t·∫£i...</p>
            </div>
            <button onclick="closeQuestionDetailsModal()" class="primary-btn w-full p-3 text-white font-bold rounded-xl mt-6">
                ƒê√≥ng
            </button>
        </div>
    </div>


    <script id="script_app_logic">
        // --- SUPABASE CONFIGURATION ---
        const SUPABASE_URL = 'https://vuzbzjieuqghneipkprg.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1emJ6amlldXFnaG5laXBrcHJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNTUwMDIsImV4cCI6MjA3NDYzMTAwMn0.xsPbKPJK74RM6MmqOBjjnyon6z4vVo8vrWmzFFvx4xc'; 

        const supabase = SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase
                                ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
                                : null;

        if (!supabase) {
            console.error("Vui l√≤ng c·∫•u h√¨nh SUPABASE_URL v√† SUPABASE_ANON_KEY.");
        }
        
        // --- BI·∫æN TO√ÄN C·ª§C ---
        const TOTAL_QUESTIONS = 30;
        let score = 0;
        let missed = 0;
        let currentGrade = 0;
        let currentSubject = '';
        let currentAnswer = null; 
        let currentMode = ''; 
        let currentTextToRead = ''; 
        let studentName = ''; 
        let incorrectQuestions = []; 
        
        let lessonStart = 1;
        let lessonEnd = 5;
        let lessonsAvailable = {}; 
        let learningHistory = []; 
        
        let questionCount = 0; 
        let isLessonSetMode = false;
        let lessonSetQuestions = []; 
        let currentQuestionIndex = 0; 
        let currentVocabWord = ''; // NEW: T·ª´ v·ª±ng hi·ªán t·∫°i ƒëang ƒë∆∞·ª£c ch·ªçn

        // BI·∫æN CHO GEMINI
        let geminiKeys = [];
        let currentKeyIndex = 0;
        
        // --- ELEMENTS ---
        const scoreEl = document.getElementById('score');
        const missedEl = document.getElementById('missed');
        const currentInfoEl = document.getElementById('current-info');
        const questionTextEl = document.getElementById('question-text');
        const feedbackEl = document.getElementById('feedback');
        const imageHintEl = document.getElementById('image-hint');
        const readingControlsEl = document.getElementById('reading-controls'); 
        const readButtonEl = document.getElementById('read-button'); 
        const statsDisplayEl = document.getElementById('stats-display');
        
        const selectionControlsEl = document.getElementById('selection-controls'); 

        const studentNameInputScreen = document.getElementById('student-name-input');

        const loginAreaEl = document.getElementById('login-area');
        const gradeSelectionEl = document.getElementById('grade-selection');
        const subjectSelectionEl = document.getElementById('subject-selection');
        const setupAreaEl = document.getElementById('setup-area');
        const gameAreaEl = document.getElementById('game-area');

        const setupTitleEl = document.getElementById('setup-title');
        const startLessonEl = document.getElementById('start-lesson'); 
        const endLessonEl = document.getElementById('end-lesson'); 
        const lessonErrorEl = document.getElementById('lesson-error');
        const lessonProgressEl = document.getElementById('lesson-progress');
        const quitGameBtn = document.getElementById('quit-game-btn'); 
        const setupLimitTextEl = document.getElementById('setup-limit-text'); // New Element

        // Admin Elements
        const adminPanelEl = document.getElementById('admin-panel');
        const adminGradeEl = document.getElementById('admin-grade');
        const adminSubjectEl = document.getElementById('admin-subject');
        const adminLessonEl = document.getElementById('admin-lesson');
        const adminLessonNameEl = document.getElementById('admin-lesson-name');
        const lessonNameControlEl = document.getElementById('lesson-name-control');
        const lessonPreviewEl = document.getElementById('lesson-preview');
        const adminStatusEl = document.getElementById('admin-status');
        
        const aiPromptEl = document.getElementById('ai-prompt');
        const aiGenerateBtn = document.getElementById('ai-generate-btn');
        const aiGenerateTextEl = document.getElementById('ai-generate-text');
        const aiLoadingSpinnerEl = document.getElementById('ai-loading-spinner');
        const aiResultPreviewEl = document.getElementById('ai-result-preview');
        const aiTargetInfoEl = document.getElementById('ai-target-info');
        const aiStatusMessageEl = document.getElementById('ai-status-message');

        const newLessonGradeEl = document.getElementById('new-lesson-grade');
        const newLessonSubjectEl = document.getElementById('new-lesson-subject');
        const newLessonNumberEl = document.getElementById('new-lesson-number');
        const newLessonNameInputEl = document.getElementById('new-lesson-name-input');
        
        const historyFilterNameEl = document.getElementById('history-filter-name');
        const historyFilterSubjectEl = document.getElementById('history-filter-subject');
        const historyListEl = document.getElementById('history-list');
        const historyContentEl = document.getElementById('history-content');
        const historyToggleButton = document.getElementById('history-toggle-btn');
        
        // GEMINI ADMIN ELEMENTS
        const geminiKeyInputEl = document.getElementById('gemini-key-input');
        const geminiKeysListEl = document.getElementById('gemini-keys-list');

        // Modal Elements
        const questionDetailModalEl = document.getElementById('question-detail-modal');
        const modalLessonTitleEl = document.getElementById('modal-lesson-title');
        const modalQuestionsListEl = document.getElementById('modal-questions-list');
        const detailQuestionBtn = document.getElementById('detail-question-btn');
        
        // NEW: Translation/Explanation Elements
        const explainBtn = document.getElementById('explain-btn'); // New element
        const explainTextEl = document.getElementById('explain-text'); // New element
        const explainLoadingEl = document.getElementById('explain-loading'); // New element
        const aiExplanationOutputEl = document.getElementById('ai-explanation-output'); // New element

        
        // B·∫£ng ch·ªØ c√°i M·∫´u Gi√°o 
        const ALPHABET_QUESTIONS = [
            { q: "A", a: "A", options: ["A"], text: "a", type: "ALPHABET" },
            { q: "B", a: "B", options: ["B"], text: "b·ªù", type: "ALPHABET" },
            { q: "C", a: "C", options: ["C"], text: "c·ªù", type: "ALPHABET" },
            { q: "D", a: "D", options: ["D"], text: "d·ªù", type: "ALPHABET" },
            { q: "ƒê", a: "ƒê", options: ["ƒê"], text: "ƒë·ªù", type: "ALPHABET" },
            { q: "E", a: "E", options: ["E"], text: "e", type: "ALPHABET" },
            { q: "√ä", a: "√ä", options: ["√ä"], text: "√™", type: "ALPHABET" },
            { q: "G", a: "G", options: ["G"], text: "g·ªù", type: "ALPHABET" },
            { q: "H", a: "H", options: ["H"], text: "h·ªù", type: "ALPHABET" },
            { q: "I", a: "I", options: ["I"], text: "i", type: "ALPHABET" },
            { q: "K", a: "K", options: ["K"], text: "ca", type: "ALPHABET" },
            { q: "L", a: "L", options: ["L"], text: "l·ªù", type: "ALPHABET" },
            { q: "M", a: "M", options: ["M"], text: "m·ªù", type: "ALPHABET" },
            { q: "N", a: "N", options: ["N"], text: "n·ªù", type: "ALPHABET" },
            { q: "O", a: "O", options: ["O"], text: "o", type: "ALPHABET" },
            { q: "√î", a: "√î", options: ["√î"], text: "√¥", type: "ALPHABET" }, 
            { q: "∆†", a: "∆†", options: ["∆†"], text: "∆°", type: "ALPHABET" }, 
            { q: "P", a: "P", options: ["P"], text: "ph·ªù", type: "ALPHABET" },
            { q: "Q", a: "Q", options: ["Q"], text: "qu·ªù", type: "ALPHABET" },
            { q: "R", a: "R", options: ["R"], text: "r·ªù", type: "ALPHABET" },
            { q: "S", a: "S", options: ["S"], text: "s·ªù", type: "ALPHABET" },
            { q: "T", a: "T", options: ["T"], text: "t·ªù", type: "ALPHABET" },
            { q: "U", a: "U", options: ["U"], text: "u", type: "ALPHABET" },
            { q: "∆Ø", a: "∆Ø", options: ["∆Ø"], text: "∆∞", type: "ALPHABET" }, 
            { q: "V", a: "V", options: ["V"], text: "v√™", type: "ALPHABET" },
            { q: "X", a: "X", options: ["X"], text: "x·ªù", type: "ALPHABET" },
            { q: "Y", a: "Y", options: ["Y"], text: "i d√†i", type: "ALPHABET" },
        ];
        const ALPHABET_LETTERS = ALPHABET_QUESTIONS.map(q => q.q);
        
        // --- TTS (CHUY·ªÇN VƒÇN B·∫¢N TH√ÄNH GI·ªåNG N√ìI C·ª¶A TR√åNH DUY·ªÜT) ---

        function speakText(text, lang = 'vi-VN') {
            if (!text) return; 
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = lang; 
                utterance.rate = lang === 'en-US' ? 0.9 : 0.7; // TƒÉng t·ªëc ƒë·ªô ƒë·ªçc Ti·∫øng Anh
                utterance.pitch = lang === 'en-US' ? 1.0 : 1.1; // Ch·ªânh tone
                
                window.speechSynthesis.speak(utterance);
                
                readButtonEl.disabled = true;
                utterance.onend = () => {
                    readButtonEl.disabled = false;
                };
            } else {
                feedbackEl.textContent = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªçc t·ª± ƒë·ªông.";
                feedbackEl.className = 'h-8 mb-4 text-center font-bold text-lg text-red-600';
            }
        }

        function playAudio() {
            const lang = (currentSubject === 'ENGLISH') ? 'en-US' : 'vi-VN';
            if (currentMode && currentTextToRead) {
                speakText(currentTextToRead, lang);
            }
        }
        // --- END TTS FUNCTIONS ---

        // --- CHUY·ªÇN M√ÄN H√åNH & CH·ªåN M√îN ---
        function showScreen(screenId) {
            // Hide all screens
            const screens = [studentNameInputScreen, loginAreaEl, gradeSelectionEl, subjectSelectionEl, setupAreaEl, gameAreaEl, adminPanelEl];
            screens.forEach(screen => screen.classList.add('hidden'));
            
            // Show target screen
            document.getElementById(screenId).classList.remove('hidden');
            
            // Hi·ªÉn th·ªã th·ªëng k√™ ch·ªâ trong ch·∫ø ƒë·ªô Player
            // Lu√¥n ·∫©n score/missed/progress cho ch·∫ø ƒë·ªô Ti·∫øng Anh Vocab
            const isGameMode = screenId === 'game-area';
            const isVocabMode = currentSubject === 'ENGLISH' && isGameMode && !isLessonSetMode; // Check for vocabulary mode
            const isAlphabetMode = currentSubject === 'ALPHABET' && isGameMode;

            if (isVocabMode || isAlphabetMode) {
                statsDisplayEl.classList.add('hidden');
                lessonProgressEl.classList.add('hidden');
            } else if (screenId === 'grade-selection' || screenId === 'subject-selection' || screenId === 'setup-area' || isGameMode) {
                statsDisplayEl.classList.remove('hidden');
                lessonProgressEl.classList.remove('hidden');
            } else {
                statsDisplayEl.classList.add('hidden');
            }
            
            // T·∫£i d·ªØ li·ªáu c·∫ßn thi·∫øt khi v√†o Admin Panel
            if (screenId === 'admin-panel') {
                loadGeminiKeys();
                loadLessonOptions();
                loadHistoryNames(); 
            }
        }
        
        function selectStudentAndGrade(name, grade) {
            studentName = name;
            currentGrade = grade;
            currentInfoEl.textContent = `L·ªõp ${grade === 0 ? 'M·∫´u Gi√°o' : grade} | ${studentName}`;
            score = 0;
            missed = 0;
            updateScoreDisplay();
            
            if (grade === 0) {
                currentSubject = 'ALPHABET';
                startAlphabetLesson();
            } else {
                showScreen('subject-selection');
            }
        }

        // --- ADMIN LOGIN LOGIC ---
        function adminLogin() {
            const user = document.getElementById('admin-user').value;
            const pass = document.getElementById('admin-pass').value;
            const errorEl = document.getElementById('login-error');

            if (user === 'admin' && pass === 'admin') {
                errorEl.textContent = 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!';
                errorEl.className = 'text-sm text-green-600 text-center';
                showScreen('admin-panel');
                loadLessonOptions();
            } else {
                errorEl.textContent = 'Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u. Vui l√≤ng th·ª≠ l·∫°i.';
                errorEl.className = 'text-sm text-red-500 text-center';
            }
        }
        
        function adminLogout() {
             adminStatusEl.textContent = '';
             showScreen('student-name-input'); 
        }

        // --- PLAYER MODE LOGIC ---
        function selectGrade(grade) {
            currentGrade = grade;
            currentInfoEl.textContent = `L·ªõp ${grade} | ${studentName}`; 
            score = 0;
            missed = 0;
            updateScoreDisplay();
            showScreen('subject-selection');
        }

        function selectSubject(subject) {
            currentSubject = subject;
            let subjectName = '';

            if (subject === 'ALPHABET') {
                startAlphabetLesson();
                return; 
            }
            
            if (subject === 'TOAN') { subjectName = 'To√°n H·ªçc'; setupTitleEl.textContent = 'Thi·∫øt L·∫≠p B√†i T·∫≠p To√°n'; setupLimitTextEl.textContent = 'Gi·ªõi h·∫°n: M·ªói l·∫ßn luy·ªán t·∫≠p c√≥ 30 c√¢u h·ªèi.'; }
            else if (subject === 'SPELL') { subjectName = 'Ch√≠nh T·∫£ (Ch·ªçn)'; setupTitleEl.textContent = 'Thi·∫øt L·∫≠p B√†i T·∫≠p Ch√≠nh T·∫£'; setupLimitTextEl.textContent = 'Gi·ªõi h·∫°n: M·ªói l·∫ßn luy·ªán t·∫≠p c√≥ 30 c√¢u h·ªèi.'; }
            else if (subject === 'READ') { subjectName = 'Luy·ªán ƒê·ªçc (Nghe & Ch·ªçn)'; setupTitleEl.textContent = 'Thi·∫øt L·∫≠p B√†i T·∫≠p Luy·ªán ƒê·ªçc'; setupLimitTextEl.textContent = 'Gi·ªõi h·∫°n: M·ªói l·∫ßn luy·ªán t·∫≠p c√≥ 30 c√¢u h·ªèi.'; }
            else if (subject === 'ENGLISH') { 
                subjectName = 'Ti·∫øng Anh (Luy·ªán T·ª´)'; 
                setupTitleEl.textContent = 'Thi·∫øt L·∫≠p B√†i T·∫≠p Ti·∫øng Anh';
                setupLimitTextEl.textContent = 'L∆∞u √Ω: M√¥n Ti·∫øng Anh ·ªü ch·∫ø ƒë·ªô n√†y l√† Luy·ªán T·ª´ V·ª±ng t∆∞∆°ng t√°c, kh√¥ng c√≥ t√≠nh ƒëi·ªÉm.'; 
            } 
            
            currentInfoEl.textContent = `${subjectName} (L·ªõp ${currentGrade}) | ${studentName}`;
            lessonErrorEl.textContent = '';
            
            startLessonEl.value = 1; 
            endLessonEl.value = 5;

            checkLessonRange(false); 
            showScreen('setup-area');
        }

        // Re-added Alphabet Functions
        function startAlphabetLesson() {
            currentMode = 'ALPHABET';
            isLessonSetMode = true; // Use true to prevent game logic from running
            questionTextEl.className = 'text-2xl sm:text-3xl font-black text-gray-800 mb-2'; 
            questionTextEl.textContent = 'Ch·ªçn ch·ªØ c√°i b√© mu·ªën luy·ªán ƒë·ªçc:'; 
            imageHintEl.textContent = '(Nh·∫•p v√†o ch·ªØ c√°i ƒë·ªÉ nghe ph√°t √¢m)';
            imageHintEl.className = 'text-base font-medium text-gray-600 my-2';
            readingControlsEl.classList.add('hidden');
            aiExplanationOutputEl.classList.add('hidden'); // Ensure AI area is hidden

            setupAlphabetButtons();
            
            selectionControlsEl.classList.remove('hidden');
            lessonProgressEl.classList.add('hidden');
            statsDisplayEl.classList.add('hidden');

            showScreen('game-area');

            // FIX: S·ª≠ d·ª•ng ID ƒë·ªÉ ch·ªâ g√°n h√†m tho√°t cho n√∫t D·ª´ng Luy·ªán T·∫≠p
            quitGameBtn.onclick = () => {
                isLessonSetMode = false;
                lessonProgressEl.classList.remove('hidden');
                showScreen('student-name-input');
            };
        }

        function setupAlphabetButtons() {
            selectionControlsEl.innerHTML = '';
            selectionControlsEl.className = 'grid grid-cols-4 sm:grid-cols-6 gap-3 mb-6';

            ALPHABET_LETTERS.forEach(letter => {
                const button = document.createElement('button');
                button.textContent = letter.toUpperCase(); 
                button.className = 'alphabet-btn text-white rounded-xl shadow-lg';
                
                const phonemeData = ALPHABET_QUESTIONS.find(q => q.q === letter.toUpperCase());
                const textToSpeak = phonemeData ? phonemeData.text : letter.toLowerCase();

                button.onclick = () => {
                    currentTextToRead = textToSpeak; 
                    speakText(textToSpeak, 'vi-VN'); // Always read Vietnamese phonemes
                    
                    feedbackEl.textContent = `ƒêang ƒë·ªçc: ${textToSpeak.toUpperCase()}`;
                    feedbackEl.className = 'h-8 mb-4 text-center font-bold text-2xl text-orange-600 animate-pulse'; 
                    setTimeout(() => {
                        feedbackEl.textContent = "";
                        feedbackEl.className = 'h-8 mb-4 text-center font-bold text-lg';
                    }, 1000);
                };
                selectionControlsEl.appendChild(button);
            });
        }
        
        async function endAlphabetLesson() {
            let total = ALPHABET_LETTERS.length;
            score = total;
            missed = 0;
            
            questionTextEl.textContent = `üéâ Ho√†n th√†nh Luy·ªán ƒë·ªçc!`;
            imageHintEl.textContent = `Tuy·ªát v·ªùi, con ƒë√£ ƒë·ªçc h·∫øt c√°c ch·ªØ c√°i!`;
            readingControlsEl.classList.add('hidden');
            selectionControlsEl.classList.add('hidden');
            
            isLessonSetMode = false;
            
            setTimeout(() => {
                showScreen('student-name-input');
            }, 3000); 
        }
        // End Re-added Alphabet Functions

        async function checkLessonRange(showFeedback = true) {
             const grade = currentGrade;
             const subject = currentSubject;
             
             let maxLessonFromDB = 0;
             
             await fetchLessonsFromSupabase(); 
             
             if (lessonsAvailable[grade] && lessonsAvailable[grade][subject] && lessonsAvailable[grade][subject].length > 0) {
                 maxLessonFromDB = Math.max(...lessonsAvailable[grade][subject].map(l => l.lessonNumber));
             }

             startLessonEl.innerHTML = '';
             endLessonEl.innerHTML = '';
             let maxNumber = maxLessonFromDB > 0 ? maxLessonFromDB : 1;
             
             // T·∫°o options cho dropdown
             for (let i = 1; i <= maxNumber; i++) {
                 const startOption = document.createElement('option');
                 startOption.value = i;
                 startOption.textContent = `B√†i ${i}`;
                 startLessonEl.appendChild(startOption);

                 const endOption = document.createElement('option');
                 endOption.value = i;
                 endOption.textContent = `B√†i ${i}`;
                 endLessonEl.appendChild(endOption);
             }
             
             if (maxLessonFromDB > 0) {
                 startLessonEl.disabled = false;
                 endLessonEl.disabled = false;
                 startLessonEl.value = 1; // M·∫∑c ƒë·ªãnh t·ª´ b√†i 1
                 endLessonEl.value = maxNumber; // M·∫∑c ƒë·ªãnh ƒë·∫øn b√†i cu·ªëi
                 
                 if (showFeedback) {
                     lessonErrorEl.className = "text-xs text-green-600 mt-2";
                     lessonErrorEl.textContent = `‚úÖ ƒê√£ t√¨m th·∫•y c√°c b√†i h·ªçc t·ª´ 1 ƒë·∫øn ${maxLessonFromDB}.`;
                 }
             } else {
                 startLessonEl.disabled = true;
                 endLessonEl.disabled = true;
                 lessonErrorEl.className = "text-xs text-red-500 mt-2";
                 lessonErrorEl.textContent = "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y b√†i h·ªçc n√†o. Vui l√≤ng t·∫°o b√†i m·ªõi trong ch·∫ø ƒë·ªô Admin.";
                 startLessonEl.innerHTML = '<option value="1">B√†i 1</option>';
                 endLessonEl.innerHTML = '<option value="1">B√†i 1</option>';
             }
        }

        async function startLessonSet() {
            lessonStart = parseInt(startLessonEl.value);
            lessonEnd = parseInt(endLessonEl.value);

            if (isNaN(lessonStart) || isNaN(lessonEnd) || lessonStart < 1 || lessonEnd < 1 || lessonStart > lessonEnd) {
                lessonErrorEl.textContent = "‚ö†Ô∏è Vui l√≤ng ch·ªçn ƒë√∫ng ph·∫°m vi B√†i B·∫Øt ƒê·∫ßu v√† B√†i K·∫øt Th√∫c.";
                return;
            }
            
            isLessonSetMode = true;
            questionCount = 0;
            score = 0;
            missed = 0;
            incorrectQuestions = []; 
            
            // N·∫øu l√† Ti·∫øng Anh, kh√¥ng d√πng ch·∫ø ƒë·ªô t√≠nh ƒëi·ªÉm/c√¢u h·ªèi
            if (currentSubject === 'ENGLISH') {
                await loadAndShuffleQuestions(true); // Load all questions for vocab list
                startVocabularyLesson();
                return;
            }

            // Ch·∫ø ƒë·ªô t√≠nh ƒëi·ªÉm (To√°n, Ti·∫øng Vi·ªát)
            updateScoreDisplay();
            lessonProgressEl.classList.remove('hidden');
            statsDisplayEl.classList.remove('hidden');
            quitGameBtn.onclick = endLessonSet;

            showScreen('game-area');
            
            await loadAndShuffleQuestions(false);
            currentQuestionIndex = 0;
            generateQuestion();
        }

        // NEW: Vocab Mode Start
        function startVocabularyLesson() {
            aiExplanationOutputEl.classList.add('hidden');
            aiExplanationOutputEl.innerHTML = '';
            
            questionTextEl.className = 'text-2xl sm:text-3xl font-black text-gray-800 mb-2'; 
            questionTextEl.textContent = 'Ch·ªçn t·ª´ v·ª±ng ƒë·ªÉ luy·ªán ƒë·ªçc v√† h·ªèi AI:'; 
            imageHintEl.textContent = `B√†i ${lessonStart} - ${lessonEnd} (${lessonSetQuestions.length} t·ª´)`;

            readingControlsEl.classList.remove('hidden');
            readButtonEl.textContent = 'üîä ƒê·ªçc L·∫°i (English)';
            explainBtn.classList.remove('hidden'); 
            explainBtn.disabled = true; // Disable until a word is selected
            
            statsDisplayEl.classList.add('hidden');
            lessonProgressEl.classList.add('hidden');
            selectionControlsEl.classList.remove('hidden'); 
            
            // T·∫Øt n√∫t ƒë·ªçc l·∫°i m·∫∑c ƒë·ªãnh (s·∫Ω ƒë∆∞·ª£c g√°n l·∫°i trong handleVocabularyClick)
            readButtonEl.onclick = playAudio; 
            currentTextToRead = '';
            
            setupVocabularyButtons();

            quitGameBtn.onclick = endLessonSet;
            showScreen('game-area');
        }

        // NEW: Setup Vocab Buttons
        function setupVocabularyButtons() {
            selectionControlsEl.innerHTML = '';
            selectionControlsEl.className = 'grid grid-cols-2 sm:grid-cols-3 gap-4 mb-6';

            lessonSetQuestions.forEach(q => {
                const word = q.q; // L·∫•y t·ª´ v·ª±ng t·ª´ tr∆∞·ªùng q
                const button = document.createElement('button');
                button.textContent = word;
                button.className = 'vocab-btn p-3 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl w-full';
                button.onclick = () => handleVocabularyClick(word); 
                selectionControlsEl.appendChild(button);
            });
        }

        // NEW: Handle Vocab Click
        function handleVocabularyClick(word) {
            currentVocabWord = word;
            
            // 1. ƒê·ªçc to t·ª´ v·ª±ng
            currentTextToRead = word;
            speakText(word, 'en-US');

            // 2. C·∫≠p nh·∫≠t UI
            questionTextEl.textContent = `B·∫°n ƒë√£ ch·ªçn: ${word}`;
            imageHintEl.textContent = 'B·∫•m "H·ªèi AI Gi·∫£i Th√≠ch" ƒë·ªÉ xem nghƒ©a v√† c√°ch d√πng.';
            
            aiExplanationOutputEl.classList.add('hidden');
            explainBtn.disabled = false;
        }

        async function loadAndShuffleQuestions(isVocabMode) {
            let allQuestions = [];
            
            await fetchLessonsFromSupabase(); 

            const lessons = lessonsAvailable[currentGrade]?.[currentSubject] || [];
            
            for (let i = 0; i < lessons.length; i++) {
                const lesson = lessons[i];
                if (lesson.lessonNumber >= lessonStart && lesson.lessonNumber <= lessonEnd) {
                    if (lesson.questions_data) {
                        lesson.questions_data.forEach(q => {
                            allQuestions.push({...q, lessonNumber: lesson.lessonNumber, lessonName: lesson.lessonName}); 
                        });
                    }
                }
            }
            
            if (allQuestions.length === 0) {
                // ... (logic b√°o l·ªói)
                return;
            }

            // N·∫øu l√† ch·∫ø ƒë·ªô Tr·∫Øc nghi·ªám, tr·ªôn v√† gi·ªõi h·∫°n 30 c√¢u
            if (!isVocabMode) {
                allQuestions.sort(() => Math.random() - 0.5);
                lessonSetQuestions = allQuestions.slice(0, TOTAL_QUESTIONS);
            } else {
                // N·∫øu l√† ch·∫ø ƒë·ªô T·ª´ v·ª±ng, gi·ªØ t·∫•t c·∫£ c√°c t·ª´ trong ph·∫°m vi
                lessonSetQuestions = allQuestions; 
            }
        }

        async function endLessonSet() { 
            // N·∫øu l√† Vocab Mode, ch·ªâ c·∫ßn quay l·∫°i m√†n h√¨nh setup
            if (currentSubject === 'ENGLISH' && isLessonSetMode) {
                isLessonSetMode = false;
                showScreen('setup-area');
                return;
            }
            
            if (currentSubject === 'ALPHABET') {
                endAlphabetLesson();
                return;
            }

            // Logic l∆∞u ƒëi·ªÉm cho To√°n/Ti·∫øng Vi·ªát
            let total = score + missed;
            let accuracy = total > 0 ? (score / total * 100).toFixed(1) : 0;
            
            questionTextEl.textContent = `üéâ HO√ÄN TH√ÄNH (${total} c√¢u)`;
            imageHintEl.textContent = `‚úÖ ƒê√∫ng: ${score}, ‚ùå Sai: ${missed} (${accuracy}%)`;
            readingControlsEl.classList.add('hidden');
            selectionControlsEl.classList.add('hidden');
            
            if (total > 0 && studentName) {
                const historyRecord = {
                    student_name: studentName,
                    grade: currentGrade,
                    subject: currentSubject,
                    score: score,
                    missed: missed,
                    total: total,
                    incorrect_questions: incorrectQuestions,
                    lesson_range: `${lessonStart} - ${lessonEnd}`
                };
                await saveHistoryRecord(historyRecord);
            }
            
            incorrectQuestions = [];
            isLessonSetMode = false;
            
            setTimeout(() => {
                showScreen('setup-area');
            }, 3000); 
        }
        


        // --- LOGIC CH∆†I GAME & H·ªñ TR·ª¢ NG√îN NG·ªÆ (To√°n & Ti·∫øng Vi·ªát) ---

        function updateScoreDisplay() {
            scoreEl.textContent = score;
            missedEl.textContent = missed;
            if (isLessonSetMode && currentSubject !== 'ALPHABET' && currentSubject !== 'ENGLISH') { 
                const totalDisplay = lessonSetQuestions.length;
                questionCount = currentQuestionIndex + 1;
                lessonProgressEl.textContent = `C√¢u: ${questionCount} / ${totalDisplay}`;
            } else {
                 lessonProgressEl.textContent = `C√¢u: - / ${TOTAL_QUESTIONS}`;
            }
        }

        function generateQuestion() {
            // Ch·ªâ ch·∫°y cho ch·∫ø ƒë·ªô Tr·∫Øc nghi·ªám (To√°n, Ti·∫øng Vi·ªát)
            if (currentSubject === 'ENGLISH' || currentSubject === 'ALPHABET') return;
            
            if (isLessonSetMode && currentQuestionIndex >= lessonSetQuestions.length) {
                endLessonSet();
                return;
            }

            const qData = lessonSetQuestions[currentQuestionIndex];
            currentMode = qData.type;
            
            // K√≠ch ho·∫°t l·∫°i n√∫t ƒë·ªçc v√† ·∫©n n√∫t AI
            if (readButtonEl) readButtonEl.disabled = false; 
            explainBtn.classList.add('hidden');
            aiExplanationOutputEl.classList.add('hidden'); 
            
            questionTextEl.className = 'text-2xl sm:text-3xl font-black text-gray-800 mb-2';
            imageHintEl.className = 'text-base font-medium text-gray-600 my-2';

            readingControlsEl.classList.remove('hidden'); 
            selectionControlsEl.classList.remove('hidden'); 
            
            let autoReadLang = 'vi-VN'; 
            readButtonEl.textContent = 'üîä ƒê·ªçc L·∫°i';
            
            // --- X·ª¨ L√ù LOGIC PH√âP T√çNH ---
            if (qData.type === 'MATH_OP') {
                const cleanQ = qData.q.replace(/[=\?]$/, '').trim();
                const match = cleanQ.match(/(\d+)\s*([+\-x:])\s*(\d+)/); 
                
                if (match) {
                    currentTextToRead = formatMathQuestionForSpeech(parseInt(match[1]), parseInt(match[3]), match[2]);
                } else {
                    currentTextToRead = qData.q;
                }
                questionTextEl.textContent = qData.q;
                imageHintEl.textContent = `(B√†i ${qData.lessonNumber}: Ph√©p t√≠nh)`;
            } 
            // --- X·ª¨ L√ù LOGIC ƒê·ªåC V√Ä CH√çNH T·∫¢ ---
            else if (currentMode === 'READ') {
                questionTextEl.textContent = `üëÇ Nghe k·ªπ v√† CH·ªåN c√¢u/t·ª´ b·∫°n v·ª´a nghe:`; 
                currentTextToRead = qData.text || qData.q;
                imageHintEl.textContent = `(B√†i ${qData.lessonNumber}: Luy·ªán Nghe)`;
            }
            else { // M·∫∑c ƒë·ªãnh cho MATH_WORD, SPELL
                questionTextEl.textContent = qData.q;
                currentTextToRead = qData.text || qData.q;
                imageHintEl.textContent = `(B√†i ${qData.lessonNumber}: ${qData.type})`;
            }
            
            currentAnswer = qData.a; 
            setupSelectionButtons(qData.options);
            
            // T·ª± ƒë·ªông ƒë·ªçc trong ng√¥n ng·ªØ ph√π h·ª£p
            setTimeout(() => speakText(currentTextToRead, autoReadLang), 500); 
        }

        // --- GEMINI API: GET VOCABULARY EXPLANATION ---

        async function getVocabularyExplanation() {
            const word = currentVocabWord;
            
            if (!word || explainBtn.disabled || geminiKeys.length === 0) return;
            
            // UI Loading
            explainBtn.disabled = true;
            explainTextEl.textContent = "AI ƒëang gi·∫£i th√≠ch...";
            explainLoadingEl.classList.remove('hidden');
            aiExplanationOutputEl.classList.add('hidden');
            aiExplanationOutputEl.innerHTML = '';

            imageHintEl.textContent = "ƒêang k·∫øt n·ªëi AI (vui l√≤ng ch·ªù 5-10s cho l·∫ßn ƒë·∫ßu)...";
            
            const systemPrompt = `B·∫°n l√† m·ªôt tr·ª£ gi·∫£ng Ti·∫øng Anh cho h·ªçc sinh c·∫•p 1. Nhi·ªám v·ª• c·ªßa b·∫°n l√† gi·∫£i th√≠ch t·ª´ v·ª±ng ti·∫øng Anh. H√£y lu√¥n tr·∫£ l·ªùi b·∫±ng c·∫•u tr√∫c JSON sau.
            QUY T·∫ÆC:
            1. Gi·∫£i th√≠ch Ti·∫øng Anh ph·∫£i ƒë∆°n gi·∫£n, ng·∫Øn g·ªçn (d∆∞·ªõi 15 t·ª´).
            2. Ph·∫ßn 'usage' ph·∫£i l√† m·ªôt c√¢u v√≠ d·ª• ti·∫øng Anh c√≥ s·ª≠ d·ª•ng t·ª´ v·ª±ng ƒë√≥.`;
            
            const userQuery = `Gi·∫£i th√≠ch t·ª´ v·ª±ng: ${word}`;
            
            const jsonSchema = {
                type: "OBJECT",
                properties: {
                    "english_explanation": { "type": "STRING", "description": "Gi·∫£i th√≠ch ng·∫Øn g·ªçn b·∫±ng Ti·∫øng Anh (d∆∞·ªõi 15 t·ª´)." },
                    "vietnamese_translation": { "type": "STRING", "description": "B·∫£n d·ªãch Ti·∫øng Vi·ªát c·ªßa t·ª´ v√† gi·∫£i th√≠ch." },
                    "usage_example": { "type": "STRING", "description": "M·ªôt c√¢u v√≠ d·ª• b·∫±ng Ti·∫øng Anh." },
                    "usage_vietnamese": { "type": "STRING", "description": "B·∫£n d·ªãch Ti·∫øng Vi·ªát c·ªßa c√¢u v√≠ d·ª•." }
                },
                required: ["english_explanation", "vietnamese_translation", "usage_example", "usage_vietnamese"]
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema,
                }
            };

            let successful = false;
            let finalOutput = { error: true, message: "Kh√¥ng th·ªÉ k·∫øt n·ªëi AI. Vui l√≤ng ki·ªÉm tra API Key." };
            
            const MODEL_NAME = 'gemini-2.5-flash-preview-05-20'; 

            for (let i = 0; i < geminiKeys.length; i++) {
                currentKeyIndex = (i + currentKeyIndex) % geminiKeys.length;
                const apiKey = geminiKeys[currentKeyIndex];
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
                
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (jsonString) {
                            finalOutput = JSON.parse(jsonString);
                            successful = true;
                            break; 
                        }
                    }
                } catch (error) {
                    console.error("AI Explanation API Error:", error);
                    // Continue to next key
                }
            }
            
            // UI Update after translation attempt
            if (successful) {
                // Render Output
                aiExplanationOutputEl.innerHTML = `
                    <p class="font-bold text-lg text-blue-700 mb-2">T·ª´ V·ª±ng: ${word.toUpperCase()}</p>
                    <p class="text-green-600 font-semibold mb-1">D·ªãch Vi·ªát: ${finalOutput.vietnamese_translation}</p>
                    <hr class="my-2 border-gray-300">
                    <p class="text-gray-800 font-medium">English Explanation: ${finalOutput.english_explanation}</p>
                    <p class="text-gray-800 font-medium mt-3">V√≠ d·ª•: <em class="font-bold text-purple-600">${finalOutput.usage_example}</em></p>
                    <p class="text-gray-600 text-sm italic">(${finalOutput.usage_vietnamese})</p>
                `;
                aiExplanationOutputEl.classList.remove('hidden');
                imageHintEl.textContent = 'ƒê√£ c√≥ gi·∫£i th√≠ch t·ª´ AI.';
                
                // Speak Vietnamese translation
                speakText(`Ti·∫øng Vi·ªát: ${finalOutput.vietnamese_translation}`, 'vi-VN'); 

                explainTextEl.textContent = "‚úÖ ƒê√£ gi·∫£i th√≠ch & ƒë·ªçc Vi·ªát";

            } else {
                aiExplanationOutputEl.innerHTML = `<p class="text-red-500 font-semibold">‚ö†Ô∏è L·ªñI: ${finalOutput.message}</p>`;
                aiExplanationOutputEl.classList.remove('hidden');
                imageHintEl.textContent = 'ƒê√£ x·∫£y ra l·ªói khi g·ªçi AI. Vui l√≤ng ki·ªÉm tra API Key.';
                explainTextEl.textContent = "‚ö†Ô∏è L·ªói AI";
            }
            
            // Revert UI elements
            setTimeout(() => {
                explainTextEl.textContent = "ü§ñ H·ªèi AI Gi·∫£i Th√≠ch";
                explainLoadingEl.classList.add('hidden');
                explainBtn.disabled = false;
            }, 3000); // Th√™m th·ªùi gian delay cho vi·ªác ƒë·ªçc Ti·∫øng Vi·ªát n·∫øu c·∫ßn thi·∫øt.
        }

        // --- END GEMINI API: GET VOCABULARY EXPLANATION ---

        function numberToVietnamese(n) {
            if (n < 0 || n > 100) return String(n);
            const units = ["", "m·ªôt", "hai", "ba", "b·ªën", "nƒÉm", "s√°u", "b·∫£y", "t√°m", "ch√≠n"];
            const tens = ["", "m∆∞·ªùi", "hai m∆∞∆°i", "ba m∆∞∆°i", "b·ªën m∆∞∆°i", "nƒÉm m∆∞∆°i", "s√°u m∆∞∆°i", "b·∫£y m∆∞∆°i", "t√°m m∆∞∆°i", "ch√≠n m∆∞∆°i"];
            if (n === 0) return "kh√¥ng";
            if (n <= 9) return units[n];
            if (n === 10) return "m∆∞·ªùi";
            if (n === 100) return "m·ªôt trƒÉm";
            
            const t = Math.floor(n / 10);
            const u = n % 10;
            let result = tens[t];

            if (t === 1 && u > 0) {
                if (u === 1) result = "m∆∞·ªùi m·ªôt";
                else if (u === 4) result = "m∆∞·ªùi b·ªën"; 
                else if (u === 5) result = "m∆∞·ªùi lƒÉm"; 
                else result = `m∆∞·ªùi ${units[u]}`;
            } else if (t > 1 && u > 0) {
                if (u === 1) result = `${tens[t]} m·ªët`; 
                else if (u === 4) result = `${tens[t]} t∆∞`; 
                else if (u === 5) result = `${tens[t]} lƒÉm`; 
                else result = `${tens[t]} ${units[u]}`;
            } else if (u === 0 && t > 1) {
                result = tens[t];
            }
            return result.trim();
        }

        function formatMathQuestionForSpeech(a, b, operator) {
            const aText = numberToVietnamese(a);
            const bText = numberToVietnamese(b);
            let opText = '';
            
            switch (operator) {
                case '+': opText = 'c·ªông'; break;
                case '-': opText = 'tr·ª´'; break;
                case 'x': opText = 'nh√¢n'; break;
                case ':': opText = 'chia'; break;
                default: opText = operator;
            }
            // Gi·ªØ l·∫°i ƒë·ªãnh d·∫°ng n√†y cho currentTextToRead ƒë·ªÉ d·ªÖ debug n·∫øu c·∫ßn
            return `${aText} ${opText} ${bText} b·∫±ng bao nhi√™u`; 
        }

        // H√†m n√†y ch·ªâ d√πng cho ch·∫ø ƒë·ªô Tr·∫Øc nghi·ªám/Ph√©p t√≠nh
        function setupSelectionButtons(options) {
            selectionControlsEl.innerHTML = '';
            
            const shuffledOptions = [...options].sort(() => 0.5 - Math.random()); 
            
            if (currentSubject === 'TOAN' || currentGrade === 1) {
                 selectionControlsEl.className = 'grid grid-cols-2 gap-4 mb-6'; 
            } else {
                 selectionControlsEl.className = 'grid grid-cols-1 gap-4 mb-6';
            }

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'select-btn p-3 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl w-full';
                button.onclick = () => checkAnswer(option); 
                selectionControlsEl.appendChild(button);
            });
        }
        
        function checkAnswer(selectedOption) {
            if (currentSubject === 'ALPHABET' || currentSubject === 'ENGLISH') return;

            const currentQData = lessonSetQuestions[currentQuestionIndex];
            const correctEmojis = ["üéâ", "üåü", "ü•≥", "‚ú®", "üíØ", "üíñ", "üí°"];
            const randomEmoji = correctEmojis[Math.floor(Math.random() * correctEmojis.length)];

            let userAnswer = String(selectedOption).toLowerCase().trim().replace(/[\.,!?'"']/g, ''); 
            
            if (userAnswer === currentAnswer.toLowerCase().trim().replace(/[\.,!?'"']/g, '')) {
                score++;
                feedbackEl.textContent = `${randomEmoji} ƒê√∫ng r·ªìi! Gi·ªèi qu√°! ${randomEmoji}`;
                feedbackEl.className = 'h-8 mb-4 text-center font-bold text-2xl text-green-600 animate-pulse';
            } else {
                missed++;
                feedbackEl.textContent = `ü•∫ Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√†: ${currentAnswer}`;
                feedbackEl.className = 'h-8 mb-4 text-center font-bold text-lg text-red-600';
                
                incorrectQuestions.push({
                    q: currentQData.q,
                    a: currentQData.a,
                    user_answer: selectedOption,
                    type: currentQData.type,
                    lesson: currentQData.lessonNumber,
                    lessonName: currentQData.lessonName 
                });
            }

            updateScoreDisplay();
            currentQuestionIndex++;
            
            setTimeout(() => {
                feedbackEl.textContent = "";
                feedbackEl.className = 'h-8 mb-4 text-center font-bold text-lg';
                generateQuestion();
            }, 1200); 
        }
        
        // --- SUPABASE & ADMIN LOGIC ---
        

        // Gemini Key Management Functions
        async function loadGeminiKeys() {
            if (!supabase) return;

            try {
                const { data, error } = await supabase
                    .from('config')
                    .select('gemini_keys')
                    .eq('id', 1)
                    .maybeSingle();

                if (error && error.code !== 'PGRST116') throw error;

                geminiKeys = data?.gemini_keys || [];
                renderGeminiKeys();
                adminStatusEl.textContent = `‚úÖ ƒê√£ t·∫£i ${geminiKeys.length} API key Gemini.`;

            } catch (e) {
                console.error("L·ªói t·∫£i API keys:", e);
                adminStatusEl.textContent = `L·ªñI SUPABASE: Kh√¥ng t·∫£i ƒë∆∞·ª£c API keys (${e.message}).`;
            }
        }

        async function saveGeminiKeys(keys) {
            if (!supabase) return;

            try {
                const { error } = await supabase
                    .from('config')
                    .upsert({ id: 1, gemini_keys: keys }, { onConflict: 'id' });

                if (error) throw error;
                
                geminiKeys = keys;
                renderGeminiKeys();
                adminStatusEl.textContent = `‚úÖ ƒê√£ l∆∞u ${keys.length} API key Gemini m·ªõi.`;

            } catch (e) {
                console.error("L·ªói l∆∞u API keys:", e);
                adminStatusEl.textContent = `L·ªñI SUPABASE: Kh√¥ng l∆∞u ƒë∆∞·ª£c API keys (${e.message}).`;
            }
        }

        function renderGeminiKeys() {
            geminiKeysListEl.innerHTML = '';
            if (geminiKeys.length === 0) {
                geminiKeysListEl.innerHTML = '<p class="text-sm text-gray-500">Ch∆∞a c√≥ API key n√†o ƒë∆∞·ª£c l∆∞u. AI s·∫Ω kh√¥ng ho·∫°t ƒë·ªông.</p>';
                aiGenerateBtn.disabled = true;
                return;
            }

            aiGenerateBtn.disabled = false;
            geminiKeys.forEach((key, index) => {
                const keyDisplay = key.substring(0, 4) + '... (Length: ' + key.length + ')';
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 bg-white rounded-lg border border-gray-200';
                item.innerHTML = `
                    <span class="font-mono text-xs text-gray-700">${index + 1}. ${keyDisplay}</span>
                    <button onclick="deleteGeminiKey(${index})" class="danger-btn px-2 py-1 text-xs text-white rounded-md hover:bg-red-700">X√≥a</button>
                `;
                geminiKeysListEl.appendChild(item);
            });
        }

        function addGeminiKey() {
            const newKey = geminiKeyInputEl.value.trim();
            if (newKey.length < 20) {
                adminStatusEl.textContent = "‚ö†Ô∏è API Key qu√° ng·∫Øn. Vui l√≤ng ki·ªÉm tra l·∫°i.";
                return;
            }
            if (geminiKeys.includes(newKey)) {
                adminStatusEl.textContent = "‚ö†Ô∏è Key n√†y ƒë√£ ƒë∆∞·ª£c th√™m.";
                return;
            }
            const updatedKeys = [...geminiKeys, newKey];
            geminiKeyInputEl.value = '';
            saveGeminiKeys(updatedKeys);
        }

        function deleteGeminiKey(index) {
            if (index >= 0 && index < geminiKeys.length) {
                adminStatusEl.textContent = `‚ö†Ô∏è ƒê√£ x√≥a API Key s·ªë ${index + 1}.`;
                const updatedKeys = geminiKeys.filter((_, i) => i !== index);
                saveGeminiKeys(updatedKeys);
            }
        }
        
        async function fetchLessonsFromSupabase() {
             if (!supabase) return;

             const { data, error } = await supabase
                 .from('lessons')
                 .select('id, grade, subject, lesson_number, lesson_name, num_questions, questions_data');
             
             if (error) {
                 console.error('L·ªói t·∫£i b√†i h·ªçc t·ª´ Supabase:', error);
                 adminStatusEl.textContent = `L·ªñI SUPABASE: Kh√¥ng t·∫£i ƒë∆∞·ª£c b√†i h·ªçc (${error.message})`; 
                 return;
             }
             
             // UPDATED: Th√™m ENGLISH v√†o c·∫•u tr√∫c lessonsAvailable
             lessonsAvailable = { 0: { ALPHABET: [] }, 1: { TOAN: [], SPELL: [], READ: [], ENGLISH: [] }, 2: { TOAN: [], SPELL: [], READ: [], ENGLISH: [] } };

             data.forEach(lesson => {
                 const grade = lesson.grade;
                 const subject = lesson.subject;

                 if (lessonsAvailable[grade] && lessonsAvailable[grade][subject]) {
                     lessonsAvailable[grade][subject].push({
                         id: lesson.id,
                         grade: lesson.grade,
                         subject: lesson.subject,
                         lessonNumber: lesson.lesson_number,
                         lessonName: lesson.lesson_name,
                         numQuestions: lesson.num_questions,
                         questions_data: lesson.questions_data,
                     });
                 }
             });
             
             // UPDATED: Th√™m ENGLISH v√†o v√≤ng l·∫∑p s·∫Øp x·∫øp
             for (let g of [1, 2]) {
                 for (let s of ['TOAN', 'SPELL', 'READ', 'ENGLISH']) {
                     if (lessonsAvailable[g] && lessonsAvailable[g][s]) {
                         lessonsAvailable[g][s].sort((a, b) => a.lessonNumber - b.lessonNumber);
                     }
                 }
             }
        }
        
        async function saveHistoryRecord(record) {
             if (!supabase) return;

             const { data, error } = await supabase
                 .from('history')
                 .insert([record]); 
             
             if (error) {
                 console.error('L·ªói l∆∞u l·ªãch s·ª≠ l√™n Supabase:', error);
             }
        }
        
        async function fetchHistoryFromSupabase() {
            if (!supabase) return;
            
            const { data, error } = await supabase
                .from('history')
                .select('*')
                .order('timestamp', { ascending: false });

            if (error) {
                console.error('L·ªói t·∫£i l·ªãch s·ª≠ t·ª´ Supabase:', error);
                return;
            }

            learningHistory = data.map(record => ({
                studentName: record.student_name,
                grade: record.grade,
                subject: record.subject,
                timestamp: record.timestamp,
                score: record.score,
                missed: record.missed,
                total: record.total,
                incorrectQuestions: record.incorrect_questions,
                lessonRange: record.lesson_range
            }));
        }

        async function loadHistoryNames() {
            loadHistorySetup();
        }

        async function loadHistorySetup() {
            await fetchHistoryFromSupabase();

            const names = [...new Set(learningHistory.map(r => r.studentName))].sort();

            historyFilterNameEl.innerHTML = '<option value="ALL">T·∫•t c·∫£ h·ªçc sinh</option>';
            names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                historyFilterNameEl.appendChild(option);
            });
            
            if (!historyContentEl.classList.contains('hidden')) {
                displayHistory();
            }
        }

        function toggleHistoryContent() {
            const isHidden = historyContentEl.classList.contains('hidden');
            if (isHidden) {
                historyContentEl.classList.remove('hidden');
                historyToggleButton.innerHTML = '‚ñº ·∫®n L·ªãch S·ª≠';
                historyToggleButton.classList.remove('bg-green-600');
                historyToggleButton.classList.add('bg-green-700');
                loadHistorySetup();
            } else {
                historyContentEl.classList.add('hidden');
                historyToggleButton.innerHTML = '‚ñ∂Ô∏è Hi·ªÉn th·ªã L·ªãch S·ª≠';
                historyToggleButton.classList.remove('bg-green-700');
                historyToggleButton.classList.add('bg-green-600');
            }
        }
        
        function displayHistory() {
            const filterName = historyFilterNameEl.value;
            const filterSubject = historyFilterSubjectEl.value;
            historyListEl.innerHTML = '';

            const filteredHistory = learningHistory.filter(record => {
                const nameMatch = filterName === 'ALL' || record.studentName === filterName;
                const subjectMatch = filterSubject === 'ALL' || record.subject === filterSubject;
                return nameMatch && subjectMatch;
            });

            if (filteredHistory.length === 0) {
                historyListEl.innerHTML = '<p class="text-sm text-gray-600 text-center p-4 border rounded-lg bg-white">Ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i n√†o ƒë∆∞·ª£c ghi l·∫°i.</p>';
                return;
            }

            filteredHistory.forEach((record, index) => {
                const date = new Date(record.timestamp).toLocaleDateString('vi-VN', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                let subjectName = record.subject;
                if (record.subject === 'TOAN') subjectName = 'To√°n';
                else if (record.subject === 'SPELL') subjectName = 'Ch√≠nh T·∫£';
                else if (record.subject === 'READ') subjectName = 'Luy·ªán ƒê·ªçc';
                else if (record.subject === 'ENGLISH') subjectName = 'Ti·∫øng Anh'; 
                else if (record.subject === 'ALPHABET') subjectName = 'M·∫´u Gi√°o';

                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-md border-t-4 border-indigo-500 space-y-2';
                
                const incorrectCount = record.incorrectQuestions ? record.incorrectQuestions.length : 0;
                const detailId = `details-${index}`;

                card.innerHTML = `
                    <p class="text-sm font-bold text-indigo-700">üë§ ${record.studentName} | L·ªõp ${record.grade === 0 ? 'M·∫´u Gi√°o' : record.grade} - ${subjectName}</p>
                    <p class="text-xs text-gray-500">üïí ${date} | Ph·∫°m vi B√†i: ${record.lessonRange}</p>
                    <div class="flex justify-between items-center text-lg font-extrabold pt-2">
                        <span class="text-green-600">‚úÖ ${record.score}</span>
                        <span class="text-red-600">‚ùå ${record.missed}</span>
                        <span class="text-gray-700">T·ªïng: ${record.total}</span>
                    </div>
                    ${incorrectCount > 0 ? `<button class="details-btn w-full mt-2 p-2 bg-yellow-400 text-yellow-900 text-sm font-bold rounded-lg hover:bg-yellow-500" data-target="#${detailId}">
                        Chi ti·∫øt ${incorrectCount} c√¢u sai
                    </button>` : `<p class="text-sm text-green-500 font-semibold mt-2 text-center">Ho√†n h·∫£o! ${record.subject === 'ALPHABET' ? 'ƒê√£ ho√†n th√†nh.' : 'Kh√¥ng c√≥ c√¢u sai.'}</p>`}
                    
                    <div id="${detailId}" class="hidden space-y-3 pt-3 border-t mt-3 text-sm">
                        <p class="font-bold text-red-700">C√ÅC C√ÇU L√ÄM SAI:</p>
                        ${record.incorrectQuestions ? record.incorrectQuestions.map((q, qIndex) => `
                            <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                                <p class="font-semibold text-gray-800">C√¢u ${qIndex + 1} (B√†i ${q.lesson}): ${q.q}</p>
                                <p class="text-red-600">B√© ch·ªçn: <strong>${q.user_answer}</strong></p>
                                <p class="text-green-600">ƒê√°p √°n: <strong>${q.a}</strong></p>
                            </div>
                        `).join('') : ''}
                    </div>
                `;
                card.appendChild(document.createElement('div')).style.clear = 'both'; // Clearfix for layout
                historyListEl.appendChild(card);
            });
            
            document.querySelectorAll('.details-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetId = e.target.getAttribute('data-target');
                    const targetEl = document.querySelector(targetId);
                    if (targetEl.classList.contains('hidden')) {
                        targetEl.classList.remove('hidden');
                        e.target.textContent = '·∫®n chi ti·∫øt c√¢u sai';
                    } else {
                        targetEl.classList.add('hidden');
                        const incorrectCountInDetails = targetEl.querySelectorAll('.bg-red-50').length;
                        e.target.textContent = `Chi ti·∫øt ${incorrectCountInDetails} c√¢u sai`;
                    }
                });
            });
        }

        async function loadLessonOptions(shouldFetch = true) {
             if (shouldFetch) await fetchLessonsFromSupabase(); 
             
             const grade = parseInt(adminGradeEl.value);
             const subject = adminSubjectEl.value;
             
             const options = lessonsAvailable[grade] && lessonsAvailable[grade][subject] ? lessonsAvailable[grade][subject] : [];
             
             adminLessonEl.innerHTML = '';
             if (options && options.length > 0) {
                 options.forEach(l => {
                     const option = document.createElement('option');
                     option.value = l.lessonNumber;
                     option.textContent = `B√†i ${l.lessonNumber} - ${l.lessonName} (${l.numQuestions} c√¢u)`; 
                     adminLessonEl.appendChild(option);
                 });
                 adminLessonEl.value = options[0].lessonNumber;
                 lessonNameControlEl.classList.remove('hidden'); 
                 detailQuestionBtn.disabled = false;
             } else {
                 const option = document.createElement('option');
                 option.value = 0;
                 option.textContent = "Ch∆∞a c√≥ b√†i h·ªçc n√†o";
                 adminLessonEl.appendChild(option);
                 lessonNameControlEl.classList.add('hidden'); 
                 detailQuestionBtn.disabled = true;
             }
             
             previewLesson();
        }

        async function previewLesson() {
             const grade = parseInt(adminGradeEl.value);
             const subject = adminSubjectEl.value;
             const lessonNumber = parseInt(adminLessonEl.value);
             
             if (lessonNumber > 0) {
                 const currentLesson = lessonsAvailable[grade][subject].find(l => l.lessonNumber === lessonNumber);
                 if (currentLesson) {
                     aiTargetInfoEl.textContent = `M·ª•c ti√™u AI: L·ªõp ${grade} - M√¥n ${subject} - B√†i ${lessonNumber} ("${currentLesson.lessonName}")`;
                 }
             } else {
                 aiTargetInfoEl.textContent = 'Vui l√≤ng ch·ªçn B√†i H·ªçc ·ªü m·ª•c 3 tr∆∞·ªõc khi t·∫°o c√¢u h·ªèi.';
             }


             if (lessonNumber === 0) {
                 lessonPreviewEl.textContent = "T·ªïng s·ªë c√¢u trong b√†i n√†y: 0";
                 return;
             }
             
             const lesson = lessonsAvailable[grade][subject].find(l => l.lessonNumber === lessonNumber);
             
             if (lesson) {
                 lessonPreviewEl.textContent = `T·ªïng s·ªë c√¢u trong B√†i ${lessonNumber}: ${lesson.numQuestions}`;
                 adminLessonNameEl.value = lesson.lessonName; 
                 lessonNameControlEl.classList.remove('hidden'); 
             }
             
             aiResultPreviewEl.textContent = '';
        }
        
        async function createNewLessonStructure() {
            if (!supabase) return;
            const grade = parseInt(newLessonGradeEl.value);
            const subject = newLessonSubjectEl.value;
            const newLessonNumber = parseInt(newLessonNumberEl.value.trim());
            const name = newLessonNameInputEl.value.trim();
            
            adminStatusEl.textContent = '';

            if (isNaN(newLessonNumber) || newLessonNumber <= 0) {
                adminStatusEl.textContent = "‚ö†Ô∏è S·ªë b√†i h·ªçc ph·∫£i l√† m·ªôt s·ªë nguy√™n d∆∞∆°ng.";
                return;
            }
            if (!name) {
                adminStatusEl.textContent = "‚ö†Ô∏è T√™n b√†i h·ªçc kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.";
                return;
            }

            await fetchLessonsFromSupabase();
            const existingLessons = lessonsAvailable[grade][subject] || [];
            const alreadyExists = existingLessons.some(l => l.lessonNumber === newLessonNumber);
            if (alreadyExists) {
                adminStatusEl.textContent = `‚ö†Ô∏è B√†i ${newLessonNumber} ƒë√£ t·ªìn t·∫°i trong m√¥n n√†y. Vui l√≤ng ch·ªçn s·ªë b√†i kh√°c.`;
                return;
            }

            try {
                const lessonData = {
                    grade: grade,
                    subject: subject,
                    lesson_number: newLessonNumber,
                    lesson_name: name,
                    questions_data: [],
                    num_questions: 0,
                };

                const { data, error } = await supabase
                    .from('lessons')
                    .insert([lessonData])
                    .select();

                if (error) throw error;
                
                adminStatusEl.textContent = `‚úÖ ƒê√£ t·∫°o B√†i ${newLessonNumber} ("${name}") th√†nh c√¥ng tr√™n Supabase!`;
                
                const currentLessonValue = String(newLessonNumber);
                
                await fetchLessonsFromSupabase(); 
                
                adminGradeEl.value = String(grade);
                adminSubjectEl.value = subject;
                await loadLessonOptions(false); 
                
                adminLessonEl.value = currentLessonValue;
                previewLesson(); 

                newLessonNumberEl.value = '';
                newLessonNameInputEl.value = '';
                
            } catch (e) {
                adminStatusEl.textContent = `L·ªói t·∫°o b√†i Supabase: ${e.message}`;
            }
        }

        async function updateLessonName() {
            if (!supabase) return;
            const grade = parseInt(adminGradeEl.value);
            const subject = adminSubjectEl.value;
            const lessonNumber = parseInt(adminLessonEl.value);
            const newName = adminLessonNameEl.value.trim();
            
            if (lessonNumber === 0 || !newName) {
                adminStatusEl.textContent = "‚ö†Ô∏è Vui l√≤ng ch·ªçn b√†i h·ªçc v√† nh·∫≠p t√™n.";
                return;
            }
            
            const currentLessonValue = String(lessonNumber);
            const lesson = lessonsAvailable[grade][subject].find(l => l.lessonNumber === lessonNumber);
            
            if (!lesson) {
                adminStatusEl.textContent = "Kh√¥ng t√¨m th·∫•y b√†i h·ªçc.";
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('lessons')
                    .update({ lesson_name: newName })
                    .eq('id', lesson.id)
                    .select();

                if (error) throw error;

                adminStatusEl.textContent = `‚úÖ ƒê√£ l∆∞u t√™n m·ªõi: "${newName}"`;
                
                await fetchLessonsFromSupabase(); 
                await loadLessonOptions(false); 
                
                adminLessonEl.value = currentLessonValue; 
                previewLesson();
            } catch (e) {
                adminStatusEl.textContent = `L·ªói l∆∞u t√™n Supabase: ${e.message}`;
            }
        }
        
        function confirmDeleteLesson() {
            const lessonNumber = parseInt(adminLessonEl.value);
            if (lessonNumber === 0) {
                adminStatusEl.textContent = "Vui l√≤ng ch·ªçn b√†i h·ªçc h·ª£p l·ªá ƒë·ªÉ x√≥a.";
                return;
            }
            // Thay th·∫ø window.confirm b·∫±ng m·ªôt modal th√¥ng b√°o t√πy ch·ªânh
            // T·∫°m th·ªùi gi·ªØ l·∫°i window.confirm v√¨ gi·ªõi h·∫°n m√¥i tr∆∞·ªùng
            if (window.confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a TO√ÄN B·ªò B√†i ${lessonNumber} (${adminLessonNameEl.value}) kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) {
                deleteLesson();
            }
        }
        
        async function deleteLesson() {
            if (!supabase) return;
            const grade = parseInt(adminGradeEl.value);
            const subject = adminSubjectEl.value;
            const lessonNumber = parseInt(adminLessonEl.value);
            
            const lesson = lessonsAvailable[grade][subject].find(l => l.lessonNumber === lessonNumber);
            if (!lesson) {
                adminStatusEl.textContent = "Kh√¥ng t√¨m th·∫•y b√†i h·ªçc ƒë·ªÉ x√≥a.";
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('lessons')
                    .delete()
                    .eq('id', lesson.id);

                if (error) throw error;
                
                adminStatusEl.textContent = `‚úÖ ƒê√£ x√≥a B√†i ${lessonNumber} ("${lesson.lessonName}") th√†nh c√¥ng kh·ªèi Supabase!`;
                
                await fetchLessonsFromSupabase(); 
                await loadLessonOptions(false);
            } catch (e) {
                adminStatusEl.textContent = `L·ªói x√≥a b√†i Supabase: ${e.message}`;
            }
        }

        // --- CH·ª®C NƒÇNG QU·∫¢N L√ù C√ÇU H·ªéI CHI TI·∫æT ---
        function showQuestionDetailsModal() {
            const grade = parseInt(adminGradeEl.value);
            const subject = adminSubjectEl.value;
            const lessonNumber = parseInt(adminLessonEl.value);

            if (lessonNumber === 0) {
                adminStatusEl.textContent = "‚ö†Ô∏è Vui l√≤ng ch·ªçn B√†i H·ªçc h·ª£p l·ªá ƒë·ªÉ xem chi ti·∫øt c√¢u h·ªèi.";
                return;
            }

            const lesson = lessonsAvailable[grade][subject].find(l => l.lessonNumber === lessonNumber);

            if (!lesson || !lesson.questions_data || lesson.questions_data.length === 0) {
                modalLessonTitleEl.textContent = `B√†i ${lesson?.lessonNumber || lessonNumber} - ${lesson?.lessonName || 'Kh√¥ng c√≥ t√™n'}`;
                modalQuestionsListEl.innerHTML = '<p class="text-sm text-gray-500 text-center">B√†i h·ªçc n√†y ch∆∞a c√≥ c√¢u h·ªèi n√†o.</p>';
                questionDetailModalEl.classList.remove('hidden');
                return;
            }

            modalLessonTitleEl.textContent = `Chi Ti·∫øt C√¢u H·ªèi B√†i ${lesson.lessonNumber} - ${lesson.lessonName} (${lesson.numQuestions} c√¢u)`;
            
            let html = '';
            lesson.questions_data.forEach((q, index) => {
                // T√πy ch·ªânh hi·ªÉn th·ªã cho Ti·∫øng Anh Vocab (ch·ªâ c·∫ßn q)
                const qType = q.type || (subject === 'TOAN' ? 'MATH_OP' : subject);
                const isEnglishVocab = qType === 'ENGLISH' && !q.options; 

                html += `
                    <div class="p-3 border border-blue-200 rounded-lg bg-blue-50 space-y-1 text-sm">
                        <div class="flex justify-between items-start">
                            <p class="font-bold text-gray-800">
                                C√¢u ${index + 1} (${isEnglishVocab ? 'VOCAB' : qType}):
                            </p>
                            <button 
                                onclick="confirmDeleteQuestion(${lesson.id}, ${index}, 'C√¢u ${index + 1}')" 
                                class="danger-btn px-2 py-1 text-xs text-white rounded-md hover:bg-red-700 font-bold ml-4"
                            >
                                X√≥a
                            </button>
                        </div>
                        <p class="text-gray-700"><strong>H·ªèi:</strong> ${q.q}</p>
                        ${isEnglishVocab ? '' : 
                        `<p class="text-green-600"><strong>ƒê√°p √°n:</strong> ${q.a}</p>
                         <p class="text-gray-500 text-xs">L·ª±a ch·ªçn: ${q.options ? q.options.join(' | ') : 'Kh√¥ng c√≥'}</p>`
                        }
                    </div>
                `;
            });
            modalQuestionsListEl.innerHTML = html;
            questionDetailModalEl.classList.remove('hidden');
        }

        function closeQuestionDetailsModal() {
            questionDetailModalEl.classList.add('hidden');
        }

        function confirmDeleteQuestion(lessonId, questionIndex, questionLabel) {
             // Thay th·∫ø window.confirm b·∫±ng m·ªôt modal th√¥ng b√°o t√πy ch·ªânh
            // T·∫°m th·ªùi gi·ªØ l·∫°i window.confirm v√¨ gi·ªõi h·∫°n m√¥i tr∆∞·ªùng
             if (window.confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${questionLabel} n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) {
                 deleteQuestion(lessonId, questionIndex);
             }
        }

        async function deleteQuestion(lessonId, questionIndex) {
            if (!supabase) return;
            
            let lessonToUpdate = null;
            let currentSubjectLocal = null;
            let currentGradeLocal = null;
            let currentLessonNumberLocal = null;

            for (const grade in lessonsAvailable) {
                for (const subject in lessonsAvailable[grade]) {
                    const found = lessonsAvailable[grade][subject].find(l => l.id === lessonId);
                    if (found) {
                        lessonToUpdate = found;
                        currentSubjectLocal = subject;
                        currentGradeLocal = parseInt(grade);
                        currentLessonNumberLocal = found.lessonNumber;
                        break;
                    }
                }
                if (lessonToUpdate) break;
            }

            if (!lessonToUpdate) {
                adminStatusEl.textContent = "L·ªói: Kh√¥ng t√¨m th·∫•y ID b√†i h·ªçc.";
                closeQuestionDetailsModal();
                return;
            }

            let updatedQuestions = [...lessonToUpdate.questions_data];
            
            if (questionIndex >= updatedQuestions.length) {
                adminStatusEl.textContent = "L·ªói: Ch·ªâ s·ªë c√¢u h·ªèi kh√¥ng h·ª£p l·ªá.";
                closeQuestionDetailsModal();
                return;
            }

            updatedQuestions.splice(questionIndex, 1);
            
            try {
                const { error } = await supabase
                    .from('lessons')
                    .update({ 
                        questions_data: updatedQuestions,
                        num_questions: updatedQuestions.length 
                    })
                    .eq('id', lessonId);

                if (error) throw error;

                adminStatusEl.textContent = `‚úÖ ƒê√£ x√≥a th√†nh c√¥ng c√¢u h·ªèi s·ªë ${questionIndex + 1} kh·ªèi b√†i ${lessonToUpdate.lessonNumber}.`;
                
                closeQuestionDetailsModal();
                await fetchLessonsFromSupabase(); 
                
                adminGradeEl.value = String(currentGradeLocal);
                adminSubjectEl.value = currentSubjectLocal;
                await loadLessonOptions(false); 
                adminLessonEl.value = String(currentLessonNumberLocal);
                previewLesson();
                
                const latestLesson = lessonsAvailable[currentGradeLocal][currentSubjectLocal].find(l => l.lessonNumber === currentLessonNumberLocal);
                if (latestLesson && latestLesson.numQuestions > 0) {
                    showQuestionDetailsModal();
                }

            } catch (e) {
                adminStatusEl.textContent = `L·ªói x√≥a c√¢u h·ªèi Supabase: ${e.message}`;
                closeQuestionDetailsModal();
            }
        }

        // --- GEMINI API: Question Generation ---
        
        async function generateAndSaveQuestions() {
            if (!supabase) return;
            const prompt = aiPromptEl.value.trim();
            const grade = parseInt(adminGradeEl.value);
            const subject = adminSubjectEl.value;
            const lessonNumber = parseInt(adminLessonEl.value);
            
            if (!prompt) {
                aiStatusMessageEl.textContent = "Vui l√≤ng nh·∫≠p y√™u c·∫ßu t·∫°o c√¢u h·ªèi cho AI.";
                aiStatusMessageEl.className = 'text-sm font-semibold text-center mt-2 text-red-600';
                return;
            }
            
            if (lessonNumber === 0) {
                aiStatusMessageEl.textContent = "‚ö†Ô∏è Vui l√≤ng ch·ªçn B√†i H·ªçc ·ªü m·ª•c 3 ho·∫∑c t·∫°o b√†i m·ªõi ·ªü m·ª•c 1 tr∆∞·ªõc khi t·∫°o c√¢u h·ªèi.";
                aiStatusMessageEl.className = 'text-sm font-semibold text-center mt-2 text-red-600';
                return;
            }
            
            if (geminiKeys.length === 0) {
                aiStatusMessageEl.textContent = "‚ö†Ô∏è Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt API Key Gemini ·ªü M·ª•c 5.";
                aiStatusMessageEl.className = 'text-sm font-semibold text-center mt-2 text-red-600';
                return;
            }

            aiGenerateBtn.disabled = true;
            aiGenerateTextEl.textContent = "ƒêang t·∫°o c√¢u h·ªèi...";
            aiLoadingSpinnerEl.classList.remove('hidden');
            aiStatusMessageEl.textContent = ""; 
            aiResultPreviewEl.textContent = "";
            adminStatusEl.textContent = "";

            const isVocabGeneration = subject === 'ENGLISH';

            const subjectName = {
                'TOAN': 'To√°n H·ªçc (Ph√©p t√≠nh v√† L·ªùi vƒÉn)',
                'SPELL': 'Ti·∫øng Vi·ªát - Ch√≠nh T·∫£ (Ph√¢n bi·ªát √¢m/v·∫ßn, ƒëi·ªÅn t·ª´)',
                'READ': 'Ti·∫øng Vi·ªát - Luy·ªán ƒê·ªçc (Nghe v√† ch·ªçn c√¢u/t·ª´)',
                'ENGLISH': 'Ti·∫øng Anh (T·ª´ v·ª±ng c∆° b·∫£n)', 
            }[subject];

            let promptToGemini = prompt;
            let systemInstruction = '';
            let jsonSchema = {};

            if (isVocabGeneration) {
                 // N·∫øu l√† Ti·∫øng Anh, y√™u c·∫ßu ch·ªâ tr·∫£ v·ªÅ t·ª´ v·ª±ng, c√°c tr∆∞·ªùng kh√°c l√† r·ªóng/placeholder
                promptToGemini = `D·ª±a tr√™n y√™u c·∫ßu: "${prompt}". T·∫°o 30 t·ª´ v·ª±ng ti·∫øng Anh c∆° b·∫£n cho L·ªõp ${grade}. M·ªói t·ª´ v·ª±ng l√† m·ªôt c√¢u h·ªèi.`;
                systemInstruction = `B·∫°n l√† m·ªôt chuy√™n gia t·∫°o t·ª´ v·ª±ng. H√£y t·∫°o danh s√°ch 30 t·ª´ v·ª±ng cho h·ªçc sinh c·∫•p 1 theo c·∫•u tr√∫c JSON NGHI√äM NG·∫∂T sau.
                QUY T·∫ÆC:
                1. 'q' ph·∫£i l√† m·ªôt t·ª´ v·ª±ng Ti·∫øng Anh duy nh·∫•t (v√≠ d·ª•: 'apple', 'run', 'blue').
                2. 'a' lu√¥n l√† chu·ªói r·ªóng: "".
                3. 'options' lu√¥n l√† m·ªôt m·∫£ng r·ªóng: [].
                4. 'text' lu√¥n l√† chu·ªói r·ªóng: "".
                5. 'type' lu√¥n l√†: "ENGLISH".`;

                jsonSchema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "q": { "type": "STRING", "description": "T·ª´ v·ª±ng ti·∫øng Anh duy nh·∫•t" },
                            "a": { "type": "STRING" },
                            "options": { "type": "ARRAY", "items": { "type": "STRING" } },
                            "text": { "type": "STRING" },
                            "type": { "type": "STRING", "enum": ["ENGLISH"] }
                        },
                        required: ["q", "a", "options", "text", "type"]
                    }
                };
            } else {
                // Ch·∫ø ƒë·ªô Tr·∫Øc nghi·ªám/To√°n/Ti·∫øng Vi·ªát
                systemInstruction = `B·∫°n l√† m·ªôt gi√°o vi√™n ti·ªÉu h·ªçc. H√£y t·∫°o 30 c√¢u h·ªèi d·ª±a tr√™n y√™u c·∫ßu ng∆∞·ªùi d√πng, cho L·ªõp ${grade} - M√¥n ${subjectName}.
                
                TU√ÇN TH·ª¶ C·∫§U TR√öC JSON NGHI√äM NG·∫∂T sau (Array of Objects):
                1. 'q': C√¢u h·ªèi hi·ªÉn th·ªã (d√πng cho To√°n/Ch√≠nh t·∫£) HO·∫∂C D√≤ng h∆∞·ªõng d·∫´n (d√πng cho Luy·ªán ƒë·ªçc).
                2. 'a': ƒê√°p √°n ƒë√∫ng (lu√¥n l√† chu·ªói).
                3. 'options': Array ch·ª©a 4 l·ª±a ch·ªçn (bao g·ªìm c·∫£ ƒë√°p √°n ƒë√∫ng).
                4. 'text': VƒÉn b·∫£n ch√≠nh x√°c c·∫ßn ƒë·ªçc to (ch·ªâ c·∫ßn cho Luy·ªán ƒë·ªçc v√† To√°n l·ªùi vƒÉn, b·ªè tr·ªëng cho To√°n ph√©p t√≠nh, n·∫øu l√† ph√©p t√≠nh th√¨ d√πng "A c·ªông B b·∫±ng bao nhi√™u").
                5. 'type': B·∫ÆT BU·ªòNG l√† m·ªôt trong c√°c gi√° tr·ªã sau: MATH_OP (Ph√©p t√≠nh), MATH_WORD (L·ªùi vƒÉn), SPELL (Ch√≠nh t·∫£), READ (Luy·ªán ƒë·ªçc).`; 

                jsonSchema = {
                    type: "ARRAY",
                    items: {
                        type: "OBJECT",
                        properties: {
                            "q": { "type": "STRING", "description": "C√¢u h·ªèi hi·ªÉn th·ªã" },
                            "a": { "type": "STRING", "description": "ƒê√°p √°n ƒë√∫ng" },
                            "options": { "type": "ARRAY", "items": { "type": "STRING" }, "description": "4 l·ª±a ch·ªçn" },
                            "text": { "type": "STRING", "description": "VƒÉn b·∫£n ƒë·ªÉ ƒë·ªçc (b·ªè tr·ªëng n·∫øu l√† To√°n ph√©p t√≠nh)" },
                            "type": { "type": "STRING", "enum": ["MATH_OP", "MATH_WORD", "SPELL", "READ"] }
                        },
                        required: ["q", "a", "options", "text", "type"]
                    }
                };
            }
            
            const payload = {
                contents: [{ parts: [{ text: promptToGemini }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema,
                }
            };

            let successful = false;
            let finalError = "Kh√¥ng th·ªÉ k·∫øt n·ªëi ho·∫∑c t·∫•t c·∫£ API keys ƒë·ªÅu b·ªã l·ªói.";
            
            const MODEL_NAME = 'gemini-2.5-flash-preview-05-20'; 

            for (let i = 0; i < geminiKeys.length; i++) {
                currentKeyIndex = (i + currentKeyIndex) % geminiKeys.length;
                const apiKey = geminiKeys[currentKeyIndex];
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
                
                aiStatusMessageEl.textContent = `ƒêang th·ª≠ API Key s·ªë ${currentKeyIndex + 1}/${geminiKeys.length}...`; 
                aiStatusMessageEl.className = 'text-sm font-semibold text-center mt-2 text-blue-600';

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        
                        if (result.candidates && result.candidates.length > 0 && 
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            
                            const jsonString = result.candidates[0].content.parts[0].text;
                            const newQuestions = JSON.parse(jsonString);
                            
                            // Ki·ªÉm tra n·∫øu l√† ch·∫ø ƒë·ªô Vocab, c·∫ßn ƒë·∫£m b·∫£o c√°c tr∆∞·ªùng ph·ª• l√† r·ªóng/placeholder
                            if (isVocabGeneration) {
                                newQuestions.forEach(q => {
                                    q.a = ''; // Ensure answer is empty
                                    q.options = []; // Ensure options are empty
                                    q.text = q.q; // Use the word itself for reading data
                                });
                            }

                            if (Array.isArray(newQuestions) && newQuestions.length > 0) {
                                await saveNewQuestions(grade, subject, lessonNumber, newQuestions);
                                successful = true;
                                break; 
                            } else {
                                finalError = "AI tr·∫£ v·ªÅ c·∫•u tr√∫c kh√¥ng ph·∫£i l√† m·ªôt m·∫£ng c√¢u h·ªèi."; 
                                throw new Error("AI returned non-array structure.");
                            }
                        } else {
                            finalError = "Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung t·ª´ AI.";
                            throw new Error("No content received from AI.");
                        }

                    } else {
                        const errorBody = await response.json();
                        const errorMessage = errorBody.error?.message || `L·ªói HTTP ${response.status}`;
                        finalError = `Key ${currentKeyIndex + 1} l·ªói: ${errorMessage}`;
                        console.error(`L·ªói API Key ${currentKeyIndex + 1}:`, errorMessage);
                    }

                } catch (error) {
                    finalError = `Key ${currentKeyIndex + 1} l·ªói k·∫øt n·ªëi/m·∫°ng: ${error.message}`;
                    console.error(`L·ªói k·∫øt n·ªëi Key ${currentKeyIndex + 1}:`, error);
                }
            } 

            if (!successful) {
                aiStatusMessageEl.textContent = `L·ªñI AI: ${finalError}`; 
                aiStatusMessageEl.className = 'text-sm font-semibold text-center mt-2 text-red-600';
            }

            aiGenerateBtn.disabled = false;
            aiGenerateTextEl.textContent = "‚ú® T·∫°o & L∆∞u 30 C√¢u H·ªèi M·ªõi";
            aiLoadingSpinnerEl.classList.add('hidden');
        }
        
        async function saveNewQuestions(grade, subject, lessonNumber, newQuestions) {
            
            const lessonsArray = lessonsAvailable[grade][subject];
            const lesson = lessonsArray.find(l => l.lessonNumber === lessonNumber);
            
            if (!lesson) {
                aiStatusMessageEl.textContent = `L·ªói l∆∞u d·ªØ li·ªáu: Kh√¥ng t√¨m th·∫•y B√†i ${lessonNumber}.`;
                aiStatusMessageEl.className = 'text-sm font-semibold text-center mt-2 text-red-600';
                return;
            }

            try {
                let existingQuestions = lesson.questions_data || [];
                const updatedQuestions = [...existingQuestions, ...newQuestions];
                
                const { error } = await supabase
                    .from('lessons')
                    .update({ 
                        questions_data: updatedQuestions, 
                        num_questions: updatedQuestions.length 
                    })
                    .eq('id', lesson.id);
                
                if (error) throw error;
                
                aiStatusMessageEl.textContent = `‚úÖ ƒê√£ l∆∞u ${newQuestions.length} c√¢u h·ªèi m·ªõi v√†o B√†i ${lessonNumber}. T·ªïng s·ªë c√¢u: ${updatedQuestions.length}.`;
                aiStatusMessageEl.className = 'text-sm font-semibold text-center mt-2 text-green-600';
                
                aiResultPreviewEl.textContent = JSON.stringify(newQuestions.slice(0, 3), null, 2) + `\n... v√† ${newQuestions.length - 3} c√¢u kh√°c.`;
                
                await fetchLessonsFromSupabase(); 
                
                await loadLessonOptions(false); 
                
                adminLessonEl.value = String(lessonNumber); 
                previewLesson();
                
            } catch (e) {
                aiStatusMessageEl.textContent = `L·ªói l∆∞u d·ªØ li·ªáu Supabase: ${e.message}`;
                aiStatusMessageEl.className = 'text-sm font-semibold text-center mt-2 text-red-600';
                console.error("Supabase Save Error:", e);
            }
        }
        
        // --- STARTUP ---
        window.onload = () => {
             lessonsAvailable[0] = { ALPHABET: [] }; 
             fetchLessonsFromSupabase(); 
             showScreen('student-name-input');
        }

        // --- G√ÅN H√ÄM V√ÄO WINDOW OBJECT ƒê·ªÇ TRUY C·∫¨P T·ª™ HTML ---
        Object.assign(window, {
            showScreen, selectStudentAndGrade, adminLogin, adminLogout,
            selectGrade, selectSubject, startLessonSet, endLessonSet, playAudio, getVocabularyExplanation, 
            checkLessonRange, loadLessonOptions, previewLesson, createNewLessonStructure,
            updateLessonName, confirmDeleteLesson, generateAndSaveQuestions,
            toggleHistoryContent, displayHistory, addGeminiKey, deleteGeminiKey,
            showQuestionDetailsModal, closeQuestionDetailsModal, confirmDeleteQuestion
        });

    </script>
</body>
</html>
