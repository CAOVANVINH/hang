<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trò Chơi Tìm Chữ & Ghép Vần (Offline)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap');
        
        :root {
            --blue-600: #2563eb;
            --orange-500: #f97316;
            --green-600: #16a34a;
            --indigo-600: #4f46e5;
            --gray-600: #4b5563;
        }

        body {
            font-family: 'Quicksand', sans-serif, Arial, sans-serif;
            background-color: #f0f9ff;
            margin: 0;
            padding: 1rem;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 896px; /* tương đương max-w-4xl */
            text-align: center;
        }

        h1 {
            font-size: 2.25rem; /* tương đương text-4xl */
            font-weight: 700;
            color: var(--blue-600);
            margin-bottom: 0.5rem;
        }

        #game-controls {
            margin-bottom: 1.5rem;
            min-height: 4rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #prompt-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        #game-prompt {
            color: #374151; /* text-gray-700 */
            font-size: 1.5rem; /* text-2xl */
            font-weight: 600;
        }

        button {
            padding: 0.75rem 2rem;
            color: white;
            font-weight: 700;
            border: none;
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
        }
        button:hover:not(:disabled) {
            transform: scale(1.05);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        #menu-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }
        .menu-btn {
            font-size: 1.125rem;
            padding: 1rem 2.5rem;
        }

        #start-game-btn { background-color: var(--orange-500); }
        #start-game-btn:hover { background-color: #ea580c; } 

        #review-mode-btn { background-color: var(--green-600); } 
        #review-mode-btn:hover { background-color: #15803d; } 

        /* New button for word building */
        #word-building-btn { background-color: var(--indigo-600); }
        #word-building-btn:hover { background-color: #4338ca; }

        #play-again-btn, #back-to-menu-win-btn { background-color: #3b82f6; margin-top: 1rem; }
        #play-again-btn:hover, #back-to-menu-win-btn:hover { background-color: #2563eb; }

        #repeat-question-btn {
            background-color: #9ca3af; /* bg-gray-400 */
            padding: 0.5rem;
            margin: 0;
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #repeat-question-btn:hover { background-color: #6b7280; }
        
        #back-btn {
            background-color: #6b7280;
            margin-top: 1.5rem;
        }
        #back-btn:hover { background-color: var(--gray-600); }

        #alphabet-grid {
            display: grid;
            gap: 1rem;
            background-color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            grid-template-columns: repeat(4, 1fr);
        }

        @media (min-width: 640px) { #alphabet-grid { grid-template-columns: repeat(5, 1fr); } }
        @media (min-width: 768px) { #alphabet-grid { grid-template-columns: repeat(7, 1fr); } }
        @media (min-width: 1024px) { #alphabet-grid { grid-template-columns: repeat(8, 1fr); } }

        .letter-box {
            color: white;
            font-size: 2.25rem;
            font-weight: 700;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1 / 1;
            transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out, background-color 0.2s;
        }
        .letter-box:active {
            transform: scale(0.95);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .bg-red { background-color: #ef4444; } .bg-blue { background-color: #3b82f6; } .bg-green { background-color: #22c55e; } .bg-yellow { background-color: #eab308; } .bg-purple { background-color: #8b5cf6; } .bg-pink { background-color: #ec4899; } .bg-indigo { background-color: #6366f1; } .bg-teal { background-color: #14b8a6; } .bg-orange { background-color: #f97316; }

        .hidden { display: none !important; }

        #win-screen p { font-size: 1.875rem; font-weight: 700; color: var(--green-600); }
        .footer-text { font-size: 0.75rem; color: #9ca3af; margin-top: 2rem; }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake { animation: shake 0.3s ease-in-out; }

        @keyframes celebrate { 0% { transform: scale(1); } 50% { transform: scale(1.1) rotate(5deg); } 100% { transform: scale(1); } }
        .celebrate { animation: celebrate 0.5s ease-in-out; background-color: #15803d !important; }

        /* Styles for Case Selector */
        #case-selector-container {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.7);
            border-radius: 0.75rem;
        }
        #case-selector-container p {
            color: var(--gray-600);
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }
        #case-selector { display: flex; justify-content: center; gap: 0.5rem; }
        .case-btn {
            padding: 0.5rem 1.5rem;
            font-size: 1.125rem;
            background-color: #d1d5db;
            color: var(--gray-600);
            border: 2px solid transparent;
        }
        .case-btn.active {
            background-color: #60a5fa;
            color: white;
            border-color: var(--blue-600);
            transform: scale(1.05);
        }

        /* Styles for Word Building Mode */
        #word-building-screen #word-prompt {
            font-size: 1.75rem;
            color: var(--gray-600);
        }
        #target-word-display {
            color: var(--indigo-600);
            font-size: 2.25rem;
        }
        #target-word-image {
            margin: 1rem 0;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        #build-area { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 1rem; 
            margin: 1.5rem 0; 
            height: 80px;
        }
        .build-box {
            width: 80px; height: 80px;
            border: 3px dashed #a5b4fc;
            border-radius: 0.75rem;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; font-weight: 700; color: #4338ca;
            background-color: #e0e7ff;
            transition: all 0.3s;
        }
        .plus-sign { font-size: 2.5rem; font-weight: 700; color: var(--gray-600); }
        #word-building-screen .section-title { 
            font-size: 1.25rem; 
            font-weight: 600; 
            color: var(--gray-600);
            margin-top: 1.5rem; 
            margin-bottom: 0.75rem; 
        }
        .letter-choice-grid { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            gap: 0.5rem; 
            margin-bottom: 1.5rem;
            padding: 0 1rem;
        }
        .choice-btn {
            padding: 0.75rem;
            min-width: 50px;
            font-size: 1.5rem;
            background-color: #fff;
            color: #3b82f6;
            border: 2px solid #93c5fd;
            border-radius: 0.5rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            line-height: 1;
        }
        .choice-btn:hover:not(:disabled) { background-color: #dbeafe; border-color: #3b82f6; }
        .choice-btn.correct { background-color: #a7f3d0; border-color: #10b981; color: #047857; transform: scale(1.1); }

    </style>
</head>
<body>
    <div class="container">
        <h1>Trò Chơi Học Chữ</h1>
        
        <div id="game-controls">
            <!-- Main Menu -->
            <div id="menu-container">
                <div id="case-selector-container">
                    <p>Chọn kiểu chữ để học:</p>
                    <div id="case-selector">
                        <button id="case-upper-btn" class="case-btn active">A B C</button>
                        <button id="case-lower-btn" class="case-btn">a b c</button>
                    </div>
                </div>
                <button id="start-game-btn" class="menu-btn">Tìm Chữ (Thử Thách)</button>
                <button id="review-mode-btn" class="menu-btn">Ôn Tập Bảng Chữ Cái</button>
                <button id="word-building-btn" class="menu-btn">Tập Ghép Vần</button>
            </div>
            <!-- Prompt for "Find Letter" game -->
            <div id="prompt-container" class="hidden">
                <p id="game-prompt"></p>
                <button id="repeat-question-btn" title="Đọc lại câu hỏi">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                </button>
            </div>
        </div>

        <!-- Grid for finding letters -->
        <div id="alphabet-grid" class="hidden"></div>

        <!-- Screen for Word Building -->
        <div id="word-building-screen" class="hidden">
            <div id="word-prompt-container">
                <h2 id="word-prompt">Hãy ghép chữ: <span id="target-word-display"></span></h2>
                <img id="target-word-image" src="https://placehold.co/200x150/e0e7ff/4338ca?text=Hình+minh+họa" alt="Hình minh họa cho từ">
            </div>
            <div id="build-area">
                 <div id="build-box-1" class="build-box"></div>
                 <div class="plus-sign">+</div>
                 <div id="build-box-2" class="build-box"></div>
            </div>
            <p class="section-title">Chọn phụ âm:</p>
            <div id="consonants-grid" class="letter-choice-grid"></div>
            <p class="section-title">Chọn nguyên âm:</p>
            <div id="vowels-grid" class="letter-choice-grid"></div>
        </div>
        
        <!-- Win Screen -->
        <div id="win-screen" class="hidden">
            <p>Chúc mừng con đã hoàn thành!</p>
            <button id="play-again-btn">Chơi lại</button>
            <button id="back-to-menu-win-btn">Về Menu Chính</button>
        </div>

        <button id="back-btn" class="hidden">Quay Lại Menu</button>
        <p class="footer-text">Đọc bởi Gemini AI</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA & CONSTANTS ---
            const alphabet = ['A', 'Ă', 'Â', 'B', 'C', 'D', 'Đ', 'E', 'Ê', 'G', 'H', 'I', 'K', 'L', 'M', 'N', 'O', 'Ô', 'Ơ', 'P', 'Q', 'R', 'S', 'T', 'U', 'Ư', 'V', 'X', 'Y'];
            const colors = ['bg-red', 'bg-blue', 'bg-green', 'bg-yellow', 'bg-purple', 'bg-pink', 'bg-indigo', 'bg-teal', 'bg-orange'];
            const phoneticMap = { 'A': 'a', 'Ă': 'á', 'Â': 'ớ', 'B': 'bờ', 'C': 'cờ', 'D': 'dờ', 'Đ': 'đờ', 'E': 'e', 'Ê': 'ê', 'G': 'gờ', 'H': 'hờ', 'I': 'i ngắn', 'K': 'ca', 'L': 'lờ', 'M': 'mờ', 'N': 'nờ', 'O': 'o', 'Ô': 'ô', 'Ơ': 'ơ', 'P': 'pờ', 'Q': 'quờ', 'R': 'rờ', 'S': 'sờ', 'T': 'tờ', 'U': 'u', 'Ư': 'ư', 'V': 'vờ', 'X': 'xờ', 'Y': 'i dài' };
            const exampleWordMap = { 'A': 'Cái Ca', 'Ă': 'Cái Khăn', 'Â': 'Cái Cân', 'B': 'Con Bò', 'C': 'Con Cá', 'D': 'Con Dê', 'Đ': 'Quả Đu Đủ', 'E': 'Em Bé', 'Ê': 'Con Ếch', 'G': 'Con Gà', 'H': 'Hoa Hồng', 'I': 'Viên Bi', 'K': 'Cái Kéo', 'L': 'Lá Cây', 'M': 'Con Mèo', 'N': 'Cái Nơ', 'O': 'Con Bò', 'Ô': 'Cái Ô', 'Ơ': 'Lá Cờ', 'P': 'Đèn Pin', 'Q': 'Quyển Vở', 'R': 'Con Rùa', 'S': 'Con Sóc', 'T': 'Con Tôm', 'U': 'Củ Su', 'Ư': 'Trái Dừa', 'V': 'Con Voi', 'X': 'Xe Đạp', 'Y': 'Y Tá' };
            
            const consonants = ['B', 'C', 'D', 'Đ', 'G', 'H', 'K', 'L', 'M', 'N', 'P', 'Q', 'R', 'S', 'T', 'V', 'X'];
            const vowelsWithTones = {'A':['a','á','à','ả','ã','ạ'],'Ă':['ă','ắ','ằ','ẳ','ẵ','ặ'],'Â':['â','ấ','ầ','ẩ','ẫ','ậ'],'E':['e','é','è','ẻ','ẽ','ẹ'],'Ê':['ê','ế','ề','ể','ễ','ệ'],'I':['i','í','ì','ỉ','ĩ','ị'],'O':['o','ó','ò','ỏ','õ','ọ'],'Ô':['ô','ố','ồ','ổ','ỗ','ộ'],'Ơ':['ơ','ớ','ờ','ở','ỡ','ợ'],'U':['u','ú','ù','ủ','ũ','ụ'],'Ư':['ư','ứ','ừ','ử','ữ','ự'],'Y':['y','ý','ỳ','ỷ','ỹ','ỵ']};
            const allVowels = Object.values(vowelsWithTones).flat();

            const practiceWords = [
                { word: 'Ba', consonant: 'B', vowel: 'a', image: 'https://placehold.co/200x150/6366f1/ffffff?text=Ba' },
                { word: 'Bà', consonant: 'B', vowel: 'à', image: 'https://placehold.co/200x150/6366f1/ffffff?text=Bà' },
                { word: 'Bò', consonant: 'B', vowel: 'ò', image: 'https://placehold.co/200x150/6366f1/ffffff?text=Bò' },
                { word: 'Cá', consonant: 'C', vowel: 'á', image: 'https://placehold.co/200x150/6366f1/ffffff?text=Cá' },
                { word: 'Gà', consonant: 'G', vowel: 'à', image: 'https://placehold.co/200x150/6366f1/ffffff?text=Gà' },
                { word: 'Ve', consonant: 'V', vowel: 'e', image: 'https://placehold.co/200x150/6366f1/ffffff?text=Ve' },
                { word: 'Mẹ', consonant: 'M', vowel: 'ẹ', image: 'https://placehold.co/200x150/6366f1/ffffff?text=Mẹ' },
                { word: 'Dê', consonant: 'D', vowel: 'ê', image: 'https://placehold.co/200x150/6366f1/ffffff?text=Dê' },
                { word: 'Bi', consonant: 'B', vowel: 'i', image: 'https://placehold.co/200x150/6366f1/ffffff?text=Bi' },
                { word: 'Đò', consonant: 'Đ', vowel: 'ò', image: 'https://placehold.co/200x150/6366f1/ffffff?text=Đò' },
                { word: 'Tô', consonant: 'T', vowel: 'ô', image: 'https://placehold.co/200x150/6366f1/ffffff?text=Tô' },
                { word: 'Ly', consonant: 'L', vowel: 'y', image: 'https://placehold.co/200x150/6366f1/ffffff?text=Ly' },
            ];

            // --- DOM ELEMENTS ---
            const grid = document.getElementById('alphabet-grid');
            const gamePrompt = document.getElementById('game-prompt');
            const winScreen = document.getElementById('win-screen');
            const promptContainer = document.getElementById('prompt-container');
            const menuContainer = document.getElementById('menu-container');
            const backBtn = document.getElementById('back-btn');
            
            // Buttons
            const startGameBtn = document.getElementById('start-game-btn');
            const playAgainBtn = document.getElementById('play-again-btn');
            const repeatQuestionBtn = document.getElementById('repeat-question-btn');
            const reviewModeBtn = document.getElementById('review-mode-btn');
            const backToMenuWinBtn = document.getElementById('back-to-menu-win-btn');
            const caseUpperBtn = document.getElementById('case-upper-btn');
            const caseLowerBtn = document.getElementById('case-lower-btn');
            const wordBuildingBtn = document.getElementById('word-building-btn');

            // Word Building elements
            const wordBuildingScreen = document.getElementById('word-building-screen');
            const targetWordDisplay = document.getElementById('target-word-display');
            const targetWordImage = document.getElementById('target-word-image');
            const consonantsGrid = document.getElementById('consonants-grid');
            const vowelsGrid = document.getElementById('vowels-grid');
            const buildBox1 = document.getElementById('build-box-1');
            const buildBox2 = document.getElementById('build-box-2');

            // --- STATE VARIABLES ---
            let letterCase = 'upper';
            let currentMode = 'menu';
            let vietnameseVoice = null;
            let shuffledAlphabet = [];
            let currentLetterIndex = 0;
            let gameActive = false;
            let currentQuestionText = '';
            let lastPlayedMode = '';
            
            let shuffledWords = [];
            let currentWordIndex = 0;
            let wordBuildingStep = 'consonant';


            // --- CORE FUNCTIONS ---
            function loadAndSetVoice() {
                const voices = window.speechSynthesis.getVoices();
                if (!voices.length) return;
                const vietnameseVoices = voices.filter(voice => voice.lang === 'vi-VN');
                if (!vietnameseVoices.length) {
                    gamePrompt.textContent = "Lỗi: Không tìm thấy giọng đọc Tiếng Việt trên máy tính.";
                    [startGameBtn, reviewModeBtn, wordBuildingBtn].forEach(b => b.disabled = true);
                    return;
                };
                
                const priorityVoices = ['Google Tiếng Việt', 'Microsoft An', 'Linh'];
                for (const name of priorityVoices) {
                    const foundVoice = vietnameseVoices.find(voice => voice.name.includes(name));
                    if (foundVoice) { vietnameseVoice = foundVoice; return; }
                }
                vietnameseVoice = vietnameseVoices.find(voice => /nữ|female/i.test(voice.name)) || vietnameseVoices[0];
            }
            loadAndSetVoice();
            if (window.speechSynthesis.onvoiceschanged !== undefined) {
                window.speechSynthesis.onvoiceschanged = loadAndSetVoice;
            }

            function speak(text, rate = 0.9, pitch = 1.1, onEndCallback = null) {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'vi-VN';
                    utterance.rate = rate;
                    utterance.pitch = pitch;
                    if (vietnameseVoice) utterance.voice = vietnameseVoice;
                    if (onEndCallback) utterance.onend = onEndCallback;
                    window.speechSynthesis.speak(utterance);
                }
            }
            
            // --- UI & SCREEN MANAGEMENT ---
            function showMenu() {
                currentMode = 'menu';
                window.speechSynthesis.cancel();
                menuContainer.classList.remove('hidden');
                grid.classList.add('hidden');
                promptContainer.classList.add('hidden');
                winScreen.classList.add('hidden');
                backBtn.classList.add('hidden');
                wordBuildingScreen.classList.add('hidden'); // Hide new screen
            }

            function endGame() {
                gameActive = false;
                grid.classList.add('hidden');
                wordBuildingScreen.classList.add('hidden');
                winScreen.classList.remove('hidden');
                promptContainer.classList.add('hidden');
                backBtn.classList.add('hidden');
                speak("Con giỏi quá! Chúc mừng con đã hoàn thành trò chơi!");
            }

            // --- FIND THE LETTER MODE ---
            function renderAlphabetGrid() {
                grid.innerHTML = ''; 
                alphabet.forEach(letter => {
                    const letterDiv = document.createElement('div');
                    const randomColor = colors[Math.floor(Math.random() * colors.length)];
                    letterDiv.className = `letter-box ${randomColor}`;
                    letterDiv.textContent = letterCase === 'upper' ? letter : letter.toLowerCase();
                    letterDiv.setAttribute('data-letter', letter); 
                    grid.appendChild(letterDiv);
                });
            }
            
            function setupReviewMode() {
                lastPlayedMode = 'review';
                currentMode = 'review';
                menuContainer.classList.add('hidden');
                grid.classList.remove('hidden');
                backBtn.classList.remove('hidden');
                promptContainer.classList.add('hidden');
            }
            
            function askForNextLetter() {
                if (currentLetterIndex >= shuffledAlphabet.length) {
                    endGame();
                    return;
                }
                const letterToFind = shuffledAlphabet[currentLetterIndex];
                const phonetic = phoneticMap[letterToFind];
                currentQuestionText = `Con hãy tìm chữ ${phonetic}`;
                gamePrompt.textContent = currentQuestionText;
                speak(currentQuestionText, 0.9, 1.1, () => { gameActive = true; });
            }

            function startGame() {
                lastPlayedMode = 'game';
                currentMode = 'game';
                gameActive = false;
                currentLetterIndex = 0;
                shuffledAlphabet = [...alphabet].sort(() => 0.5 - Math.random());
                menuContainer.classList.add('hidden');
                promptContainer.classList.remove('hidden');
                winScreen.classList.add('hidden');
                grid.classList.remove('hidden');
                backBtn.classList.remove('hidden');
                askForNextLetter();
            }

            // --- WORD BUILDING MODE ---
            function setupWordBuildingMode() {
                lastPlayedMode = 'word-building';
                currentMode = 'word-building';
                menuContainer.classList.add('hidden');
                winScreen.classList.add('hidden');
                wordBuildingScreen.classList.remove('hidden');
                backBtn.classList.remove('hidden');
                
                populateChoiceGrids();
                
                shuffledWords = [...practiceWords].sort(() => 0.5 - Math.random());
                currentWordIndex = 0;
                startNextWord();
            }

            function populateChoiceGrids() {
                consonantsGrid.innerHTML = '';
                vowelsGrid.innerHTML = '';
                
                // Get unique consonants and vowels from the practice words to avoid showing unused ones
                const usedConsonants = [...new Set(practiceWords.map(w => w.consonant))];
                const usedVowels = [...new Set(practiceWords.map(w => w.vowel))];

                usedConsonants.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    btn.textContent = letterCase === 'upper' ? c : c.toLowerCase();
                    btn.dataset.letter = c;
                    consonantsGrid.appendChild(btn);
                });
                usedVowels.forEach(v => {
                    const btn = document.createElement('button');
                    btn.className = 'choice-btn';
                    btn.textContent = v; // Vowels with tones don't have uppercase
                    btn.dataset.letter = v;
                    vowelsGrid.appendChild(btn);
                });
            }

            function resetBuildArea() {
                buildBox1.textContent = '';
                buildBox2.textContent = '';
                buildBox1.classList.remove('correct');
                buildBox2.classList.remove('correct');
            }

            function startNextWord() {
                if (currentWordIndex >= shuffledWords.length) {
                    endGame();
                    return;
                }
                resetBuildArea();
                wordBuildingStep = 'consonant';
                
                const currentWord = shuffledWords[currentWordIndex];
                targetWordDisplay.textContent = currentWord.word;
                targetWordImage.src = currentWord.image;
                targetWordImage.alt = `Hình minh họa cho chữ ${currentWord.word}`;
                
                const promptText = `Bây giờ, con hãy ghép chữ '${currentWord.word}' nhé.`;
                speak(promptText);
            }

            function handleChoice(event, type) {
                if (wordBuildingStep !== type) return;
                const clickedBtn = event.target.closest('.choice-btn');
                if (!clickedBtn) return;

                const currentWord = shuffledWords[currentWordIndex];
                const correctLetter = type === 'consonant' ? currentWord.consonant : currentWord.vowel;

                if (clickedBtn.dataset.letter === correctLetter) {
                    // Correct choice
                    const phonetic = phoneticMap[currentWord.consonant];
                    if (type === 'consonant') {
                        buildBox1.textContent = letterCase === 'upper' ? correctLetter : correctLetter.toLowerCase();
                        clickedBtn.classList.add('correct');
                        speak(`Đúng rồi, ${phonetic}!`, 0.9, 1.1, () => {
                            setTimeout(() => clickedBtn.classList.remove('correct'), 1000);
                        });
                        wordBuildingStep = 'vowel';
                    } else { // Vowel
                        buildBox2.textContent = correctLetter;
                        clickedBtn.classList.add('correct');
                        wordBuildingStep = 'done'; // prevent more clicks

                        // Read out the full word construction
                        speak(phonetic, 0.9, 1.1, () => {
                            speak(currentWord.vowel, 0.9, 1.1, () => {
                                speak(currentWord.word, 1.0, 1.1, () => {
                                    currentWordIndex++;
                                    setTimeout(startNextWord, 2000);
                                });
                            });
                        });
                    }
                } else {
                    // Incorrect choice
                    clickedBtn.classList.add('shake');
                    speak("Chưa đúng, con thử lại nhé!");
                    setTimeout(() => clickedBtn.classList.remove('shake'), 500);
                }
            }


            // --- EVENT LISTENERS ---
            grid.addEventListener('click', (event) => {
                const clickedBox = event.target.closest('.letter-box');
                if (!clickedBox) return;

                if (currentMode === 'review') {
                    const clickedLetter = clickedBox.getAttribute('data-letter');
                    const phonetic = phoneticMap[clickedLetter];
                    const example = exampleWordMap[clickedLetter];
                    const sentence = `${phonetic}, có trong từ ${example}`;
                    speak(sentence);
                    clickedBox.classList.add('celebrate');
                    setTimeout(() => clickedBox.classList.remove('celebrate'), 500);
                } else if (currentMode === 'game' && gameActive) {
                    const clickedLetter = clickedBox.getAttribute('data-letter');
                    const correctLetter = shuffledAlphabet[currentLetterIndex];
                    if (clickedLetter === correctLetter) {
                        gameActive = false;
                        clickedBox.classList.add('celebrate');
                        speak("Đúng rồi!", 0.9, 1.1, () => {
                            const phonetic = phoneticMap[correctLetter];
                            const example = exampleWordMap[correctLetter];
                            const exampleSentence = `${phonetic}, có trong từ ${example}`;
                            speak(exampleSentence, 0.9, 1.1, () => {
                                clickedBox.classList.remove('celebrate');
                                currentLetterIndex++;
                                askForNextLetter();
                            });
                        });
                    } else {
                        clickedBox.classList.add('shake');
                        speak("Sai rồi, thử lại nhé!");
                        setTimeout(() => clickedBox.classList.remove('shake'), 500);
                    }
                }
            });
            
            repeatQuestionBtn.addEventListener('click', () => {
                if (gameActive && currentQuestionText) speak(currentQuestionText);
            });
            
            caseUpperBtn.addEventListener('click', () => {
                letterCase = 'upper';
                caseUpperBtn.classList.add('active');
                caseLowerBtn.classList.remove('active');
                renderAlphabetGrid();
                if(currentMode === 'word-building') populateChoiceGrids();
            });

            caseLowerBtn.addEventListener('click', () => {
                letterCase = 'lower';
                caseLowerBtn.classList.add('active');
                caseUpperBtn.classList.remove('active');
                renderAlphabetGrid();
                if(currentMode === 'word-building') populateChoiceGrids();
            });

            // Word building listeners
            consonantsGrid.addEventListener('click', (e) => handleChoice(e, 'consonant'));
            vowelsGrid.addEventListener('click', (e) => handleChoice(e, 'vowel'));
            
            // Menu and navigation buttons
            startGameBtn.addEventListener('click', startGame);
            reviewModeBtn.addEventListener('click', setupReviewMode);
            wordBuildingBtn.addEventListener('click', setupWordBuildingMode);
            backBtn.addEventListener('click', showMenu);
            playAgainBtn.addEventListener('click', () => {
                if (lastPlayedMode === 'game') startGame();
                else if (lastPlayedMode === 'word-building') setupWordBuildingMode();
                else showMenu();
            });
            backToMenuWinBtn.addEventListener('click', showMenu);

            // --- INITIALIZATION ---
            renderAlphabetGrid(); // Initial render for caching
            showMenu(); // Start at the menu
        });
    </script>
</body>
</html>
