<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To√°n & Ti·∫øng Vi·ªát T√≠ Hon (Supabase)</title>
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- T·∫£i Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* ƒê·ªãnh nghƒ©a font ch·ªØ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .game-input:focus, .admin-input:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.4);
        }
        .primary-btn {
            background-color: #ef4444;
            transition: background-color 0.2s, transform 0.1s;
        }
        .primary-btn:hover { background-color: #dc2626; }
        .primary-btn:active { transform: scale(0.98); }
        .subject-btn {
             background-color: #4f46e5; 
             transition: background-color 0.2s, transform 0.1s;
        }
        .subject-btn:hover { background-color: #4338ca; }
        .select-btn {
             background-color: #4f46e5;
             transition: background-color 0.2s, transform 0.1s, opacity 0.3s;
             box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
             word-break: break-word;
             text-align: left;
        }
        .select-btn:hover { opacity: 0.9; }
        .read-btn {
            background-color: #10b981;
            transition: background-color 0.2s, transform 0.1s;
        }
        .read-btn:hover { background-color: #059669; }
        
        .admin-nav-btn {
            background-color: #3b82f6; /* Blue 500 */
        }
        .admin-nav-btn:hover {
            background-color: #2563eb; /* Blue 600 */
        }
        .danger-btn {
            background-color: #f43f5e; /* Rose 500 */
            transition: background-color 0.2s;
        }
        .danger-btn:hover {
            background-color: #e11d48; /* Rose 600 */
        }
        .admin-section-header {
            font-weight: 700;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 1.25rem; /* text-xl */
            color: #1d4ed8; /* blue-700 */
            border-bottom: 2px solid #93c5fd; /* blue-300 */
            padding-bottom: 0.5rem;
        }
    </style>
    
    <!-- KH√îNG C√íN IMPORT FIREBASE -->
    <script type="module">
        // ƒê√°nh d·∫•u ƒë√£ s·∫µn s√†ng ngay l·∫≠p t·ª©c v√¨ kh√¥ng c·∫ßn ch·ªù Auth
        window.isAuthReady = true; 
    </script>
</head>
<body class="p-4 sm:p-8 min-h-screen flex items-center justify-center">

    <div id="app" class="w-full max-w-lg bg-white rounded-3xl shadow-2xl p-6 sm:p-10 border-b-8 border-red-500">
        
        <!-- TI√äU ƒê·ªÄ CHUNG -->
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 text-center mb-2">
            üß† H·ªçc M√† Ch∆°i C√πng T√≠ Hon
        </h1>
        <p class="text-center text-sm text-red-500 font-semibold mb-6">Phi√™n b·∫£n l∆∞u tr·ªØ Supabase (Cloud)</p>

        <!-- K·∫æT QU·∫¢ V√Ä ƒêI·ªÇM S·ªê -->
        <div id="stats-display" class="flex justify-between items-center bg-red-50 p-3 rounded-xl mb-6 shadow-inner hidden">
            <div class="text-center">
                <span class="block text-2xl font-bold text-green-700" id="score">0</span>
                <span class="text-xs font-medium text-gray-600">ƒê√∫ng</span>
            </div>
            <div class="text-center">
                <span class="block text-2xl font-bold text-red-700" id="missed">0</span>
                <span class="text-xs font-medium text-gray-600">Sai</span>
            </div>
            <div class="text-center">
                <span class="block text-2xl font-bold text-gray-700" id="current-info">Ch·ªçn L·ªõp</span>
                <span class="text-xs font-medium text-gray-600">C·∫•p ƒë·ªô</span>
            </div>
        </div>
        
        <!-- 0. M√ÄN H√åNH NH·∫¨P T√äN H·ªåC SINH (UPDATED) -->
        <div id="student-name-input" class="space-y-4 mb-8">
            <h2 class="text-lg font-bold text-gray-700 text-center">Xin ch√†o! Con t√™n l√† g√¨?</h2>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="selectStudentAndGrade('Th·∫£o Huy·ªÅn', 1)" class="subject-btn w-full p-4 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl bg-pink-500 hover:bg-pink-600">
                    üëß Th·∫£o Huy·ªÅn (L·ªõp 1)
                </button>
                <button onclick="selectStudentAndGrade('H·∫±ng Nga', 2)" class="subject-btn w-full p-4 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl bg-orange-500 hover:bg-orange-600">
                    ‚≠ê H·∫±ng Nga (L·ªõp 2)
                </button>
            </div>

            <p class="text-center text-gray-500 font-semibold pt-2">Ho·∫∑c:</p>
            
            <input type="text" id="student-name-input-field" placeholder="Nh·∫≠p t√™n h·ªçc sinh kh√°c..." class="game-input w-full p-3 border-2 border-gray-300 rounded-xl outline-none transition duration-200">
            <p id="name-input-error" class="text-sm text-red-500 text-center h-4"></p>
            <button onclick="promptForGrade()" class="primary-btn w-full p-4 text-xl font-bold text-white rounded-xl shadow-lg hover:shadow-xl">
                B·∫Øt ƒê·∫ßu H·ªçc T·∫≠p
            </button>
            <button onclick="showScreen('login-area')" class="w-full text-sm font-medium text-blue-600 hover:text-blue-800 transition pt-2">
                üîë ƒêƒÉng nh·∫≠p Admin
            </button>
        </div>

        <!-- 0.5. M√ÄN H√åNH ƒêƒÇNG NH·∫¨P ADMIN -->
        <div id="login-area" class="hidden space-y-4 mb-8">
            <h2 class="text-lg font-bold text-gray-700 text-center">ƒêƒÉng nh·∫≠p Qu·∫£n tr·ªã</h2>
            <input type="text" id="admin-user" placeholder="T√™n ƒëƒÉng nh·∫≠p (admin)" value="admin" class="admin-input w-full p-3 border-2 border-gray-300 rounded-xl outline-none transition duration-200">
            <input type="password" id="admin-pass" placeholder="M·∫≠t kh·∫©u (admin)" value="admin" class="admin-input w-full p-3 border-2 border-gray-300 rounded-xl outline-none transition duration-200" onkeydown="if(event.key === 'Enter') adminLogin()">
            <button onclick="adminLogin()" class="subject-btn w-full p-3 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl">
                ƒêƒÉng Nh·∫≠p
            </button>
            <p id="login-error" class="text-sm text-red-500 text-center"></p>
            <button onclick="showScreen('student-name-input')" class="w-full text-sm font-medium text-indigo-600 hover:text-indigo-800 transition pt-2">
                Quay l·∫°i
            </button>
        </div>

        <!-- 1. CH·ªåN L·ªöP (PLAYER) (Gi·ªù ch·ªâ d√πng cho t√™n nh·∫≠p th·ªß c√¥ng) -->
        <div id="grade-selection" class="space-y-4 mb-8 hidden">
            <h2 class="text-lg font-bold text-gray-700 text-center">Con h·ªçc L·ªõp m·∫•y?</h2>
            <button onclick="selectGrade(1)" class="primary-btn w-full p-4 text-xl font-bold text-white rounded-xl shadow-lg hover:shadow-xl">
                üåü L·ªõp 1
            </button>
            <button onclick="selectGrade(2)" class="primary-btn w-full p-4 text-xl font-bold text-white rounded-xl shadow-lg hover:shadow-xl">
                üöÄ L·ªõp 2
            </button>
            <button onclick="showScreen('student-name-input')" class="w-full text-sm font-medium text-red-600 hover:text-red-800 transition pt-2">
                Quay l·∫°i Nh·∫≠p T√™n
            </button>
        </div>

        <!-- 2. CH·ªåN M√îN H·ªåC (PLAYER) -->
        <div id="subject-selection" class="hidden space-y-4 mb-8">
            <h2 class="text-lg font-bold text-gray-700 text-center">Con mu·ªën luy·ªán t·∫≠p M√¥n g√¨?</h2>
            <button onclick="selectSubject('TOAN')" class="subject-btn w-full p-3 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl">
                üßÆ To√°n H·ªçc
            </button>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <button onclick="selectSubject('SPELL')" class="subject-btn w-full p-3 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl bg-purple-600 hover:bg-purple-700">
                    üáªüá≥ Ch√≠nh T·∫£ (Ch·ªçn)
                </button>
                <button onclick="selectSubject('READ')" class="subject-btn w-full p-3 text-lg font-bold text-white rounded-xl shadow-lg hover:bg-teal-700 bg-teal-600">
                    üéß Luy·ªán ƒê·ªçc (Nghe & Ch·ªçn)
                </button>
            </div>
            <button onclick="showScreen('grade-selection')" class="w-full text-sm font-medium text-red-600 hover:text-red-800 transition pt-2">
                Quay l·∫°i Ch·ªçn L·ªõp
            </button>
        </div>
        
        <!-- 3. KHU V·ª∞C THI·∫æT L·∫¨P B√ÄI (PLAYER) -->
        <div id="setup-area" class="hidden text-center">
            <h2 class="text-xl font-bold text-gray-700 mb-4" id="setup-title"></h2>
            
            <div class="p-4 border border-indigo-200 rounded-xl mb-6 bg-indigo-50">
                <p class="text-sm text-indigo-700 font-semibold mb-2">Gi·ªõi h·∫°n: M·ªói l·∫ßn luy·ªán t·∫≠p c√≥ 30 c√¢u h·ªèi.</p>
                <div class="flex justify-center items-center gap-4">
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-600 mb-1">B√†i B·∫Øt ƒê·∫ßu:</label>
                        <!-- ƒê√É S·ª¨A: Thay input number b·∫±ng select dropdown -->
                        <select id="start-lesson" class="game-input w-full p-2 text-center border-2 rounded-lg outline-none"></select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-xs font-medium text-gray-600 mb-1">B√†i K·∫øt Th√∫c:</label>
                        <!-- ƒê√É S·ª¨A: Thay input number b·∫±ng select dropdown -->
                        <select id="end-lesson" class="game-input w-full p-2 text-center border-2 rounded-lg outline-none"></select>
                    </div>
                </div>
                <p class="text-xs text-red-500 mt-2" id="lesson-error"></p>
                <button onclick="checkLessonRange()" class="subject-btn mt-4 w-full p-2 text-md font-bold text-white rounded-xl">
                    Ki·ªÉm tra & C·∫≠p nh·∫≠t
                </button>
            </div>

            <button onclick="startLessonSet()" class="primary-btn w-full p-3 text-xl font-bold text-white rounded-xl shadow-lg hover:shadow-xl">
                ‚ñ∂Ô∏è B·∫Øt ƒê·∫ßu Luy·ªán T·∫≠p (30 c√¢u)
            </button>
            <button onclick="showScreen('subject-selection')" class="w-full text-sm font-medium text-red-600 hover:text-red-800 transition pt-3">
                Quay l·∫°i Ch·ªçn M√¥n
            </button>
        </div>

        <!-- 4. KHU V·ª∞C CH∆†I GAME (PLAYER) -->
        <div id="game-area" class="hidden text-center">
            
            <div id="feedback" class="h-8 mb-4 text-center font-bold text-lg"></div>

            <!-- HI·ªÇN TH·ªä C√ÇU H·ªéI -->
            <div class="bg-yellow-100 p-6 rounded-2xl mb-6 shadow-md border-2 border-dashed border-red-300 min-h-[150px] flex flex-col justify-center">
                <p class="text-2xl sm:text-3xl font-black text-gray-800 mb-2" id="question-text">
                    S·∫µn s√†ng...
                </p>
                <div id="image-hint" class="text-base font-medium text-gray-600 my-2"></div>
                
                <!-- N√öT CHO PH√âP ƒê·ªåC -->
                <div id="reading-controls" class="hidden mt-4">
                    <button id="read-button" onclick="playAudio()" class="read-btn p-3 text-lg font-bold text-white rounded-xl shadow-md disabled:bg-gray-400">
                        üîä ƒê·ªçc L·∫°i
                    </button>
                </div>
            </div>
            
            <!-- KHU V·ª∞C TR·∫¢ L·ªúI B·∫∞NG CH·ªåN N√öT (To√°n & Ti·∫øng Vi·ªát) -->
            <div id="selection-controls" class="hidden grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <!-- N√∫t ƒë√°p √°n s·∫Ω ƒë∆∞·ª£c ch√®n ·ªü ƒë√¢y b·∫±ng JavaScript -->
            </div>

            <!-- HI·ªÇN TH·ªä TR·∫†NG TH√ÅI B√ÄI THI -->
            <p id="lesson-progress" class="text-sm font-bold text-indigo-600 mb-4">
                C√¢u: 1 / 30
            </p>

            <button onclick="endLessonSet()" class="w-full text-sm font-medium text-red-600 hover:text-red-800 transition">
                D·ª´ng Luy·ªán T·∫≠p & Quay l·∫°i Ch·ªçn B√†i
            </button>
        </div>
        
        <!-- 5. M√ÄN H√åNH ADMIN -->
        <div id="admin-panel" class="hidden space-y-4 mb-8">
            <h2 class="text-2xl font-bold text-blue-700 text-center">B·∫£ng Qu·∫£n Tr·ªã N·ªôi Dung</h2>
            <p class="text-xs text-center text-red-600 font-semibold mb-3">L∆∞u tr·ªØ b·∫±ng Supabase (y√™u c·∫ßu c·∫•u h√¨nh)</p>

            <!-- 1. T·∫†O C·∫§U TR√öC B√ÄI H·ªåC M·ªöI -->
            <div class="bg-indigo-50 p-4 rounded-xl shadow-inner">
                <h3 class="admin-section-header text-indigo-700 border-indigo-300 mt-0">1. T·∫°o C·∫•u Tr√∫c B√†i H·ªçc M·ªõi</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">L·ªõp</label>
                        <select id="new-lesson-grade" class="admin-input w-full p-2 border-2 rounded-lg">
                            <option value="1">L·ªõp 1</option>
                            <option value="2">L·ªõp 2</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">M√¥n</label>
                        <select id="new-lesson-subject" class="admin-input w-full p-2 border-2 rounded-lg">
                            <option value="TOAN">To√°n H·ªçc</option>
                            <option value="SPELL">Ch√≠nh T·∫£</option>
                            <option value="READ">Luy·ªán ƒê·ªçc</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">S·ªë B√†i H·ªçc</label>
                    <input type="number" id="new-lesson-number" class="admin-input w-full p-2 border-2 rounded-lg" placeholder="VD: 3">
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">T√™n B√†i H·ªçc (VD: Ph√©p c·ªông c√≥ nh·ªõ)</label>
                    <input type="text" id="new-lesson-name-input" class="admin-input w-full p-2 border-2 rounded-lg" placeholder="Nh·∫≠p t√™n b√†i h·ªçc">
                </div>
                
                <button onclick="createNewLessonStructure()" class="subject-btn w-full p-3 text-white font-bold rounded-xl flex items-center justify-center">
                    ‚ûï T·∫°o C·∫•u Tr√∫c B√†i H·ªçc
                </button>
            </div>


            <!-- 2. T·∫†O C√ÇU H·ªéI B·∫∞NG AI (V·∫™N GI·ªÆ NGUY√äN) -->
            <div class="p-4 border border-blue-400 rounded-xl space-y-3">
                <h3 class="admin-section-header text-blue-700 border-blue-300">2. T·∫°o C√¢u H·ªèi B·∫±ng AI (Gemini)</h3>
                <div class="bg-yellow-50 p-3 rounded-lg text-sm text-yellow-800 font-medium">
                    <span id="ai-target-info">Vui l√≤ng ch·ªçn B√†i H·ªçc ·ªü m·ª•c 3 tr∆∞·ªõc khi t·∫°o c√¢u h·ªèi.</span>
                </div>
                
                <textarea id="ai-prompt" rows="3" placeholder="V√≠ d·ª•: T·∫°o 30 ph√©p tr·ª´ c√≥ nh·ªõ trong ph·∫°m vi 100. Ho·∫∑c: T·∫°o 30 c√¢u ch√≠nh t·∫£ ph√¢n bi·ªát s/x." class="admin-input w-full p-2 border-2 rounded-lg"></textarea>
                <button onclick="generateAndSaveQuestions()" class="admin-nav-btn w-full p-3 text-white font-bold rounded-xl flex items-center justify-center disabled:bg-gray-400" id="ai-generate-btn">
                    <span id="ai-generate-text">‚ú® T·∫°o & L∆∞u 30 C√¢u H·ªèi M·ªõi</span>
                    <svg id="ai-loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
                <p id="ai-result-preview" class="text-xs text-gray-600 whitespace-pre-wrap"></p>
            </div>
            
            <!-- 3. QU·∫¢N L√ù N·ªòI DUNG HI·ªÜN C√ì -->
             <div class="bg-blue-50 p-4 rounded-xl shadow-inner">
                <h3 class="admin-section-header text-blue-700 border-blue-300">3. Qu·∫£n L√Ω N·ªôi Dung Hi·ªán C√≥</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">L·ªõp</label>
                        <select id="admin-grade" class="admin-input w-full p-2 border-2 rounded-lg" onchange="loadLessonOptions()">
                            <option value="1">L·ªõp 1</option>
                            <option value="2">L·ªõp 2</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">M√¥n</label>
                        <select id="admin-subject" onchange="loadLessonOptions()" class="admin-input w-full p-2 border-2 rounded-lg">
                            <option value="TOAN">To√°n H·ªçc</option>
                            <option value="SPELL">Ch√≠nh T·∫£</option>
                            <option value="READ">Luy·ªán ƒê·ªçc</option>
                        </select>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">B√†i H·ªçc</label>
                    <div class="flex gap-2">
                        <select id="admin-lesson" class="admin-input flex-grow p-2 border-2 rounded-lg" onchange="previewLesson()">
                        </select>
                    </div>
                </div>

                <div id="lesson-name-control" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700">T√™n B√†i H·ªçc:</label>
                    <div class="flex gap-2">
                        <input type="text" id="admin-lesson-name" class="admin-input flex-grow p-2 border-2 rounded-lg" placeholder="Nh·∫≠p t√™n b√†i h·ªçc (VD: Ph√©p c·ªông c√≥ nh·ªõ)">
                        <button onclick="updateLessonName()" class="admin-nav-btn text-white p-2 rounded-lg text-sm font-bold">L∆∞u T√™n</button>
                    </div>
                </div>
                
                <p id="lesson-preview" class="text-sm font-medium text-gray-700">T·ªïng s·ªë c√¢u trong b√†i n√†y: 0</p>
                <button onclick="confirmDeleteLesson()" class="danger-btn w-full p-3 text-white font-bold rounded-xl mt-4">
                    ‚ö†Ô∏è X√≥a TO√ÄN B·ªò B√†i H·ªçc n√†y
                </button>

            </div>

            <!-- 4. L·ªäCH S·ª¨ L√ÄM B√ÄI -->
            <div id="history-management" class="p-4 border border-green-400 rounded-xl space-y-3 bg-green-50">
                <h3 class="admin-section-header text-green-700 border-green-300">4. L·ªãch S·ª≠ L√†m B√†i C·ªßa H·ªçc Sinh</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">L·ªçc theo T√™n HS:</label>
                        <select id="history-filter-name" class="admin-input w-full p-2 border-2 rounded-lg" onchange="displayHistory()"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">L·ªçc theo M√¥n:</label>
                        <select id="history-filter-subject" class="admin-input w-full p-2 border-2 rounded-lg" onchange="displayHistory()">
                            <option value="ALL">T·∫•t c·∫£</option>
                            <option value="TOAN">To√°n H·ªçc</option>
                            <option value="SPELL">Ch√≠nh T·∫£</option>
                            <option value="READ">Luy·ªán ƒê·ªçc</option>
                        </select>
                    </div>
                </div>
                <div id="history-list" class="space-y-4 pt-4 text-center">
                    <p class="text-sm text-gray-600">L·ªãch s·ª≠ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y sau khi h·ªçc sinh l√†m b√†i.</p>
                </div>
            </div>

            <!-- 5. QU·∫¢N L√ù API KEYS GEMINI (NEW) -->
            <div class="p-4 border border-purple-400 rounded-xl space-y-3 bg-purple-50">
                <h3 class="admin-section-header text-purple-700 border-purple-300">5. Qu·∫£n L√Ω API Keys Gemini</h3>
                <p class="text-xs text-gray-700">Th√™m nhi·ªÅu keys ƒë·ªÉ c√≥ c∆° ch·∫ø t·ª± ƒë·ªông chuy·ªÉn ƒë·ªïi khi m·ªôt key b·ªã l·ªói ho·∫∑c qu√° t·∫£i.</p>
                
                <div class="flex gap-2 mb-2">
                    <input type="text" id="gemini-key-input" class="admin-input flex-grow p-2 border-2 rounded-lg" placeholder="Nh·∫≠p API Key Gemini m·ªõi...">
                    <button onclick="addGeminiKey()" class="admin-nav-btn text-white p-2 rounded-lg text-sm font-bold bg-purple-600 hover:bg-purple-700">Th√™m Key</button>
                </div>

                <div id="gemini-keys-list" class="space-y-2 max-h-48 overflow-y-auto p-2 bg-purple-100 rounded-lg border border-purple-200">
                    <!-- Danh s√°ch keys s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                </div>
            </div>
            
            <p id="admin-status" class="text-sm text-green-600 font-semibold text-center pt-4"></p>

            <button onclick="adminLogout()" class="w-full text-sm font-medium text-red-600 hover:text-red-800 transition pt-3">
                ƒêƒÉng Xu·∫•t & Quay l·∫°i
            </button>
        </div>

    </div>

    <script id="script_app_logic">
        // --- SUPABASE CONFIGURATION (THAY TH·∫æ CH·ªñ N√ÄY B·∫∞NG TH√îNG TIN TH·∫¨T C·ª¶A B·∫†N) ---
        const SUPABASE_URL = 'https://vuzbzjieuqghneipkprg.supabase.co'; // ƒê√£ d√°n URL c·ªßa b·∫°n
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ1emJ6amlldXFnaG5laXBrcHJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwNTUwMDIsImV4cCI6MjA3NDYzMTAwMn0.xsPbKPJK74RM6MmqOBjjnyon6z4vVo8vrWmzFFvx4xc'; // ƒê√£ d√°n Public Key c·ªßa b·∫°n

        const supabase = SUPABASE_URL && SUPABASE_ANON_KEY && window.supabase
                            ? window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY) // S·ª≠a l·ªói: Truy c·∫≠p qua window.supabase
                            : null;

        if (!supabase) {
             console.error("Vui l√≤ng c·∫•u h√¨nh SUPABASE_URL v√† SUPABASE_ANON_KEY.");
             // ƒê√£ lo·∫°i b·ªè alert() theo quy t·∫Øc
        }
        
        // --- BI·∫æN TO√ÄN C·ª§C ---
        const TOTAL_QUESTIONS = 30;
        let score = 0;
        let missed = 0;
        let currentGrade = 0;
        let currentSubject = '';
        let currentAnswer = null; 
        let currentMode = ''; 
        let currentTextToRead = ''; 
        let studentName = ''; 
        let incorrectQuestions = []; 
        
        let lessonStart = 1;
        let lessonEnd = 5;
        let lessonsAvailable = {}; 
        let learningHistory = []; 
        
        let questionCount = 0; 
        let isLessonSetMode = false;
        let lessonSetQuestions = []; 
        let currentQuestionIndex = 0; 

        // BI·∫æN M·ªöI CHO GEMINI
        let geminiKeys = [];
        let currentKeyIndex = 0;
        
        // --- ELEMENTS ---
        const scoreEl = document.getElementById('score');
        const missedEl = document.getElementById('missed');
        const currentInfoEl = document.getElementById('current-info');
        const questionTextEl = document.getElementById('question-text');
        const feedbackEl = document.getElementById('feedback');
        const imageHintEl = document.getElementById('image-hint');
        const readingControlsEl = document.getElementById('reading-controls');
        const readButtonEl = document.getElementById('read-button');
        const statsDisplayEl = document.getElementById('stats-display');
        
        const selectionControlsEl = document.getElementById('selection-controls'); 

        const studentNameInputField = document.getElementById('student-name-input-field');
        const studentNameInputScreen = document.getElementById('student-name-input');
        const nameInputErrorEl = document.getElementById('name-input-error');

        const loginAreaEl = document.getElementById('login-area');
        const gradeSelectionEl = document.getElementById('grade-selection');
        const subjectSelectionEl = document.getElementById('subject-selection');
        const setupAreaEl = document.getElementById('setup-area');
        const gameAreaEl = document.getElementById('game-area');

        const setupTitleEl = document.getElementById('setup-title');
        // ƒê√£ ƒë·ªïi t·ª´ input sang select, l·∫•y l·∫°i tham chi·∫øu
        const startLessonEl = document.getElementById('start-lesson'); 
        const endLessonEl = document.getElementById('end-lesson'); 
        const lessonErrorEl = document.getElementById('lesson-error');
        const lessonProgressEl = document.getElementById('lesson-progress');
        
        // Admin Elements
        const adminPanelEl = document.getElementById('admin-panel');
        const adminGradeEl = document.getElementById('admin-grade');
        const adminSubjectEl = document.getElementById('admin-subject');
        const adminLessonEl = document.getElementById('admin-lesson');
        const adminLessonNameEl = document.getElementById('admin-lesson-name');
        const lessonNameControlEl = document.getElementById('lesson-name-control');
        const lessonPreviewEl = document.getElementById('lesson-preview');
        const adminStatusEl = document.getElementById('admin-status');
        
        const aiPromptEl = document.getElementById('ai-prompt');
        const aiGenerateBtn = document.getElementById('ai-generate-btn');
        const aiGenerateTextEl = document.getElementById('ai-generate-text');
        const aiLoadingSpinnerEl = document.getElementById('ai-loading-spinner');
        const aiResultPreviewEl = document.getElementById('ai-result-preview');
        const aiTargetInfoEl = document.getElementById('ai-target-info');

        const newLessonGradeEl = document.getElementById('new-lesson-grade');
        const newLessonSubjectEl = document.getElementById('new-lesson-subject');
        const newLessonNumberEl = document.getElementById('new-lesson-number');
        const newLessonNameInputEl = document.getElementById('new-lesson-name-input');
        
        const historyFilterNameEl = document.getElementById('history-filter-name');
        const historyFilterSubjectEl = document.getElementById('history-filter-subject');
        const historyListEl = document.getElementById('history-list');
        
        // NEW GEMINI ADMIN ELEMENTS
        const geminiKeyInputEl = document.getElementById('gemini-key-input');
        const geminiKeysListEl = document.getElementById('gemini-keys-list');

        // --- TTS (CHUY·ªÇN VƒÇN B·∫¢N TH√ÄNH GI·ªåNG N√ìI C·ª¶A TR√åNH DUY·ªÜT) ---
        
        function speakText(text) {
            if (!text) return; 
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel(); 
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'vi-VN'; 
                utterance.rate = 0.7; // FIX: Gi·∫£m t·ªëc ƒë·ªô ƒë·ªÉ ƒë·ªçc chu·∫©n v√† r√µ h∆°n
                utterance.pitch = 1.1; // FIX: TƒÉng cao ƒë·ªô nh·∫π ƒë·ªÉ nghe to v√† r√µ h∆°n
                
                window.speechSynthesis.speak(utterance);
                
                readButtonEl.disabled = true;
                utterance.onend = () => {
                    readButtonEl.disabled = false;
                };
            } else {
                feedbackEl.textContent = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªçc t·ª± ƒë·ªông.";
                feedbackEl.className = 'h-8 mb-4 text-center font-bold text-lg text-red-600';
            }
        }

        function playAudio() {
            if (currentMode === 'READ' || currentMode === 'SPELL' || currentMode === 'MATH') {
                speakText(currentTextToRead); 
            }
        }

        // --- CHUY·ªÇN M√ÄN H√åNH & CH·ªåN M√îN ---
        function showScreen(screenId) {
            // Hide all screens
            const screens = [studentNameInputScreen, loginAreaEl, gradeSelectionEl, subjectSelectionEl, setupAreaEl, gameAreaEl, adminPanelEl];
            screens.forEach(screen => screen.classList.add('hidden'));
            
            // Show target screen
            document.getElementById(screenId).classList.remove('hidden');
            
            // Hi·ªÉn th·ªã th·ªëng k√™ ch·ªâ trong ch·∫ø ƒë·ªô Player
            if (screenId === 'grade-selection' || screenId === 'subject-selection' || screenId === 'setup-area' || screenId === 'game-area') {
                statsDisplayEl.classList.remove('hidden');
            } else {
                statsDisplayEl.classList.add('hidden');
            }
            
            // NEW: Load history and Gemini keys on Admin Panel entry
            if (screenId === 'admin-panel') {
                loadGeminiKeys(); // T·∫£i API keys
                loadHistoryNames(); // T·∫£i l·ªãch s·ª≠ & hi·ªÉn th·ªã
            }
        }
        
        function selectStudentAndGrade(name, grade) {
            studentName = name;
            currentGrade = grade;
            currentInfoEl.textContent = `L·ªõp ${grade} | ${studentName}`;
            score = 0;
            missed = 0;
            updateScoreDisplay();
            showScreen('subject-selection');
        }

        function promptForGrade() {
            studentName = studentNameInputField.value.trim();
             if (!studentName) {
                 nameInputErrorEl.textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n h·ªçc sinh.";
                 return;
             }
             nameInputErrorEl.textContent = "";
             currentInfoEl.textContent = `Ch√†o ${studentName}!`;
             showScreen('grade-selection'); 
        }

        // --- ADMIN LOGIN LOGIC ---
        function adminLogin() {
            const user = document.getElementById('admin-user').value;
            const pass = document.getElementById('admin-pass').value;
            const errorEl = document.getElementById('login-error');

            if (user === 'admin' && pass === 'admin') {
                errorEl.textContent = 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!';
                errorEl.className = 'text-sm text-green-600 text-center';
                showScreen('admin-panel');
                loadLessonOptions();
            } else {
                errorEl.textContent = 'Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u. Vui l√≤ng th·ª≠ l·∫°i.';
                errorEl.className = 'text-sm text-red-500 text-center';
            }
        }
        
        function adminLogout() {
             adminStatusEl.textContent = '';
             showScreen('student-name-input'); 
        }

        // --- PLAYER MODE LOGIC ---
        function selectGrade(grade) {
            currentGrade = grade;
            currentInfoEl.textContent = `L·ªõp ${grade} | ${studentName}`; 
            score = 0;
            missed = 0;
            updateScoreDisplay();
            showScreen('subject-selection');
        }

        function selectSubject(subject) {
            currentSubject = subject;
            let subjectName = '';
            if (subject === 'TOAN') { subjectName = 'To√°n H·ªçc'; setupTitleEl.textContent = 'Thi·∫øt L·∫≠p B√†i T·∫≠p To√°n'; }
            else if (subject === 'SPELL') { subjectName = 'Ch√≠nh T·∫£ (Ch·ªçn)'; setupTitleEl.textContent = 'Thi·∫øt L·∫≠p B√†i T·∫≠p Ch√≠nh T·∫£'; }
            else if (subject === 'READ') { subjectName = 'Luy·ªán ƒê·ªçc (Nghe & Ch·ªçn)'; setupTitleEl.textContent = 'Thi·∫øt L·∫≠p B√†i T·∫≠p Luy·ªán ƒê·ªçc'; }
            
            currentInfoEl.textContent = `${subjectName} (${currentGrade}) | ${studentName}`;
            lessonErrorEl.textContent = '';
            
            // X√≥a gi√° tr·ªã c≈© trong input (gi·ªù l√† select)
            startLessonEl.value = 1; 
            endLessonEl.value = 5;

            checkLessonRange(false); 
            showScreen('setup-area');
        }

        async function checkLessonRange(showFeedback = true) {
             const grade = currentGrade;
             const subject = currentSubject;
             
             let maxLesson = 0;
             await fetchLessonsFromSupabase(); 
             
             if (lessonsAvailable[grade] && lessonsAvailable[grade][subject]) {
                 if (lessonsAvailable[grade][subject].length > 0) {
                     maxLesson = Math.max(...lessonsAvailable[grade][subject].map(l => l.lessonNumber));
                 }
             }

             // FIX 1: C·∫≠p nh·∫≠t dropdown select v·ªõi c√°c s·ªë b√†i h·ªçc
             startLessonEl.innerHTML = '';
             endLessonEl.innerHTML = '';
             let maxNumber = maxLesson > 0 ? maxLesson : 1;
             
             for (let i = 1; i <= maxNumber; i++) {
                 const startOption = document.createElement('option');
                 startOption.value = i;
                 startOption.textContent = `B√†i ${i}`;
                 startLessonEl.appendChild(startOption);

                 const endOption = document.createElement('option');
                 endOption.value = i;
                 endOption.textContent = `B√†i ${i}`;
                 endLessonEl.appendChild(endOption);
             }
             
             if (maxLesson > 0) {
                 // ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh cho dropdown
                 startLessonEl.value = 1;
                 endLessonEl.value = maxLesson;
                 
                 if (showFeedback) {
                     lessonErrorEl.className = "text-xs text-green-600 mt-2";
                     lessonErrorEl.textContent = `‚úÖ ƒê√£ t√¨m th·∫•y t·ªëi ƒëa B√†i ${maxLesson}.`;
                 }
             } else {
                 lessonErrorEl.className = "text-xs text-red-500 mt-2";
                 lessonErrorEl.textContent = "‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y b√†i h·ªçc n√†o. Vui l√≤ng t·∫°o b√†i m·ªõi trong ch·∫ø ƒë·ªô Admin.";
                 // ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh khi kh√¥ng c√≥ b√†i h·ªçc
                 startLessonEl.value = 1;
                 endLessonEl.value = 1;
             }
        }

        async function startLessonSet() {
            // L·∫•y gi√° tr·ªã t·ª´ select (ƒë√£ l√† chu·ªói s·ªë)
            lessonStart = parseInt(startLessonEl.value);
            lessonEnd = parseInt(endLessonEl.value);

            if (isNaN(lessonStart) || isNaN(lessonEnd) || lessonStart < 1 || lessonEnd < 1 || lessonStart > lessonEnd) {
                lessonErrorEl.textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë√∫ng ph·∫°m vi B√†i B·∫Øt ƒê·∫ßu v√† B√†i K·∫øt Th√∫c.";
                return;
            }

            isLessonSetMode = true;
            questionCount = 0;
            score = 0;
            missed = 0;
            incorrectQuestions = []; 
            updateScoreDisplay();
            showScreen('game-area');
            
            await loadAndShuffleQuestions();
            currentQuestionIndex = 0;
            generateQuestion();
        }

        async function loadAndShuffleQuestions() {
            let allQuestions = [];
            
            await fetchLessonsFromSupabase(); 

            const lessons = lessonsAvailable[currentGrade][currentSubject];
            
            for (let i = 0; i < lessons.length; i++) {
                const lesson = lessons[i];
                if (lesson.lessonNumber >= lessonStart && lesson.lessonNumber <= lessonEnd) {
                    if (lesson.questions_data) {
                        lesson.questions_data.forEach(q => {
                            allQuestions.push({...q, lessonNumber: lesson.lessonNumber, lessonName: lesson.lessonName}); 
                        });
                    }
                }
            }
            
            if (allQuestions.length === 0) {
                 questionTextEl.textContent = "Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi trong ph·∫°m vi n√†y. Vui l√≤ng ki·ªÉm tra Admin.";
                 currentTextToRead = "Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi trong ph·∫°m vi n√†y. Vui l√≤ng ki·ªÉm tra Admin.";
                 selectionControlsEl.innerHTML = '';
                 currentAnswer = null;
                 return;
            }

            allQuestions.sort(() => Math.random() - 0.5);
            
            lessonSetQuestions = allQuestions.slice(0, TOTAL_QUESTIONS);
            if (lessonSetQuestions.length < TOTAL_QUESTIONS) {
                console.warn(`Ch·ªâ t√¨m th·∫•y ${lessonSetQuestions.length} c√¢u h·ªèi.`);
            }
        }

        function endGame() {
            isLessonSetMode = false;
            showScreen('grade-selection');
        }
        
        async function endLessonSet() { 
            let total = score + missed;
            let accuracy = total > 0 ? (score / total * 100).toFixed(1) : 0;
            
            questionTextEl.textContent = `üéâ HO√ÄN TH√ÄNH (${total} c√¢u)`;
            imageHintEl.textContent = `‚úÖ ƒê√∫ng: ${score}, ‚ùå Sai: ${missed} (${accuracy}%)`;
            readingControlsEl.classList.add('hidden');
            selectionControlsEl.classList.add('hidden');
            
            if (total > 0 && studentName) {
                const historyRecord = {
                    student_name: studentName, // S·ª≠ d·ª•ng student_name cho Supabase
                    grade: currentGrade,
                    subject: currentSubject,
                    score: score,
                    missed: missed,
                    total: total,
                    incorrect_questions: incorrectQuestions, // S·ª≠ d·ª•ng incorrect_questions cho Supabase
                    lesson_range: `${lessonStart} - ${lessonEnd}`
                };
                await saveHistoryRecord(historyRecord); // Ghi l·ªãch s·ª≠ Supabase
            }
            
            incorrectQuestions = [];
            isLessonSetMode = false;
            
            setTimeout(() => {
                showScreen('setup-area');
            }, 3000); 
        }

        // --- LOGIC CH∆†I GAME & H·ªñ TR·ª¢ NG√î√îN NG·ªÆ (Kh√¥ng ƒë·ªïi) ---

        function updateScoreDisplay() {
            scoreEl.textContent = score;
            missedEl.textContent = missed;
            if (isLessonSetMode) {
                questionCount = currentQuestionIndex + 1;
                lessonProgressEl.textContent = `C√¢u: ${questionCount} / ${lessonSetQuestions.length}`;
            } else {
                 lessonProgressEl.textContent = `C√¢u: - / ${TOTAL_QUESTIONS}`;
            }
        }

        function generateQuestion() {
            if (isLessonSetMode && currentQuestionIndex >= lessonSetQuestions.length) {
                endLessonSet();
                return;
            }

            const qData = lessonSetQuestions[currentQuestionIndex];
            currentMode = qData.type.startsWith('MATH') ? 'MATH' : qData.type;
            
            readingControlsEl.classList.remove('hidden'); 
            selectionControlsEl.classList.remove('hidden'); 
            
            if (currentMode === 'MATH' && qData.type === 'MATH_OP') {
                const match = qData.q.match(/(\d+)\s*([+\-x:])\s*(\d+)/);
                if (match) {
                    currentTextToRead = formatMathQuestionForSpeech(parseInt(match[1]), parseInt(match[3]), match[2]);
                } else {
                    currentTextToRead = qData.q;
                }
                questionTextEl.textContent = qData.q;
                imageHintEl.textContent = `(B√†i ${qData.lessonNumber}: Ph√©p t√≠nh)`;
            } else if (currentMode === 'READ') {
                questionTextEl.textContent = `üëÇ Nghe k·ªπ v√† CH·ªåN c√¢u/t·ª´ b·∫°n v·ª´a nghe:`; 
                currentTextToRead = qData.text || qData.q;
                imageHintEl.textContent = `(B√†i ${qData.lessonNumber}: Luy·ªán Nghe)`;
            }
            else {
                questionTextEl.textContent = qData.q;
                currentTextToRead = qData.text || qData.q;
                imageHintEl.textContent = `(B√†i ${qData.lessonNumber}: ${qData.type})`;
            }
            
            currentAnswer = qData.a; 
            setupSelectionButtons(qData.options);
            
            setTimeout(() => speakText(currentTextToRead), 500);
        }
        
        function numberToVietnamese(n) {
            if (n < 0 || n > 100) return String(n);
            const units = ["", "m·ªôt", "hai", "ba", "b·ªën", "nƒÉm", "s√°u", "b·∫£y", "t√°m", "ch√≠n"];
            const tens = ["", "m∆∞·ªùi", "hai m∆∞∆°i", "ba m∆∞∆°i", "b·ªën m∆∞∆°i", "nƒÉm m∆∞∆°i", "s√°u m∆∞∆°i", "b·∫£y m∆∞∆°i", "t√°m m∆∞∆°i", "ch√≠n m∆∞∆°i"];
            if (n === 0) return "kh√¥ng";
            if (n <= 9) return units[n];
            if (n === 10) return "m∆∞·ªùi";
            const t = Math.floor(n / 10);
            const u = n % 10;
            let result = tens[t];

            if (t === 1 && u > 0) {
                if (u === 1) result = "m∆∞·ªùi m·ªôt";
                else if (u === 4) result = "m∆∞·ªùi b·ªën"; 
                else if (u === 5) result = "m∆∞·ªùi lƒÉm"; 
                else result = `m∆∞·ªùi ${units[u]}`;
            } else if (t > 1 && u > 0) {
                if (u === 1) result = `${tens[t]} m·ªët`; 
                else if (u === 4) result = `${tens[t]} t∆∞`; 
                else if (u === 5) result = `${tens[t]} lƒÉm`; 
                else result = `${tens[t]} ${units[u]}`;
            } else if (u === 0 && t > 1) {
                result = tens[t];
            }
            if (n === 100) return "m·ªôt trƒÉm";
            return result.trim();
        }

        function formatMathQuestionForSpeech(a, b, operator) {
            const aText = numberToVietnamese(a);
            const bText = numberToVietnamese(b);
            let opText = '';
            
            switch (operator) {
                case '+': opText = 'c·ªông'; break;
                case '-': opText = 'tr·ª´'; break;
                case 'x': opText = 'nh√¢n'; break;
                case ':': opText = 'chia'; break;
                default: opText = operator;
            }
            return `${aText} ${opText} ${bText} b·∫±ng bao nhi√™u`;
        }

        function setupSelectionButtons(options) {
            selectionControlsEl.classList.remove('hidden');
            selectionControlsEl.innerHTML = '';
            
            const shuffledOptions = [...options].sort(() => 0.5 - Math.random()); 
            
            if (currentSubject === 'TOAN' || currentGrade === 1) {
                 selectionControlsEl.className = 'grid grid-cols-2 gap-4 mb-6'; 
            } else {
                 selectionControlsEl.className = 'grid grid-cols-1 gap-4 mb-6';
            }

            shuffledOptions.forEach(option => {
                const button = document.createElement('button');
                button.textContent = option;
                button.className = 'select-btn p-3 text-lg font-bold text-white rounded-xl shadow-lg hover:shadow-xl w-full';
                button.onclick = () => checkAnswer(option); 
                selectionControlsEl.appendChild(button);
            });
        }
        
        function checkAnswer(selectedOption) {
            const currentQData = lessonSetQuestions[currentQuestionIndex];
            let userAnswer = String(selectedOption).toLowerCase().trim().replace(/[\.,!?'"']/g, ''); 
            
            if (userAnswer === currentAnswer.toLowerCase().trim().replace(/[\.,!?'"']/g, '')) {
                score++;
                feedbackEl.textContent = "ü•≥ ƒê√∫ng r·ªìi! Gi·ªèi qu√°!";
                feedbackEl.className = 'h-8 mb-4 text-center font-bold text-lg text-green-600 animate-pulse';
            } else {
                missed++;
                feedbackEl.textContent = `ü•∫ Sai r·ªìi! ƒê√°p √°n ƒë√∫ng l√†: ${currentAnswer}`;
                feedbackEl.className = 'h-8 mb-4 text-center font-bold text-lg text-red-600';
                
                incorrectQuestions.push({
                    q: currentQData.q,
                    a: currentQData.a,
                    user_answer: selectedOption,
                    type: currentQData.type,
                    lesson: currentQData.lessonNumber,
                    lessonName: currentQData.lessonName 
                });
            }

            updateScoreDisplay();
            currentQuestionIndex++;
            
            setTimeout(() => {
                feedbackEl.textContent = "";
                generateQuestion();
            }, 1200); 
        }
        
        // --- SUPABASE & ADMIN LOGIC ---
        
        // NEW: Gemini Key Management Functions
        async function loadGeminiKeys() {
            if (!supabase) return;

            try {
                const { data, error } = await supabase
                    .from('config')
                    .select('gemini_keys')
                    .eq('id', 1)
                    .maybeSingle();

                if (error && error.code !== 'PGRST116') throw error; // PGRST116: no rows found

                geminiKeys = data?.gemini_keys || [];
                renderGeminiKeys();
                adminStatusEl.textContent = `‚úÖ ƒê√£ t·∫£i ${geminiKeys.length} API key Gemini.`;

            } catch (e) {
                console.error("L·ªói t·∫£i API keys:", e);
                adminStatusEl.textContent = `L·ªñI SUPABASE: Kh√¥ng t·∫£i ƒë∆∞·ª£c API keys (${e.message}). Vui l√≤ng ki·ªÉm tra b·∫£ng 'config'.`;
            }
        }

        async function saveGeminiKeys(keys) {
            if (!supabase) return;

            try {
                const { error } = await supabase
                    .from('config')
                    .upsert({ id: 1, gemini_keys: keys }, { onConflict: 'id' });

                if (error) throw error;
                
                geminiKeys = keys;
                renderGeminiKeys();
                adminStatusEl.textContent = `‚úÖ ƒê√£ l∆∞u ${keys.length} API key Gemini m·ªõi.`;

            } catch (e) {
                console.error("L·ªói l∆∞u API keys:", e);
                adminStatusEl.textContent = `L·ªñI SUPABASE: Kh√¥ng l∆∞u ƒë∆∞·ª£c API keys (${e.message}).`;
            }
        }

        function renderGeminiKeys() {
            geminiKeysListEl.innerHTML = '';
            if (geminiKeys.length === 0) {
                geminiKeysListEl.innerHTML = '<p class="text-sm text-gray-500">Ch∆∞a c√≥ API key n√†o ƒë∆∞·ª£c l∆∞u. AI s·∫Ω kh√¥ng ho·∫°t ƒë·ªông.</p>';
                aiGenerateBtn.disabled = true;
                return;
            }

            aiGenerateBtn.disabled = false;
            geminiKeys.forEach((key, index) => {
                const keyDisplay = key.substring(0, 4) + '... (Length: ' + key.length + ')';
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 bg-white rounded-lg border border-gray-200';
                item.innerHTML = `
                    <span class="font-mono text-xs text-gray-700">${index + 1}. ${keyDisplay}</span>
                    <button onclick="deleteGeminiKey(${index})" class="danger-btn px-2 py-1 text-xs text-white rounded-md hover:bg-red-700">X√≥a</button>
                `;
                geminiKeysListEl.appendChild(item);
            });
        }

        function addGeminiKey() {
            const newKey = geminiKeyInputEl.value.trim();
            if (newKey.length < 20) {
                adminStatusEl.textContent = "‚ö†Ô∏è API Key qu√° ng·∫Øn. Vui l√≤ng ki·ªÉm tra l·∫°i.";
                return;
            }
            if (geminiKeys.includes(newKey)) {
                adminStatusEl.textContent = "‚ö†Ô∏è Key n√†y ƒë√£ ƒë∆∞·ª£c th√™m.";
                return;
            }
            const updatedKeys = [...geminiKeys, newKey];
            geminiKeyInputEl.value = '';
            saveGeminiKeys(updatedKeys);
        }

        function deleteGeminiKey(index) {
            if (index >= 0 && index < geminiKeys.length) {
                if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a API Key s·ªë ${index + 1} kh√¥ng?`)) {
                    const updatedKeys = geminiKeys.filter((_, i) => i !== index);
                    saveGeminiKeys(updatedKeys);
                }
            }
        }
        
        // NEW: Fetch all lessons from Supabase and format for lessonsAvailable structure
        async function fetchLessonsFromSupabase() {
             if (!supabase) return;

             const { data, error } = await supabase
                 .from('lessons')
                 .select('id, grade, subject, lesson_number, lesson_name, num_questions, questions_data');
             
             if (error) {
                 console.error('L·ªói t·∫£i b√†i h·ªçc t·ª´ Supabase:', error);
                 adminStatusEl.textContent = `L·ªñI SUPABASE: Kh√¥ng t·∫£i ƒë∆∞·ª£c b√†i h·ªçc (${error.message})`;
                 return;
             }
             
             // Reset structure
             lessonsAvailable = { 1: { TOAN: [], SPELL: [], READ: [] }, 2: { TOAN: [], SPELL: [], READ: [] } };

             data.forEach(lesson => {
                 const grade = lesson.grade;
                 const subject = lesson.subject;

                 if (lessonsAvailable[grade] && lessonsAvailable[grade][subject]) {
                     lessonsAvailable[grade][subject].push({
                         id: lesson.id,
                         grade: lesson.grade,
                         subject: lesson.subject,
                         lessonNumber: lesson.lesson_number,
                         lessonName: lesson.lesson_name,
                         numQuestions: lesson.num_questions,
                         questions_data: lesson.questions_data,
                     });
                 }
             });
             
             // S·∫Øp x·∫øp
             for (let g of [1, 2]) {
                 for (let s of ['TOAN', 'SPELL', 'READ']) {
                     if (lessonsAvailable[g] && lessonsAvailable[g][s]) {
                         lessonsAvailable[g][s].sort((a, b) => a.lessonNumber - b.lessonNumber);
                     }
                 }
             }

        }
        
        // NEW: Save history record to Supabase
        async function saveHistoryRecord(record) {
             if (!supabase) return;

             const { data, error } = await supabase
                 .from('history')
                 .insert([record]);
             
             if (error) {
                 console.error('L·ªói l∆∞u l·ªãch s·ª≠ l√™n Supabase:', error);
                 // T√πy ch·ªçn: Ghi v√†o console/status cho Admin bi·∫øt
             }
        }
        
        // NEW: Fetch history from Supabase
        async function fetchHistoryFromSupabase() {
            if (!supabase) return;
            
            // NOTE: fetchHistoryFromSupabase gi·ªù ƒë√¢y l√† h√†m t·∫£i d·ªØ li·ªáu ch√≠nh.
            // N√≥ c·∫ßn ƒë∆∞·ª£c await trong loadHistoryNames.
            
            const { data, error } = await supabase
                .from('history')
                .select('*')
                .order('timestamp', { ascending: false }); // B√†i m·ªõi nh·∫•t l√™n tr∆∞·ªõc

            if (error) {
                console.error('L·ªói t·∫£i l·ªãch s·ª≠ t·ª´ Supabase:', error);
                return;
            }

            learningHistory = data.map(record => ({
                studentName: record.student_name,
                grade: record.grade,
                subject: record.subject,
                timestamp: record.timestamp,
                score: record.score,
                missed: record.missed,
                total: record.total,
                incorrectQuestions: record.incorrect_questions,
                lessonRange: record.lesson_range
            }));
        }

        // FIX BUG 1: Make loadHistoryNames async and ensure data is loaded before processing
        async function loadHistoryNames() {
            // Await data fetch to ensure learningHistory is populated
            await fetchHistoryFromSupabase(); 
            
            const names = [...new Set(learningHistory.map(r => r.studentName))].sort();

            historyFilterNameEl.innerHTML = '<option value="ALL">T·∫•t c·∫£ h·ªçc sinh</option>';
            names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                historyFilterNameEl.appendChild(option);
            });
            
            // Call displayHistory to show initial results with loaded data
            displayHistory(); 
        }

        async function loadLessonOptions(shouldFetch = true) {
             if (shouldFetch) await fetchLessonsFromSupabase(); 
             
             const grade = parseInt(adminGradeEl.value);
             const subject = adminSubjectEl.value;
             const options = lessonsAvailable[grade][subject];
             
             adminLessonEl.innerHTML = '';
             if (options && options.length > 0) {
                 options.forEach(l => {
                     const option = document.createElement('option');
                     option.value = l.lessonNumber;
                     option.textContent = `B√†i ${l.lessonNumber} - ${l.lessonName} (${l.numQuestions} c√¢u)`; 
                     adminLessonEl.appendChild(option);
                 });
                 adminLessonEl.value = options[0].lessonNumber;
                 lessonNameControlEl.classList.remove('hidden'); 
             } else {
                 const option = document.createElement('option');
                 option.value = 0;
                 option.textContent = "Ch∆∞a c√≥ b√†i h·ªçc n√†o";
                 adminLessonEl.appendChild(option);
                 lessonNameControlEl.classList.add('hidden'); 
             }
             
             previewLesson();
        }

        async function previewLesson() {
             const grade = parseInt(adminGradeEl.value);
             const subject = adminSubjectEl.value;
             const lessonNumber = parseInt(adminLessonEl.value);
             
             if (lessonNumber > 0) {
                 const currentLesson = lessonsAvailable[grade][subject].find(l => l.lessonNumber === lessonNumber);
                 if (currentLesson) {
                     aiTargetInfoEl.textContent = `M·ª•c ti√™u AI: L·ªõp ${grade} - M√¥n ${subject} - B√†i ${lessonNumber} ("${currentLesson.lessonName}")`;
                 }
             } else {
                 aiTargetInfoEl.textContent = 'Vui l√≤ng ch·ªçn B√†i H·ªçc ·ªü m·ª•c 3 tr∆∞·ªõc khi t·∫°o c√¢u h·ªèi.';
             }


             if (lessonNumber === 0) {
                 lessonPreviewEl.textContent = "T·ªïng s·ªë c√¢u trong b√†i n√†y: 0";
                 return;
             }
             
             const lesson = lessonsAvailable[grade][subject].find(l => l.lessonNumber === lessonNumber);
             
             if (lesson) {
                 lessonPreviewEl.textContent = `T·ªïng s·ªë c√¢u trong B√†i ${lessonNumber}: ${lesson.numQuestions}`;
                 adminLessonNameEl.value = lesson.lessonName; 
                 lessonNameControlEl.classList.remove('hidden'); 
             }
             
             aiResultPreviewEl.textContent = '';
        }
        
        // NEW: T·∫°o C·∫•u Tr√∫c B√†i H·ªçc M·ªõi (SUPABASE INSERT)
        async function createNewLessonStructure() {
            if (!supabase) return;
            const grade = parseInt(newLessonGradeEl.value);
            const subject = newLessonSubjectEl.value;
            const newLessonNumber = parseInt(newLessonNumberEl.value.trim());
            const name = newLessonNameInputEl.value.trim();
            
            adminStatusEl.textContent = '';

            if (isNaN(newLessonNumber) || newLessonNumber <= 0) {
                adminStatusEl.textContent = "‚ö†Ô∏è S·ªë b√†i h·ªçc ph·∫£i l√† m·ªôt s·ªë nguy√™n d∆∞∆°ng.";
                return;
            }
            if (!name) {
                adminStatusEl.textContent = "‚ö†Ô∏è T√™n b√†i h·ªçc kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.";
                return;
            }

            // Ki·ªÉm tra tr√πng l·∫∑p tr∆∞·ªõc khi Insert
            const existingLessons = lessonsAvailable[grade][subject] || [];
            const alreadyExists = existingLessons.some(l => l.lessonNumber === newLessonNumber);
            if (alreadyExists) {
                adminStatusEl.textContent = `‚ö†Ô∏è B√†i ${newLessonNumber} ƒë√£ t·ªìn t·∫°i trong m√¥n n√†y. Vui l√≤ng ch·ªçn s·ªë b√†i kh√°c.`;
                return;
            }

            try {
                const lessonData = {
                    grade: grade,
                    subject: subject,
                    lesson_number: newLessonNumber, // T√™n c·ªôt Supabase
                    lesson_name: name, // T√™n c·ªôt Supabase
                    questions_data: [], // T√™n c·ªôt Supabase
                    num_questions: 0, // T√™n c·ªôt Supabase
                };

                const { data, error } = await supabase
                    .from('lessons')
                    .insert([lessonData])
                    .select();

                if (error) throw error;
                
                adminStatusEl.textContent = `‚úÖ ƒê√£ t·∫°o B√†i ${newLessonNumber} ("${name}") th√†nh c√¥ng tr√™n Supabase!`;
                
                const currentLessonValue = String(newLessonNumber);
                
                // --- ƒê·ªíNG B·ªò M·ª§C 3 V√Ä M·ª§C 2 ---
                await fetchLessonsFromSupabase(); 
                
                adminGradeEl.value = String(grade);
                adminSubjectEl.value = subject;
                await loadLessonOptions(false); 
                
                adminLessonEl.value = currentLessonValue;
                previewLesson(); 

                // Reset input
                newLessonNumberEl.value = '';
                newLessonNameInputEl.value = '';
                
            } catch (e) {
                adminStatusEl.textContent = `L·ªói t·∫°o b√†i Supabase: ${e.message}`;
            }
        }

        // NEW: C·∫≠p nh·∫≠t t√™n b√†i h·ªçc (SUPABASE UPDATE)
        async function updateLessonName() {
            if (!supabase) return;
            const grade = parseInt(adminGradeEl.value);
            const subject = adminSubjectEl.value;
            const lessonNumber = parseInt(adminLessonEl.value);
            const newName = adminLessonNameEl.value.trim();
            
            if (lessonNumber === 0 || !newName) {
                adminStatusEl.textContent = "‚ö†Ô∏è Vui l√≤ng ch·ªçn b√†i h·ªçc v√† nh·∫≠p t√™n.";
                return;
            }
            
            const currentLessonValue = String(lessonNumber);
            const lesson = lessonsAvailable[grade][subject].find(l => l.lessonNumber === lessonNumber);
            
            if (!lesson) {
                 adminStatusEl.textContent = "Kh√¥ng t√¨m th·∫•y b√†i h·ªçc.";
                 return;
            }

            try {
                const { data, error } = await supabase
                    .from('lessons')
                    .update({ lesson_name: newName }) // T√™n c·ªôt Supabase
                    .eq('id', lesson.id) // ƒêi·ªÅu ki·ªán ID
                    .select();

                if (error) throw error;

                adminStatusEl.textContent = `‚úÖ ƒê√£ l∆∞u t√™n m·ªõi: "${newName}"`;
                
                await fetchLessonsFromSupabase(); 
                await loadLessonOptions(false); 
                
                adminLessonEl.value = currentLessonValue; 
                previewLesson();
            } catch (e) {
                adminStatusEl.textContent = `L·ªói l∆∞u t√™n Supabase: ${e.message}`;
            }
        }
        
        // NEW: X√≥a to√†n b·ªô B√†i h·ªçc (SUPABASE DELETE)
        function confirmDeleteLesson() {
            const lessonNumber = parseInt(adminLessonEl.value);
            if (lessonNumber === 0) {
                adminStatusEl.textContent = "Vui l√≤ng ch·ªçn b√†i h·ªçc h·ª£p l·ªá ƒë·ªÉ x√≥a.";
                return;
            }
            // Thay th·∫ø window.confirm b·∫±ng c·∫£nh b√°o vƒÉn b·∫£n trong UI n·∫øu c√≥ th·ªÉ, nh∆∞ng gi·ªØ nguy√™n theo code g·ªëc.
            if (window.confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a TO√ÄN B·ªò B√†i ${lessonNumber} (${adminLessonNameEl.value}) kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) {
                deleteLesson();
            }
        }
        
        async function deleteLesson() {
            if (!supabase) return;
            const grade = parseInt(adminGradeEl.value);
            const subject = adminSubjectEl.value;
            const lessonNumber = parseInt(adminLessonEl.value);
            
            const lesson = lessonsAvailable[grade][subject].find(l => l.lessonNumber === lessonNumber);
            if (!lesson) {
                 adminStatusEl.textContent = "Kh√¥ng t√¨m th·∫•y b√†i h·ªçc ƒë·ªÉ x√≥a.";
                 return;
            }
            
            try {
                const { error } = await supabase
                    .from('lessons')
                    .delete()
                    .eq('id', lesson.id);

                if (error) throw error;
                
                adminStatusEl.textContent = `‚úÖ ƒê√£ x√≥a B√†i ${lessonNumber} ("${lesson.lessonName}") th√†nh c√¥ng kh·ªèi Supabase!`;
                
                await fetchLessonsFromSupabase(); 
                await loadLessonOptions(false);
            } catch (e) {
                adminStatusEl.textContent = `L·ªói x√≥a b√†i Supabase: ${e.message}`;
            }
        }

        // --- GEMINI API INTEGRATION (M·ª•c 2) ---
        
        async function generateAndSaveQuestions() {
            if (!supabase) return;
            const prompt = aiPromptEl.value.trim();
            const grade = parseInt(adminGradeEl.value);
            const subject = adminSubjectEl.value;
            const lessonNumber = parseInt(adminLessonEl.value);
            
            if (!prompt) {
                adminStatusEl.textContent = "Vui l√≤ng nh·∫≠p y√™u c·∫ßu t·∫°o c√¢u h·ªèi cho AI.";
                return;
            }
            
            if (lessonNumber === 0) {
                adminStatusEl.textContent = "‚ö†Ô∏è Vui l√≤ng ch·ªçn B√†i H·ªçc ·ªü m·ª•c 3 ho·∫∑c t·∫°o b√†i m·ªõi ·ªü m·ª•c 1 tr∆∞·ªõc khi t·∫°o c√¢u h·ªèi.";
                return;
            }
            
            if (geminiKeys.length === 0) {
                adminStatusEl.textContent = "‚ö†Ô∏è Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt API Key Gemini ·ªü M·ª•c 5.";
                return;
            }

            aiGenerateBtn.disabled = true;
            aiGenerateTextEl.textContent = "ƒêang t·∫°o c√¢u h·ªèi...";
            aiLoadingSpinnerEl.classList.remove('hidden');
            adminStatusEl.textContent = "";
            aiResultPreviewEl.textContent = "";

            const subjectName = {
                'TOAN': 'To√°n H·ªçc (Ph√©p t√≠nh v√† L·ªùi vƒÉn)',
                'SPELL': 'Ti·∫øng Vi·ªát - Ch√≠nh T·∫£ (Ph√¢n bi·ªát √¢m/v·∫ßn, ƒëi·ªÅn t·ª´)',
                'READ': 'Ti·∫øng Vi·ªát - Luy·ªán ƒê·ªçc (Nghe v√† ch·ªçn c√¢u/t·ª´)',
            }[subject];

            const systemInstruction = `B·∫°n l√† m·ªôt gi√°o vi√™n ti·ªÉu h·ªçc. H√£y t·∫°o 30 c√¢u h·ªèi d·ª±a tr√™n y√™u c·∫ßu ng∆∞·ªùi d√πng, cho L·ªõp ${grade} - M√¥n ${subjectName}.
            
            TU√ÇN TH·ª¶ C·∫§U TR√öC JSON NGHI√äM NG·∫∂T sau (Array of Objects):
            1. 'q': C√¢u h·ªèi hi·ªÉn th·ªã (d√πng cho To√°n/Ch√≠nh t·∫£) HO·∫∂C D√≤ng h∆∞·ªõng d·∫´n (d√πng cho Luy·ªán ƒë·ªçc).
            2. 'a': ƒê√°p √°n ƒë√∫ng (lu√¥n l√† chu·ªói).
            3. 'options': Array ch·ª©a 4 l·ª±a ch·ªçn (bao g·ªìm c·∫£ ƒë√°p √°n ƒë√∫ng).
            4. 'text': VƒÉn b·∫£n ch√≠nh x√°c c·∫ßn ƒë·ªçc to (ch·ªâ c·∫ßn cho Luy·ªán ƒë·ªçc v√† To√°n l·ªùi vƒÉn, b·ªè tr·ªëng cho To√°n ph√©p t√≠nh).
            5. 'type': B·∫ÆT BU·ªòC l√† m·ªôt trong c√°c gi√° tr·ªã sau: MATH_OP (Ph√©p t√≠nh), MATH_WORD (L·ªùi vƒÉn), SPELL (Ch√≠nh t·∫£), READ (Luy·ªán ƒë·ªçc).`;
            
            let jsonSchema = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        "q": { "type": "STRING", "description": "C√¢u h·ªèi hi·ªÉn th·ªã" },
                        "a": { "type": "STRING", "description": "ƒê√°p √°n ƒë√∫ng" },
                        "options": { "type": "ARRAY", "items": { "type": "STRING" }, "description": "4 l·ª±a ch·ªçn" },
                        "text": { "type": "STRING", "description": "VƒÉn b·∫£n ƒë·ªÉ ƒë·ªçc (b·ªè tr·ªëng n·∫øu l√† To√°n ph√©p t√≠nh)" },
                        "type": { "type": "STRING", "description": "MATH_OP, MATH_WORD, SPELL, ho·∫∑c READ" }
                    },
                    required: ["q", "a", "options", "text", "type"]
                }
            };
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: jsonSchema,
                }
            };

            let successful = false;
            let finalError = "Kh√¥ng th·ªÉ k·∫øt n·ªëi ho·∫∑c t·∫•t c·∫£ API keys ƒë·ªÅu b·ªã l·ªói.";

            // L·∫∑p qua t·∫•t c·∫£ c√°c keys ƒë√£ l∆∞u tr·ªØ
            for (let i = 0; i < geminiKeys.length; i++) {
                currentKeyIndex = (i + currentKeyIndex) % geminiKeys.length; // Xoay v√≤ng index
                const apiKey = geminiKeys[currentKeyIndex];
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                adminStatusEl.textContent = `ƒêang th·ª≠ API Key s·ªë ${currentKeyIndex + 1}/${geminiKeys.length}...`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        
                        if (result.candidates && result.candidates.length > 0 && 
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                                
                            const jsonString = result.candidates[0].content.parts[0].text;
                            const newQuestions = JSON.parse(jsonString);
                            
                            if (Array.isArray(newQuestions) && newQuestions.length > 0) {
                                await saveNewQuestions(grade, subject, lessonNumber, newQuestions);
                                successful = true;
                                break; // TH√ÄNH C√îNG! Tho√°t v√≤ng l·∫∑p key
                            } else {
                                throw new Error("AI tr·∫£ v·ªÅ c·∫•u tr√∫c kh√¥ng ph·∫£i l√† m·ªôt m·∫£ng c√¢u h·ªèi.");
                            }
                        } else {
                            throw new Error("Kh√¥ng nh·∫≠n ƒë∆∞·ª£c n·ªôi dung t·ª´ AI.");
                        }

                    } else {
                        // L·ªói API (4xx, 5xx). Ghi l·∫°i l·ªói v√† th·ª≠ key ti·∫øp theo
                        const errorBody = await response.json();
                        const errorMessage = errorBody.error?.message || `L·ªói HTTP ${response.status}`;
                        finalError = `Key ${currentKeyIndex + 1} l·ªói: ${errorMessage}`;
                        console.error(`L·ªói API Key ${currentKeyIndex + 1}:`, errorMessage);
                        // continue (t·ª± ƒë·ªông chuy·ªÉn sang key ti·∫øp theo trong v√≤ng l·∫∑p)
                    }

                } catch (error) {
                    // L·ªói m·∫°ng ho·∫∑c l·ªói JSON parsing. Th·ª≠ key ti·∫øp theo
                    finalError = `Key ${currentKeyIndex + 1} l·ªói k·∫øt n·ªëi/m·∫°ng: ${error.message}`;
                    console.error(`L·ªói k·∫øt n·ªëi Key ${currentKeyIndex + 1}:`, error);
                    // continue
                }
            } // K·∫øt th√∫c v√≤ng l·∫∑p key

            if (!successful) {
                adminStatusEl.textContent = `L·ªñI AI/K·∫æT N·ªêI: ${finalError}`;
            }

            aiGenerateBtn.disabled = false;
            aiGenerateTextEl.textContent = "‚ú® T·∫°o & L∆∞u 30 C√¢u H·ªèi M·ªõi";
            aiLoadingSpinnerEl.classList.add('hidden');
        }
        
        // NEW: L∆∞u c√¢u h·ªèi m·ªõi (SUPABASE UPDATE - Questions_data)
        async function saveNewQuestions(grade, subject, lessonNumber, newQuestions) {
            
            const lessonsArray = lessonsAvailable[grade][subject];
            const lesson = lessonsArray.find(l => l.lessonNumber === lessonNumber);
            
            if (!lesson) {
                 adminStatusEl.textContent = `L·ªói l∆∞u d·ªØ li·ªáu: Kh√¥ng t√¨m th·∫•y B√†i ${lessonNumber}.`;
                 return;
            }

            try {
                let existingQuestions = lesson.questions_data || [];
                const updatedQuestions = [...existingQuestions, ...newQuestions];
                
                const { data, error } = await supabase
                    .from('lessons')
                    .update({ 
                        questions_data: updatedQuestions, // C·∫≠p nh·∫≠t m·∫£ng c√¢u h·ªèi
                        num_questions: updatedQuestions.length // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng
                    })
                    .eq('id', lesson.id)
                    .select();
                
                if (error) throw error;
                
                adminStatusEl.textContent = `‚úÖ ƒê√£ l∆∞u ${newQuestions.length} c√¢u h·ªèi m·ªõi v√†o B√†i ${lessonNumber}. T·ªïng s·ªë c√¢u: ${updatedQuestions.length}.`;
                aiResultPreviewEl.textContent = JSON.stringify(newQuestions, null, 2);
                
                // Force cache update and reload options
                await fetchLessonsFromSupabase(); 
                
                await loadLessonOptions(false); 
                
                adminLessonEl.value = String(lessonNumber); 
                previewLesson();
                
            } catch (e) {
                 adminStatusEl.textContent = `L·ªói l∆∞u d·ªØ li·ªáu Supabase: ${e.message}`;
                 console.error("Supabase Save Error:", e);
            }
        }
        
        // --- HISTORY VIEW LOGIC (M·ª•c 4) ---

        // NOTE: loadHistoryNames gi·ªù ƒë√£ l√† async v√† ƒë·∫£m b·∫£o d·ªØ li·ªáu ƒë∆∞·ª£c t·∫£i
        // tr∆∞·ªõc khi t·∫°o danh s√°ch l·ªçc v√† g·ªçi displayHistory.

        function loadHistoryNames() {
            // NOTE: fetchHistoryFromSupabase() l√† async, n√≥ c·∫ßn ƒë∆∞·ª£c await. 
            // T√¥i ƒë√£ chuy·ªÉn logic n√†y l√™n h√†m loadHistoryNames() v√† bi·∫øn n√≥ th√†nh async.
            loadHistorySetup();
        }

        async function loadHistorySetup() { // T√™n h√†m m·ªõi ƒë·ªÉ l√†m r√µ n√≥ l√† async
            await fetchHistoryFromSupabase(); // Await data load

            const names = [...new Set(learningHistory.map(r => r.studentName))].sort();

            historyFilterNameEl.innerHTML = '<option value="ALL">T·∫•t c·∫£ h·ªçc sinh</option>';
            names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                historyFilterNameEl.appendChild(option);
            });
            
            // Initial display with fresh data
            displayHistory(); 
        }

        // FIX BUG 2: Change dynamic ID generation inside displayHistory
        function displayHistory() {
            const filterName = historyFilterNameEl.value;
            const filterSubject = historyFilterSubjectEl.value;
            historyListEl.innerHTML = '';

            const filteredHistory = learningHistory.filter(record => {
                const nameMatch = filterName === 'ALL' || record.studentName === filterName;
                const subjectMatch = filterSubject === 'ALL' || record.subject === filterSubject;
                return nameMatch && subjectMatch;
            });

            if (filteredHistory.length === 0) {
                historyListEl.innerHTML = '<p class="text-sm text-gray-600 text-center p-4 border rounded-lg bg-white">Ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i n√†o ƒë∆∞·ª£c ghi l·∫°i.</p>';
                return;
            }

            filteredHistory.forEach((record, index) => { // L·∫•y index
                // Supabase returns standard ISO format
                const date = new Date(record.timestamp).toLocaleDateString('vi-VN', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                let subjectName = record.subject;
                if (record.subject === 'TOAN') subjectName = 'To√°n';
                else if (record.subject === 'SPELL') subjectName = 'Ch√≠nh T·∫£';
                else if (record.subject === 'READ') subjectName = 'Luy·ªán ƒê·ªçc';

                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-xl shadow-md border-t-4 border-indigo-500 space-y-2';
                
                const incorrectCount = record.incorrectQuestions ? record.incorrectQuestions.length : 0;
                const detailId = `details-${index}`; // ID an to√†n, d·ª±a tr√™n index

                card.innerHTML = `
                    <p class="text-sm font-bold text-indigo-700">üë§ ${record.studentName} | L·ªõp ${record.grade} - ${subjectName}</p>
                    <p class="text-xs text-gray-500">üïí ${date} | Ph·∫°m vi B√†i: ${record.lessonRange}</p>
                    <div class="flex justify-between items-center text-lg font-extrabold pt-2">
                        <span class="text-green-600">‚úÖ ${record.score}</span>
                        <span class="text-red-600">‚ùå ${record.missed}</span>
                        <span class="text-gray-700">T·ªïng: ${record.total}</span>
                    </div>
                    ${incorrectCount > 0 ? `<button class="details-btn w-full mt-2 p-2 bg-yellow-400 text-yellow-900 text-sm font-bold rounded-lg hover:bg-yellow-500" data-target="#${detailId}">
                        Chi ti·∫øt ${incorrectCount} c√¢u sai
                    </button>` : `<p class="text-sm text-green-500 font-semibold mt-2 text-center">Ho√†n h·∫£o! Kh√¥ng c√≥ c√¢u sai.</p>`}
                    
                    <div id="${detailId}" class="hidden space-y-3 pt-3 border-t mt-3 text-sm">
                        <p class="font-bold text-red-700">C√ÅC C√ÇU L√ÄM SAI:</p>
                        ${record.incorrectQuestions ? record.incorrectQuestions.map((q, qIndex) => `
                            <div class="bg-red-50 p-3 rounded-lg border border-red-200">
                                <p class="font-semibold text-gray-800">C√¢u ${qIndex + 1} (B√†i ${q.lesson}): ${q.q}</p>
                                <p class="text-red-600">B√© ch·ªçn: <strong>${q.user_answer}</strong></p>
                                <p class="text-green-600">ƒê√°p √°n: <strong>${q.a}</strong></p>
                            </div>
                        `).join('') : ''}
                    </div>
                `;
                historyListEl.appendChild(card);
            });
            
            document.querySelectorAll('.details-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetId = e.target.getAttribute('data-target');
                    const targetEl = document.querySelector(targetId);
                    if (targetEl.classList.contains('hidden')) {
                        targetEl.classList.remove('hidden');
                        e.target.textContent = '·∫®n chi ti·∫øt c√¢u sai';
                    } else {
                        targetEl.classList.add('hidden');
                        // Use innerHTML count as the button text, which is already set
                        const incorrectCountInDetails = targetEl.querySelectorAll('.bg-red-50').length;
                        e.target.textContent = `Chi ti·∫øt ${incorrectCountInDetails} c√¢u sai`;
                    }
                });
            });
        }

        
        // --- STARTUP ---
        window.onload = () => {
             // NEW: T·∫£i data t·ª´ Supabase
             fetchLessonsFromSupabase(); 
             showScreen('student-name-input');
        }
    </script>
</body>
</html>
