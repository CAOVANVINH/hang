<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tr√≤ Ch∆°i H·ªçc T·∫≠p Vui</title>
    <!-- Tailwind CSS for utility-first styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Quicksand for a friendly look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base font-family for the entire body */
        body {
            font-family: 'Quicksand', sans-serif;
            /* Gradient background for a vibrant look */
            background: linear-gradient(to right top, #6d8cf0, #8d8de0, #a98fcb, #be93b6, #ce99a6);
        }
        /* Glassmorphism effect for containers */
        .glass-container {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        /* Glassmorphism effect for buttons */
        .glass-btn {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease-in-out;
            /* Default text color for better contrast on glass background */
            color: #2d3748; /* Dark gray for text */
        }
        /* Override text color for primary action buttons to ensure visibility */
        #start-btn, #next-btn, #play-again-btn, #admin-login-btn, #logout-btn, #view-history-btn, #back-to-admin-btn {
            color: white; /* White text for main action buttons */
        }
        /* Specific color for admin login button on main screen */
        #admin-login-btn {
            color: #cbd5e0; /* Light gray for admin button */
        }

        /* Styling for selected choice buttons */
        .choice-btn.selected {
            transform: scale(1.05); /* Slightly enlarge on selection */
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5); /* Add a glow effect */
            border-width: 2px;
            border-color: rgba(255, 255, 255, 0.7); /* Thicker, more visible border */
        }
        /* Styling for correct answer option */
        .answer-option.correct {
            background-color: rgba(34, 197, 94, 0.7) !important; /* Green background */
            border-color: rgba(22, 163, 74, 0.8);
            color: white !important; /* White text for contrast */
        }
        /* Styling for incorrect answer option */
        .answer-option.incorrect {
            background-color: rgba(239, 68, 68, 0.7) !important; /* Red background */
            border-color: rgba(220, 38, 38, 0.8);
            color: white !important; /* White text for contrast */
        }
        /* Modal overlay transition for smooth appearance */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }

        /* Responsive adjustments for smaller screens (mobile first approach) */
        @media (max-width: 768px) {
            .glass-container {
                padding: 1rem; /* Reduce padding on mobile */
                margin: 0.5rem; /* Reduce margin on mobile */
            }
            h1 {
                font-size: 2.25rem; /* Adjust main title size */
            }
            h2 {
                font-size: 1.5rem; /* Adjust subtitle size */
            }
            .choice-btn, .answer-option, #start-btn, #next-btn, #play-again-btn {
                font-size: 1rem; /* Adjust button text size */
                padding: 0.8rem; /* Adjust button padding */
            }
            #progress-text, #score-text {
                font-size: 0.9rem; /* Adjust progress/score text size */
            }
            #question-container p {
                font-size: 1.1rem; /* Adjust question text size */
            }
            #final-score {
                font-size: 4rem; /* Reduce final score size */
            }
            #login-modal .glass-container {
                padding: 1.5rem; /* Adjust modal padding */
            }
        }

        /* Custom style for history table container to enable scrolling */
        #history-table-container {
            max-height: 400px; /* Set max height for scrollability */
            overflow-y: auto; /* Enable vertical scrolling */
        }

        /* Style for the speaker icon */
        #read-question-btn { /* Changed ID to reflect original purpose */
            cursor: pointer;
            transition: transform 0.2s ease-in-out, color 0.2s ease-in-out;
        }

        #read-question-btn:hover {
            transform: scale(1.1);
            color: #6366f1; /* Indigo-500 on hover */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main container for the game, styled with glassmorphism -->
    <div class="w-full max-w-3xl mx-auto glass-container rounded-3xl shadow-2xl p-4 md:p-8 relative">

        <!-- Selection Screen: Where users choose subject, grade, and semester -->
        <div id="selection-screen">
            <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-2">Tr√≤ Ch∆°i H·ªçc T·∫≠p</h1>
            <p class="text-center text-gray-700 mb-8">C√πng b√© v·ª´a h·ªçc v·ª´a ch∆°i!</p>

            <!-- Subject Selection -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">1. Ch·ªçn M√¥n H·ªçc</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button data-subject="toan" class="choice-btn glass-btn bg-sky-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-sky-500/60">üî¢ To√°n H·ªçc</button>
                    <button data-subject="tiengviet" class="choice-btn glass-btn bg-emerald-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-emerald-500/60">‚úçÔ∏è Ti·∫øng Vi·ªát</button>
                </div>
            </div>

            <!-- Grade Selection -->
            <div class="mb-6">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">2. Ch·ªçn L·ªõp</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button data-grade="lop1" class="choice-btn glass-btn bg-amber-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-amber-500/60">L·ªõp 1</button>
                    <button data-grade="lop2" class="choice-btn glass-btn bg-rose-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-rose-500/60">L·ªõp 2</button>
                </div>
            </div>

            <!-- Semester Selection -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-3 text-gray-700">3. Ch·ªçn H·ªçc K·ª≥</h2>
                <div class="grid grid-cols-2 gap-4">
                    <button data-semester="hocky1" class="choice-btn glass-btn bg-purple-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-purple-500/60">H·ªçc K·ª≥ 1</button>
                    <button data-semester="hocky2" class="choice-btn glass-btn bg-pink-500/40 font-bold py-4 rounded-2xl shadow-lg hover:bg-pink-500/60">H·ªçc K·ª≥ 2</button>
                </div>
            </div>

            <!-- Start Button (initially disabled) -->
            <button id="start-btn" class="w-full glass-btn bg-gray-500/50 text-white font-bold py-4 rounded-2xl text-xl shadow-lg cursor-not-allowed" disabled>B·∫Øt ƒë·∫ßu!</button>
            <!-- Admin Login Button -->
            <div class="text-right mt-4"><button id="admin-login-btn" class="text-sm text-gray-200 hover:text-white font-semibold">Qu·∫£n tr·ªã vi√™n</button></div>
        </div>

        <!-- Game Screen: Displays questions and options -->
        <div id="game-screen" class="hidden">
            <div class="flex justify-between items-center mb-4 text-white">
                <div id="progress-text" class="font-semibold">C√¢u 1/20</div>
                <div id="score-text" class="font-bold text-lg">ƒêi·ªÉm: 0</div>
            </div>
            <div id="question-container" class="bg-black/10 p-6 rounded-2xl text-center mb-6 min-h-[100px] flex items-center justify-center relative">
                <p class="text-xl md:text-2xl font-semibold text-white"></p>
                <!-- Speaker icon for Text-to-Speech -->
                <button id="read-question-btn" class="absolute top-4 right-4 text-white hover:text-indigo-400 focus:outline-none">
                    <!-- New Speaker SVG Icon (Material Design 'volume_up' icon) -->
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-7 h-7">
                        <path d="M18.5 12c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM5 10v4h3l4 4V6l-4 4H5zm13.5 2c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM19 12c0-2.8-1.56-5.28-3.8-6.5L14 4.5v15l1.2-1.5C17.44 17.28 19 14.8 19 12zM16 8.5v7l-4-4H8V8.5h4l4-4z"/>
                    </svg>
                </button>
            </div>
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            <div id="feedback-container" class="text-center mt-4 font-bold text-2xl h-8 text-white"></div>
            <button id="next-btn" class="hidden w-full mt-4 glass-btn bg-blue-500/60 text-white font-bold py-3 rounded-2xl shadow-lg hover:bg-blue-500/80">C√¢u ti·∫øp theo</button>
        </div>

        <!-- Results Screen: Shows final score and message -->
        <div id="results-screen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Ho√†n th√†nh!</h2>
            <p id="final-score-text" class="text-xl text-gray-700 mb-2">B√© ƒë√£ ƒë·∫°t ƒë∆∞·ª£c</p>
            <p id="final-score" class="text-6xl font-bold text-blue-600 mb-6">0/10</p>
            <p id="final-message" class="text-lg text-gray-600 mb-8">C·ªë g·∫Øng l√™n ·ªü l·∫ßn sau nh√©!</p>
            <button id="play-again-btn" class="w-full glass-btn bg-green-500/60 text-white font-bold py-4 rounded-2xl text-xl shadow-lg hover:bg-green-500/80">Ch∆°i l·∫°i</button>
        </div>
        
        <!-- Admin Panel: For administrative actions -->
        <div id="admin-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-8 text-center">B·∫£ng ƒëi·ªÅu khi·ªÉn Admin</h2>
            <div class="space-y-4">
                   <button id="view-history-btn" class="w-full glass-btn bg-indigo-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-indigo-500/80">Xem L·ªãch S·ª≠ Thi</button>
                   <button id="logout-btn" class="w-full glass-btn bg-red-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-red-500/80">ƒêƒÉng xu·∫•t</button>
            </div>
        </div>
        
        <!-- History Panel: Displays past quiz results -->
        <div id="history-panel" class="hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-4 text-center">L·ªãch S·ª≠ L√†m B√†i</h2>
            <div id="history-table-container" class="overflow-x-auto bg-white/50 rounded-2xl p-4">
                <!-- History table will be inserted here dynamically -->
            </div>
            <button id="back-to-admin-btn" class="w-full mt-6 glass-btn bg-gray-500/60 text-white font-bold py-3 rounded-2xl text-lg shadow-lg hover:bg-gray-500/80">Quay l·∫°i</button>
        </div>

    </div>

    <!-- Admin Login Modal -->
    <div id="login-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden opacity-0">
        <div class="glass-container rounded-3xl shadow-2xl p-8 w-full max-w-sm relative">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">ƒêƒÉng Nh·∫≠p Admin</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-gray-700 font-semibold mb-2">T√™n ƒëƒÉng nh·∫≠p</label>
                    <input type="text" id="username" class="w-full px-4 py-2 border border-gray-300/50 rounded-2xl bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-gray-700 font-semibold mb-2">M·∫≠t kh·∫©u</label>
                    <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300/50 rounded-2xl bg-white/50 focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                </div>
                <p id="login-error" class="text-red-500 text-center text-sm h-4 mb-4"></p>
                <button type="submit" class="w-full glass-btn bg-blue-600/70 text-white font-bold py-3 rounded-2xl hover:bg-blue-600/90">ƒêƒÉng nh·∫≠p</button>
            </form>
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
        </div>
    </div>


    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- LARGE QUESTION BANK (Updated with Vietnamese data) ---
        // This object holds all the questions categorized by subject, grade, and semester.
        const questions = {
            toan: {
                lop1: {
                    hocky1: [ { question: "5 + 4 = ?", options: [8, 9, 10, 7], answer: 9 }, { question: "8 - 3 = ?", options: [4, 5, 6, 7], answer: 5 }, { question: "S·ªë li·ªÅn sau c·ªßa 9 l√†?", options: [8, 10, 11, 7], answer: 10 }, { question: "C√≥ m·∫•y h√¨nh tr√≤n: üîµ üî∫ üîµ ‚¨ú", options: [1, 2, 3, 4], answer: 2 }, { question: "2 + 6 = ?", options: [7, 8, 9, 10], answer: 8 }, { question: "S·ªë li·ªÅn tr∆∞·ªõc c·ªßa 15 l√†?", options: [13, 14, 16, 17], answer: 14 }, { question: "H√¨nh vu√¥ng c√≥ m·∫•y c·∫°nh?", options: [2, 3, 4, 5], answer: 4 }, { question: "ƒêi·ªÅn d·∫•u: 5 + 3 ... 8", options: ["<", ">", "="], answer: "=" }, { question: "7 + ... = 10", options: [1, 2, 3, 4], answer: 3 }, { question: "S·ªë b√© nh·∫•t trong c√°c s·ªë: 9, 3, 7, 5 l√†?", options: [9, 3, 7, 5], answer: 3 }, { question: "6 + 1 = ?", options: [5, 6, 7, 8], answer: 7 }, { question: "10 - 10 = ?", options: [0, 1, 10, 20], answer: 0 }, { question: "S·ªë l·ªõn nh·∫•t trong c√°c s·ªë: 1, 8, 4, 6 l√†?", options: [1, 8, 4, 6], answer: 8 }, { question: "3 + ... = 9", options: [5, 6, 7, 8], answer: 6 }, { question: "C√≥ m·∫•y h√¨nh vu√¥ng: ‚¨ú ‚¨ú üîµ ‚¨ú", options: [1, 2, 3, 4], answer: 3 }, { question: "9 - 7 = ?", options: [1, 2, 3, 16], answer: 2 }, { question: "S·ªë li·ªÅn sau c·ªßa 0 l√†?", options: [0, 1, 2, -1], answer: 1 }, { question: "4 + 4 = ?", options: [6, 7, 8, 9], answer: 8 }, { question: "ƒêi·ªÅn d·∫•u: 10 ... 5 + 6", options: ["<", ">", "="], answer: "<" }, { question: "Trong c√°c s·ªë 2, 8, 5, 1, s·ªë n√†o nh·ªè nh·∫•t?", options: [2, 8, 5, 1], answer: 1 } ],
                    hocky2: [ { question: "10 + 6 = ?", options: [15, 16, 17, 18], answer: 16 }, { question: "18 - 5 = ?", options: [12, 13, 14, 15], answer: 13 }, { question: "S·ªë g·ªìm 1 ch·ª•c v√† 7 ƒë∆°n v·ªã l√†?", options: [10, 7, 17, 71], answer: 17 }, { question: "H√¥m nay l√† th·ª© Hai, ng√†y mai l√† th·ª© m·∫•y?", options: ["Ch·ªß Nh·∫≠t", "Th·ª© Ba", "Th·ª© T∆∞"], answer: "Th·ª© Ba" }, { question: "Lan c√≥ 8 k·∫πo, m·∫π cho th√™m 5. Lan c√≥ t·∫•t c·∫£...c√°i k·∫πo?", options: [12, 13, 14, 3], answer: 13 }, { question: "S·ªë l·ªõn nh·∫•t c√≥ hai ch·ªØ s·ªë l√†?", options: [10, 90, 99, 100], answer: 99 }, { question: "15 + 4 = ?", options: [18, 19, 20, 21], answer: 19 }, { question: "Tr√™n c√†nh c√≥ 12 con chim, bay ƒëi 4 con. C√≤n l·∫°i...con chim?", options: [7, 8, 9, 16], answer: 8 }, { question: "S·ªë 50 c√≤n ƒë∆∞·ª£c g·ªçi l√†?", options: ["NƒÉm m∆∞∆°i", "NƒÉm ch·ª•c", "C·∫£ hai ƒë·ªÅu ƒë√∫ng"], answer: "C·∫£ hai ƒë·ªÅu ƒë√∫ng" }, { question: "ƒêi·ªÅn s·ªë: 20, 30, ..., 50", options: [35, 40, 45, 60], answer: 40 }, { question: "30 + 40 = ?", options: [60, 70, 80, 10], answer: 70 }, { question: "90 - 20 = ?", options: [60, 70, 80, 110], answer: 70 }, { question: "S·ªë g·ªìm 8 ch·ª•c v√† 1 ƒë∆°n v·ªã l√†?", options: [80, 18, 81, 9], answer: 81 }, { question: "S·ªë b√© nh·∫•t c√≥ hai ch·ªØ s·ªë gi·ªëng nhau l√†?", options: [10, 11, 12, 22], answer: 11 }, { question: "An c√≥ 19 vi√™n bi, An cho B√¨nh 7 vi√™n. An c√≤n l·∫°i...vi√™n bi?", options: [11, 12, 13, 26], answer: 12 }, { question: "1 tu·∫ßn c√≥ m·∫•y ng√†y?", options: [5, 6, 7, 8], answer: 7 }, { question: "S·ªë li·ªÅn tr∆∞·ªõc c·ªßa 100 l√†?", options: [90, 98, 99, 101], answer: 99 }, { question: "ƒêi·ªÅn d·∫•u: 45 ... 54", options: ["<", ">", "="], answer: "<" }, { question: "50 + 50 = ?", options: [90, 100, 10, 0], answer: 100 }, { question: "S·ªë tr√≤n ch·ª•c l·ªõn nh·∫•t c√≥ hai ch·ªØ s·ªë l√†?", options: [10, 80, 90, 99], answer: 90 } ]
                }
            },
            tiengviet: { // Added Vietnamese subject data
                lop1: {
                    hocky1: [
                        { question: "Ch·ªØ c√°i n√†o ƒë·ª©ng sau 'A' trong b·∫£ng ch·ªØ c√°i?", options: ["C", "B", "D", "E"], answer: "B" },
                        { question: "T·ª´ n√†o ch·ªâ ho·∫°t ƒë·ªông 'ƒÉn'?", options: ["Ng·ªß", "Ch∆°i", "ƒÇn", "H·ªçc"], answer: "ƒÇn" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'Con ... ƒëang b∆°i.'", options: ["chim", "c√°", "m√®o", "ch√≥"], answer: "c√°" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn 'ai'?", options: ["C√°i", "Con", "S√°ch", "B√∫t"], answer: "C√°i" },
                        { question: "Ch·ªØ c√°i n√†o ƒë·ª©ng tr∆∞·ªõc 'D' trong b·∫£ng ch·ªØ c√°i?", options: ["C", "E", "F", "B"], answer: "C" },
                        { question: "T·ª´ n√†o l√† t√™n m·ªôt lo√†i hoa?", options: ["B√†n", "Gh·∫ø", "Hoa h·ªìng", "C√¢y"], answer: "Hoa h·ªìng" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'M·∫π ... c∆°m.'", options: ["ch∆°i", "n·∫•u", "ng·ªß", "ƒë·ªçc"], answer: "n·∫•u" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn 'eo'?", options: ["M√®o", "Ch√≥", "G√†", "V·ªãt"], answer: "M√®o" },
                        { question: "T·ª´ n√†o ch·ªâ ƒë·ªì v·∫≠t d√πng ƒë·ªÉ vi·∫øt?", options: ["S√°ch", "B√∫t", "T·∫©y", "Th∆∞·ªõc"], answer: "B√∫t" },
                        { question: "Ch·ªØ c√°i n√†o l√† nguy√™n √¢m?", options: ["B", "C", "A", "D"], answer: "A" },
                        { question: "T·ª´ n√†o c√≥ nghƒ©a l√† 'nh·ªè b√©'?", options: ["L·ªõn", "To", "B√©", "D√†i"], answer: "B√©" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: '√îng b√† ... ch√°u.'", options: ["ch∆°i", "y√™u", "ƒë·ªçc", "vi·∫øt"], answer: "y√™u" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn 'iu'?", options: ["Hiu", "H∆∞∆°u", "Siu", "Ciu"], answer: "Hiu" },
                        { question: "T·ª´ n√†o l√† t√™n m·ªôt lo·∫°i qu·∫£?", options: ["C√† r·ªët", "T√°o", "B√¥ng c·∫£i", "Khoai t√¢y"], answer: "T√°o" },
                        { question: "Ch·ªØ c√°i n√†o l√† ph·ª• √¢m?", options: ["O", "U", "E", "K"], answer: "K" },
                        { question: "T·ª´ n√†o ch·ªâ m√†u s·∫Øc?", options: ["B√†n", "ƒê·ªè", "S√°ch", "C√¢y"], answer: "ƒê·ªè" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'Con ch√≥ ƒëang ...'", options: ["bay", "s·ªßa", "b∆°i", "h√≥t"], answer: "s·ªßa" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn 'ay'?", options: ["Tay", "Ch√¢n", "M·∫Øt", "M≈©i"], answer: "Tay" },
                        { question: "T·ª´ n√†o l√† t√™n m·ªôt con v·∫≠t nu√¥i trong nh√†?", options: ["H·ªï", "S∆∞ t·ª≠", "M√®o", "G·∫•u"], answer: "M√®o" },
                        { question: "T·ª´ n√†o ch·ªâ h√†nh ƒë·ªông 'nghe'?", options: ["Nh√¨n", "Nghe", "N√≥i", "Vi·∫øt"], answer: "Nghe" }
                    ],
                    hocky2: [
                        { question: "T·ª´ n√†o c√≥ ti·∫øng 's√°ch'?", options: ["Quy·ªÉn v·ªü", "B√∫t ch√¨", "S√°ch gi√°o khoa", "C√°i b√†n"], answer: "S√°ch gi√°o khoa" },
                        { question: "T·ª´ n√†o ƒë·ªìng nghƒ©a v·ªõi 'vui v·∫ª'?", options: ["Bu·ªìn b√£", "H·∫°nh ph√∫c", "T·ª©c gi·∫≠n", "S·ª£ h√£i"], answer: "H·∫°nh ph√∫c" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'B·∫ßu tr·ªùi ...'", options: ["xanh", "ƒë·ªè", "v√†ng", "ƒëen"], answer: "xanh" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn 'anh'?", options: ["Chanh", "Cam", "Qu√Ωt", "B∆∞·ªüi"], answer: "Chanh" },
                        { question: "T·ª´ n√†o tr√°i nghƒ©a v·ªõi 'cao'?", options: ["D√†i", "Ng·∫Øn", "Th·∫•p", "R·ªông"], answer: "Th·∫•p" },
                        { question: "T√¨m t·ª´ ch·ªâ ho·∫°t ƒë·ªông 'ƒë·ªçc'?", options: ["Vi·∫øt b√†i", "Nghe nh·∫°c", "ƒê·ªçc s√°ch", "Ch∆°i game"], answer: "ƒê·ªçc s√°ch" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'Con g√† ... th√≥c.'", options: ["u·ªëng", "m·ªï", "ng·ªß", "bay"], answer: "m·ªï" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn 'inh'?", options: ["Xinh", "Xanh", "ƒê·ªè", "V√†ng"], answer: "Xinh" },
                        { question: "T·ª´ n√†o l√† t√™n m·ªôt lo·∫°i ph∆∞∆°ng ti·ªán giao th√¥ng?", options: ["Nh√†", "C√¢y", "Xe ƒë·∫°p", "S√¥ng"], answer: "Xe ƒë·∫°p" },
                        { question: "T·ª´ n√†o ch·ªâ c·∫£m x√∫c 'y√™u th∆∞∆°ng'?", options: ["Gh√©t b·ªè", "Th√≠ch th√∫", "Y√™u qu√Ω", "Gi·∫≠n d·ªØ"], answer: "Y√™u qu√Ω" },
                        { question: "T·ª´ n√†o c√≥ ti·∫øng 'h·ªçc'?", options: ["Ch∆°i ƒë√πa", "H·ªçc b√†i", "ƒÇn u·ªëng", "Ng·ªß ngh·ªâ"], answer: "H·ªçc b√†i" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'M·∫∑t tr·ªùi ...'", options: ["l·∫∑n", "m·ªçc", "bay", "ch·∫°y"], answer: "m·ªçc" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn 'oan'?", options: ["To√°n", "Loan", "Ho√†n", "C·∫£ ba ƒë√°p √°n tr√™n"], answer: "C·∫£ ba ƒë√°p √°n tr√™n" },
                        { question: "T·ª´ n√†o l√† t√™n m·ªôt ngh·ªÅ nghi·ªáp?", options: ["B√°c sƒ©", "H·ªçc sinh", "Tr·∫ª em", "Ng∆∞·ªùi l·ªõn"], answer: "B√°c sƒ©" },
                        { question: "T·ª´ n√†o tr√°i nghƒ©a v·ªõi 's√°ng'?", options: ["T·ªëi", "Trong", "ƒê·ª•c", "Nhanh"], answer: "T·ªëi" },
                        { question: "T√¨m t·ª´ ch·ªâ ƒë·ªì d√πng h·ªçc t·∫≠p?", options: ["B√°t", "ƒê≈©a", "C·∫∑p s√°ch", "Ch√©n"], answer: "C·∫∑p s√°ch" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'Con m√®o ... chu·ªôt.'", options: ["b·∫Øt", "th·∫£", "ng·∫Øm", "ƒëu·ªïi"], answer: "b·∫Øt" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn '∆∞∆°i'?", options: ["T∆∞∆°i", "C∆∞·ªùi", "M∆∞·ªùi", "C·∫£ ba ƒë√°p √°n tr√™n"], answer: "C·∫£ ba ƒë√°p √°n tr√™n" },
                        { question: "T·ª´ n√†o l√† t√™n m·ªôt b·ªô ph·∫≠n tr√™n c∆° th·ªÉ ng∆∞·ªùi?", options: ["√Åo", "Qu·∫ßn", "M·∫Øt", "Gi√†y"], answer: "M·∫Øt" },
                        { question: "T·ª´ n√†o ch·ªâ h√†nh ƒë·ªông 'nh·∫£y'?", options: ["ƒêi b·ªô", "Ch·∫°y nhanh", "Nh·∫£y d√¢y", "Ng·ªìi y√™n"], answer: "Nh·∫£y d√¢y" }
                    ]
                },
                lop2: {
                    hocky1: [
                        { question: "T·ª´ n√†o l√† t·ª´ ch·ªâ s·ª± v·∫≠t?", options: ["Ch·∫°y", "ƒê·∫πp", "C√°i b√†n", "Vui"], answer: "C√°i b√†n" },
                        { question: "T·ª´ n√†o l√† t·ª´ ch·ªâ ho·∫°t ƒë·ªông?", options: ["Con m√®o", "ƒê·ªçc s√°ch", "M√†u xanh", "Cao l·ªõn"], answer: "ƒê·ªçc s√°ch" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'D√≤ng s√¥ng ...'", options: ["ch·∫£y", "ƒë·ª©ng", "ng·ªß", "bay"], answer: "ch·∫£y" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn 'i√™ng'?", options: ["Ti·∫øng", "Mi·∫øng", "Chi√™ng", "C·∫£ ba ƒë√°p √°n tr√™n"], answer: "C·∫£ ba ƒë√°p √°n tr√™n" },
                        { question: "T·ª´ n√†o l√† t·ª´ ch·ªâ ƒë·∫∑c ƒëi·ªÉm?", options: ["Con ch√≥", "C√°i k√©o", "Xinh ƒë·∫πp", "Ng·ªß"], answer: "Xinh ƒë·∫πp" },
                        { question: "T√¨m t·ª´ tr√°i nghƒ©a v·ªõi 'nhanh'?", options: ["Ch·∫≠m", "V·ªôi", "G·∫•p", "Nhanh nh·∫πn"], answer: "Ch·∫≠m" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'B√¥ng hoa ...'", options: ["n·ªü", "t√†n", "r·ª•ng", "h√©o"], answer: "n·ªü" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn 'u√¥n'?", options: ["Bu·ªìn", "Vui", "S∆∞·ªõng", "Kh·ªï"], answer: "Bu·ªìn" },
                        { question: "T·ª´ n√†o l√† t√™n m·ªôt m√πa trong nƒÉm?", options: ["Th√°ng", "Tu·∫ßn", "M√πa h√®", "Ng√†y"], answer: "M√πa h√®" },
                        { question: "T·ª´ n√†o l√† t·ª´ l√°y?", options: ["Xanh", "Xanh xanh", "ƒê·ªè", "Tr·∫Øng"], answer: "Xanh xanh" },
                        { question: "T·ª´ n√†o l√† t·ª´ gh√©p?", options: ["ƒêi", "H·ªçc", "S√°ch v·ªü", "ƒÇn"], answer: "S√°ch v·ªü" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'Chim h√≥t ...'", options: ["l√≠u lo", "g√¢u g√¢u", "meo meo", "qu√°c qu√°c"], answer: "l√≠u lo" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn '∆∞∆°n'?", options: ["V∆∞·ªùn", "Tr∆∞·ªùng", "ƒê∆∞·ªùng", "C·∫£ ba ƒë√°p √°n tr√™n"], answer: "C·∫£ ba ƒë√°p √°n tr√™n" },
                        { question: "T·ª´ n√†o l√† t√™n m·ªôt lo·∫°i nh·∫°c c·ª•?", options: ["B√≥ng ƒë√°", "ƒê√†n piano", "V·∫Ω tranh", "H√°t"], answer: "ƒê√†n piano" },
                        { question: "T·ª´ n√†o tr√°i nghƒ©a v·ªõi 'l√™n'?", options: ["Xu·ªëng", "Trong", "Ngo√†i", "Tr√™n"], answer: "Xu·ªëng" },
                        { question: "T√¨m t·ª´ ch·ªâ t√¨nh c·∫£m gia ƒë√¨nh?", options: ["B·∫°n b√®", "T√¨nh y√™u", "T√¨nh b·∫°n", "T√¨nh c·∫£m"], answer: "T√¨nh y√™u" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'M·∫∑t trƒÉng ...'", options: ["tr√≤n", "vu√¥ng", "d√†i", "ng·∫Øn"], answer: "tr√≤n" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn 'oai'?", options: ["Khoai", "Ngo·∫°i", "Tho·∫£i m√°i", "C·∫£ ba ƒë√°p √°n tr√™n"], answer: "C·∫£ ba ƒë√°p √°n tr√™n" },
                        { question: "T·ª´ n√†o l√† t√™n m·ªôt lo·∫°i rau c·ªß?", options: ["Th·ªãt", "C√°", "C√† chua", "Tr·ª©ng"], answer: "C√† chua" },
                        { question: "T·ª´ n√†o l√† t·ª´ ƒë·ªìng √¢m kh√°c nghƒ©a?", options: ["ƒê∆∞·ªùng (ƒëi) - ƒê∆∞·ªùng (ƒÉn)", "B√†n (gh·∫ø) - B√†n (lu·∫≠n)", "C·∫£ hai ƒë√°p √°n tr√™n", "Kh√¥ng c√≥"], answer: "C·∫£ hai ƒë√°p √°n tr√™n" }
                    ],
                    hocky2: [
                        { question: "T·ª´ n√†o l√† t·ª´ ch·ªâ s·ªë l∆∞·ª£ng?", options: ["Nhanh", "ƒê·∫πp", "NƒÉm", "ƒÇn"], answer: "NƒÉm" },
                        { question: "T·ª´ n√†o l√† t·ª´ ch·ªâ th·ªùi gian?", options: ["H√¥m nay", "S√°ch", "B√∫t", "C√°i gh·∫ø"], answer: "H√¥m nay" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'Con s√¥ng ... ra bi·ªÉn.'", options: ["ch·∫£y", "ƒë·ª©ng", "ng·ªß", "bay"], answer: "ch·∫£y" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn 'uy√™n'?", options: ["Quy·ªÉn", "Huy·ªÅn", "Xuy√™n", "C·∫£ ba ƒë√°p √°n tr√™n"], answer: "C·∫£ ba ƒë√°p √°n tr√™n" },
                        { question: "T·ª´ n√†o l√† t·ª´ ch·ªâ m√†u s·∫Øc?", options: ["Vui", "Bu·ªìn", "T√≠m", "Ch·∫°y"], answer: "T√≠m" },
                        { question: "T√¨m t·ª´ tr√°i nghƒ©a v·ªõi 'm·ªü'?", options: ["ƒê√≥ng", "M·ªü ra", "M·ªü c·ª≠a", "M·ªü s√°ch"], answer: "ƒê√≥ng" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'C√¢y c·ªëi ... l√°.'", options: ["r·ª•ng", "m·ªçc", "n·ªü", "h√©o"], answer: "r·ª•ng" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn '∆∞∆°i'?", options: ["T∆∞∆°i", "C∆∞·ªùi", "M∆∞·ªùi", "C·∫£ ba ƒë√°p √°n tr√™n"], answer: "C·∫£ ba ƒë√°p √°n tr√™n" },
                        { question: "T·ª´ n√†o l√† t√™n m·ªôt lo·∫°i ƒë·ªông v·∫≠t hoang d√£?", options: ["Ch√≥", "M√®o", "H·ªï", "G√†"], answer: "H·ªï" },
                        { question: "T·ª´ n√†o l√† t·ª´ t∆∞·ª£ng thanh?", options: ["Xinh ƒë·∫πp", "L·∫•p l√°nh", "K√™u meo meo", "Bu·ªìn b√£"], answer: "K√™u meo meo" },
                        { question: "T·ª´ n√†o l√† t·ª´ l√°y v·∫ßn?", options: ["L·∫•p l√°nh", "Xanh xanh", "ƒê·ªè ƒë·ªè", "Tr·∫Øng tinh"], answer: "L·∫•p l√°nh" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'Gi√≥ ...'", options: ["th·ªïi", "ch·∫°y", "ng·ªß", "ƒÉn"], answer: "th·ªïi" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn 'i√™u'?", options: ["Y√™u", "Ki√™u", "Hi·ªÉu", "C·∫£ ba ƒë√°p √°n tr√™n"], answer: "C·∫£ ba ƒë√°p √°n tr√™n" },
                        { question: "T·ª´ n√†o l√† t√™n m·ªôt lo·∫°i ƒë·ªì u·ªëng?", options: ["C∆°m", "Ph·ªü", "N∆∞·ªõc cam", "B√°nh m√¨"], answer: "N∆∞·ªõc cam" },
                        { question: "T·ª´ n√†o tr√°i nghƒ©a v·ªõi 'v√†o'?", options: ["Ra", "Trong", "Ngo√†i", "Tr√™n"], answer: "Ra" },
                        { question: "T√¨m t·ª´ ch·ªâ ho·∫°t ƒë·ªông 'v·∫Ω'?", options: ["H√°t", "Nh·∫£y", "V·∫Ω tranh", "Ch∆°i ƒë√†n"], answer: "V·∫Ω tranh" },
                        { question: "ƒêi·ªÅn t·ª´ c√≤n thi·∫øu: 'Con chim ... tr√™n c√†nh.'", options: ["b∆°i", "bay", "ƒëi", "ng·ªß"], answer: "bay" },
                        { question: "T·ª´ n√†o c√≥ v·∫ßn 'u√Ωt'?", options: ["Qu√Ωt", "Ng·ªçt", "Chua", "ƒê·∫Øng"], answer: "Qu√Ωt" },
                        { question: "T·ª´ n√†o l√† t√™n m·ªôt lo·∫°i c√¢y ƒÉn qu·∫£?", options: ["C√¢y b√†ng", "C√¢y xo√†i", "C√¢y ph∆∞·ª£ng", "C√¢y tre"], answer: "C√¢y xo√†i" },
                        { question: "T·ª´ n√†o l√† t·ª´ H√°n Vi·ªát?", options: ["S√¥ng", "N√∫i", "Giang s∆°n", "ƒê·∫•t"], answer: "Giang s∆°n" }
                    ]
                }
            }
        };

        // --- STATE VARIABLES ---
        // These variables hold the current state of the game and user selections.
        let selectedSubject = null;
        let selectedGrade = null;
        let selectedSemester = null;
        let currentQuestions = []; // Array to hold questions for the current game session
        let currentQuestionIndex = 0; // Index of the current question
        let score = 0; // Player's score (raw, will be divided by 2 for final display)
        const NUM_OF_QUESTIONS_PER_GAME = 20; // Maximum number of questions per game

        // --- FIREBASE VARIABLES ---
        let db; // Firestore database instance
        let auth; // Firebase Auth instance
        let appId; // Application ID, derived from the environment or config

        // --- GET DOM ELEMENTS ---
        // Cache references to frequently used DOM elements for efficiency.
        const selectionScreen = document.getElementById('selection-screen');
        const gameScreen = document.getElementById('game-screen');
        const resultsScreen = document.getElementById('results-screen');
        const startBtn = document.getElementById('start-btn');
        const subjectBtns = document.querySelectorAll('[data-subject]');
        const gradeBtns = document.querySelectorAll('[data-grade]');
        const semesterBtns = document.querySelectorAll('[data-semester]');
        
        // DOM Elements for Admin Panel
        const adminPanel = document.getElementById('admin-panel');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const loginModal = document.getElementById('login-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const loginError = document.getElementById('login-error'); // For displaying login errors
        const viewHistoryBtn = document.getElementById('view-history-btn');
        const historyPanel = document.getElementById('history-panel');
        const backToAdminBtn = document.getElementById('back-to-admin-btn');
        const historyTableContainer = document.getElementById('history-table-container');

        // New DOM element for the speaker button (renamed to reflect its original purpose)
        const readQuestionBtn = document.getElementById('read-question-btn');


        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
        // This function initializes Firebase and handles user authentication.
        async function initializeFirebase() {
            try {
                let firebaseConfig;
                let currentAppId;

                // Attempt to use global __firebase_config and __app_id provided by the Canvas environment.
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    try {
                        firebaseConfig = JSON.parse(__firebase_config);
                    } catch (e) {
                        console.error("Error parsing __firebase_config:", e);
                        // Fallback to a hardcoded config if parsing fails, for development/testing
                        firebaseConfig = {
                            apiKey: "YOUR_FALLBACK_API_KEY", // Replace with a valid fallback API key if needed
                            authDomain: "YOUR_FALLBACK_AUTH_DOMAIN",
                            projectId: "YOUR_FALLBACK_PROJECT_ID",
                            storageBucket: "YOUR_FALLBACK_STORAGE_BUCKET",
                            messagingSenderId: "YOUR_FALLBACK_MESSAGING_SENDER_ID",
                            appId: "YOUR_FALLBACK_APP_ID",
                            measurementId: "YOUR_FALLBACK_MEASUREMENT_ID"
                        };
                    }
                    // Prioritize __app_id if available, otherwise use appId from firebaseConfig
                    currentAppId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.appId;
                } else {
                    // Fallback to hardcoded config if no global config is provided at all
                    console.warn("No __firebase_config found. Using hardcoded fallback Firebase configuration.");
                    firebaseConfig = {
                        apiKey: "YOUR_FALLBACK_API_KEY", // Replace with a valid fallback API key if needed
                        authDomain: "YOUR_FALLBACK_AUTH_DOMAIN",
                        projectId: "YOUR_FALLBACK_PROJECT_ID",
                        storageBucket: "YOUR_FALLBACK_STORAGE_BUCKET",
                        messagingSenderId: "YOUR_FALLBACK_MESSAGING_SENDER_ID",
                        appId: "YOUR_FALLBACK_APP_ID",
                        measurementId: "YOUR_FALLBACK_MEASUREMENT_ID"
                    };
                    currentAppId = firebaseConfig.appId; // Use appId from the hardcoded config
                }

                // Basic validation for Firebase config
                if (!firebaseConfig.projectId || !firebaseConfig.apiKey) {
                    console.error("Firebase config is missing projectId or apiKey. Please check your Firebase setup.");
                    document.getElementById('feedback-container').textContent = "L·ªói: C·∫•u h√¨nh Firebase kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i.";
                    return;
                }

                // Initialize Firebase app
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app); // Get Auth instance
                db = getFirestore(app); // Get Firestore instance
                appId = currentAppId; // Set the global appId variable for Firestore paths

                // Authenticate user using __initial_auth_token or anonymously
                // This ensures the user is authenticated before any Firestore operations.
                if (typeof __initial_auth_token !== 'undefined') {
                    await signInWithCustomToken(auth, __initial_auth_token).catch(error => {
                        console.error("Custom token sign-in error:", error);
                        // Fallback to anonymous sign-in if custom token fails
                        signInAnonymously(auth).catch(anonError => {
                            console.error("Anonymous sign-in fallback error:", anonError);
                        });
                    });
                } else {
                    // Sign in anonymously if no custom token is provided
                    signInAnonymously(auth).catch(error => {
                        console.error("Anonymous sign-in error:", error);
                    });
                }

                // Optional: Listen for auth state changes (useful for debugging or dynamic UI based on auth)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("User is signed in:", user.uid);
                    } else {
                        console.log("No user is signed in.");
                    }
                });

            } catch (error) {
                console.error("Firebase initialization error:", error);
                document.getElementById('feedback-container').textContent = "L·ªói: Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu. Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh Firebase c·ªßa b·∫°n.";
            }
        }
        
        // --- SAVE AND DISPLAY HISTORY (USING FIRESTORE) ---
        // Saves the quiz result to Firestore.
        async function saveResult(resultData) {
            // Ensure db and appId are initialized before attempting to save
            if (!db || !appId) {
                console.error("Firestore DB or App ID not initialized. Cannot save result.");
                return;
            }
            try {
                // Ensure user is authenticated before saving.
                // This check is crucial for Firestore security rules.
                if (!auth.currentUser) {
                    console.warn("User not authenticated. Attempting anonymous sign-in before saving.");
                    await signInAnonymously(auth);
                }
                
                // Firestore collection path for public data: /artifacts/{appId}/public/data/quizResults
                const historyCollectionRef = collection(db, `artifacts/${appId}/public/data/quizResults`);
                await addDoc(historyCollectionRef, resultData);
                console.log("Quiz result saved successfully!");
            } catch (e) {
                console.error("Error writing result to Firestore:", e);
                document.getElementById('feedback-container').textContent = "L·ªói khi l∆∞u k·∫øt qu·∫£. Vui l√≤ng th·ª≠ l·∫°i.";
            }
        }

        // Fetches and displays the quiz history from Firestore.
        async function displayHistory() {
            adminPanel.classList.add('hidden');
            historyPanel.classList.remove('hidden');
            
            // Display loading message while fetching data
            historyTableContainer.innerHTML = '<p class="text-center text-gray-500">ƒêang t·∫£i l·ªãch s·ª≠...</p>';

            // Ensure db and appId are initialized
            if (!db || !appId) {
                historyTableContainer.innerHTML = '<p class="text-center text-red-500">L·ªói k·∫øt n·ªëi CSDL ho·∫∑c App ID ch∆∞a ƒë∆∞·ª£c thi·∫øt l·∫≠p.</p>';
                console.error("DB or appId not initialized. Cannot display history.");
                return;
            }
            
            try {
                // Ensure user is authenticated before fetching history.
                if (!auth.currentUser) {
                    console.warn("User not authenticated. Attempting anonymous sign-in before fetching history.");
                    await signInAnonymously(auth);
                }

                // Firestore collection path for public data
                const historyCollectionRef = collection(db, `artifacts/${appId}/public/data/quizResults`);
                // Fetch documents from the collection.
                // IMPORTANT: orderBy() is avoided as per instructions to prevent index missing errors.
                // Sorting will be done in memory using JavaScript.
                const querySnapshot = await getDocs(historyCollectionRef);
                
                historyTableContainer.innerHTML = ''; // Clear loading message

                if (querySnapshot.empty) {
                    historyTableContainer.innerHTML = '<p class="text-center text-gray-500">Ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i.</p>';
                    return;
                }

                const results = [];
                querySnapshot.forEach((doc) => {
                    results.push(doc.data());
                });

                // Sort results by date in descending order (newest first) in JavaScript memory.
                results.sort((a, b) => {
                    // Handle both Firestore Timestamp objects and plain Date strings/objects
                    const dateA = a.date && a.date.toDate ? a.date.toDate().getTime() : new Date(a.date).getTime();
                    const dateB = b.date && b.date.toDate ? b.date.toDate().getTime() : new Date(b.date).getTime();
                    return dateB - dateA; // Descending order
                });

                // Mapping for display names
                const nameMap = { toan: 'To√°n', tiengviet: 'Ti·∫øng Vi·ªát', lop1: 'L·ªõp 1', lop2: 'L·ªõp 2', hocky1: 'H·ªçc K·ª≥ 1', hocky2: 'H·ªçc K·ª≥ 2' };
                
                // Create the history table HTML
                const table = document.createElement('table');
                table.classList.add('min-w-full', 'divide-y', 'divide-gray-200', 'rounded-lg', 'overflow-hidden');
                table.innerHTML = `
                    <thead class="bg-gray-100/50">
                        <tr>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Ng√†y Gi·ªù</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">M√¥n</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">L·ªõp</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">H·ªçc K·ª≥</th>
                            <th scope="col" class="px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">ƒêi·ªÉm</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white/30 divide-y divide-gray-200 text-gray-800"></tbody>
                `;
                const tbody = table.querySelector('tbody');

                // Populate the table with fetched results
                results.forEach((result) => {
                    const row = tbody.insertRow();
                    // Convert Firestore Timestamp to a readable Date string
                    const date = result.date && result.date.toDate ? result.date.toDate() : new Date(result.date);
                    const formattedDate = date.toLocaleString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    row.innerHTML = `
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${formattedDate}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${nameMap[result.subject] || result.subject}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${nameMap[result.grade] || result.grade}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm">${nameMap[result.semester] || result.semester}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-bold">${result.score}/10</td>
                    `;
                });
                historyTableContainer.appendChild(table);

            } catch (e) {
                console.error("Error fetching history from Firestore:", e);
                historyTableContainer.innerHTML = '<p class="text-center text-red-500">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠. L·ªói quy·ªÅn truy c·∫≠p ho·∫∑c k·∫øt n·ªëi.</p>';
            }
        }
        
        // Hides the history panel and shows the admin panel.
        function hideHistory() {
            historyPanel.classList.add('hidden');
            adminPanel.classList.remove('hidden');
        }

        // --- GAME LOGIC FUNCTIONS ---
        // Updates the state of the "Start" button based on selections.
        function updateStartButtonState() { 
            if (selectedSubject && selectedGrade && selectedSemester) { 
                startBtn.disabled = false; 
                startBtn.classList.remove('bg-gray-500/50', 'cursor-not-allowed'); 
                startBtn.classList.add('bg-blue-600/70', 'hover:bg-blue-600/90'); 
            } else { 
                startBtn.disabled = true; 
                startBtn.classList.add('bg-gray-500/50', 'cursor-not-allowed'); 
                startBtn.classList.remove('bg-blue-600/70', 'hover:bg-blue-600/90'); 
            } 
        }

        // Initiates the game, shuffles questions, and displays the first one.
        function startGame() { 
            // Validate that questions exist for the selected criteria
            if (!questions[selectedSubject] || !questions[selectedSubject][selectedGrade] || !questions[selectedSubject][selectedGrade][selectedSemester]) {
                console.error("No questions found for the selected criteria:", selectedSubject, selectedGrade, selectedSemester);
                // Provide user feedback instead of an alert
                document.getElementById('feedback-container').textContent = 'Kh√¥ng c√≥ c√¢u h·ªèi cho l·ª±a ch·ªçn n√†y. Vui l√≤ng ch·ªçn l·∫°i.';
                // Optionally, reset the selection screen or keep it for user to re-select
                return; 
            }

            let allQuestions = questions[selectedSubject][selectedGrade][selectedSemester]; 
            // Shuffle questions and select the first NUM_OF_QUESTIONS_PER_GAME
            currentQuestions = allQuestions.sort(() => 0.5 - Math.random()).slice(0, NUM_OF_QUESTIONS_PER_GAME); 
            currentQuestionIndex = 0; 
            score = 0; 

            // Transition to game screen
            selectionScreen.classList.add('hidden'); 
            gameScreen.classList.remove('hidden'); 
            resultsScreen.classList.add('hidden'); 
            adminPanel.classList.add('hidden'); // Ensure admin panel is hidden
            historyPanel.classList.add('hidden'); // Ensure history panel is hidden

            displayQuestion(); // Display the first question
        }

        // Displays the current question and its options.
        function displayQuestion() { 
            document.getElementById('feedback-container').innerHTML = ''; // Clear previous feedback
            document.getElementById('next-btn').classList.add('hidden'); // Hide next button until answer is checked

            const questionData = currentQuestions[currentQuestionIndex]; 
            const questionTextElement = document.getElementById('question-container').querySelector('p');
            questionTextElement.textContent = questionData.question; 

            const optionsContainer = document.getElementById('options-container'); 
            optionsContainer.innerHTML = ''; // Clear previous options

            // Shuffle options for the current question
            const shuffledOptions = [...questionData.options].sort(() => Math.random() - 0.5); 
            shuffledOptions.forEach(option => { 
                const button = document.createElement('button'); 
                button.textContent = option; 
                // Add Tailwind classes and event listener
                button.classList.add('answer-option', 'w-full', 'p-4', 'rounded-2xl', 'font-semibold', 'glass-btn', 'bg-white/20', 'hover:bg-white/40', 'text-gray-800');
                button.onclick = (e) => checkAnswer(e.target, questionData.answer); 
                optionsContainer.appendChild(button); 
            }); 

            // Update progress and score display
            document.getElementById('progress-text').textContent = `C√¢u ${currentQuestionIndex + 1}/${currentQuestions.length}`; 
            // Score is divided by 2 because each question contributes 0.5 points to a total of 10 points.
            document.getElementById('score-text').textContent = `ƒêi·ªÉm: ${score / 2}/10`; 

            // Show speaker button on game screen and set its click handler
            if (readQuestionBtn) {
                readQuestionBtn.style.display = 'block'; // Ensure it's visible
                readQuestionBtn.onclick = () => speakText(questionData.question); // Call speakText for the question
            }
        }

        // Checks the selected answer and provides feedback.
        function checkAnswer(selectedButton, correctAnswer) { 
            const allOptions = document.querySelectorAll('.answer-option'); 
            // Disable all options after an answer is selected
            allOptions.forEach(btn => btn.disabled = true); 

            const feedbackContainer = document.getElementById('feedback-container'); 

            if (selectedButton.textContent == correctAnswer) { 
                score++; // Increment raw score
                selectedButton.classList.add('correct'); // Highlight correct answer
                feedbackContainer.textContent = 'üéâ ƒê√∫ng r·ªìi!'; 
            } else { 
                selectedButton.classList.add('incorrect'); // Highlight incorrect answer
                feedbackContainer.textContent = 'üò• Sai r·ªìi!'; 
                // Also highlight the correct answer if the user chose incorrectly
                allOptions.forEach(btn => { 
                    if (btn.textContent == correctAnswer) { 
                        btn.classList.add('correct'); 
                    } 
                }); 
            } 
            // Update score display immediately after checking answer
            document.getElementById('score-text').textContent = `ƒêi·ªÉm: ${score / 2}/10`; 
            document.getElementById('next-btn').classList.remove('hidden'); // Show next button
            
            // Stop any ongoing speech when an answer is selected
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }
        }

        // Moves to the next question or shows results if all questions are answered.
        function nextQuestion() { 
            currentQuestionIndex++; 
            if (currentQuestionIndex < currentQuestions.length) { 
                displayQuestion(); 
            } else { 
                showResults(); 
            } 
        }

        // Displays the final results screen and saves the score.
        function showResults() { 
            gameScreen.classList.add('hidden'); 
            resultsScreen.classList.remove('hidden'); 

            const finalScore = score / 2; // Calculate final score out of 10
            document.getElementById('final-score').textContent = `${finalScore}/10`; 

            // Prepare result data for saving to Firestore
            const resultData = { 
                date: serverTimestamp(), // Use Firestore's server timestamp for accurate time
                subject: selectedSubject, 
                grade: selectedGrade, 
                semester: selectedSemester, 
                score: finalScore 
            }; 
            saveResult(resultData); // Save the result asynchronously

            // Provide a motivational message based on performance
            const finalMessageElement = document.getElementById('final-message'); 
            const percentage = (score / currentQuestions.length) * 100; 
            if (percentage === 100) { 
                finalMessageElement.textContent = "Xu·∫•t s·∫Øc! B√© th·∫≠t l√† gi·ªèi!"; 
            } else if (percentage >= 70) { 
                finalMessageElement.textContent = "Gi·ªèi l·∫Øm! C·ªë g·∫Øng th√™m ch√∫t n·ªØa nh√©!"; 
            } else if (percentage >= 50) { 
                finalMessageElement.textContent = "L√†m t·ªët l·∫Øm! Ti·∫øp t·ª•c luy·ªán t·∫≠p nh√©!"; 
            } else { 
                finalMessageElement.textContent = "ƒê·ª´ng bu·ªìn, l·∫ßn sau s·∫Ω t·ªët h∆°n!"; 
            } 
            
            // Hide speaker button on results screen (as it's for questions)
            if (readQuestionBtn) {
                readQuestionBtn.style.display = 'none';
            }
            // If you want a speaker for results, you would add a new button on the results screen
            // and attach a speakText function to it.
        }

        // Resets the game to the initial selection screen.
        function resetGame() { 
            resultsScreen.classList.add('hidden'); 
            selectionScreen.classList.remove('hidden'); 
            // Reset all selections
            selectedSubject = null; 
            selectedGrade = null; 
            selectedSemester = null; 
            // Remove 'selected' class from all choice buttons
            subjectBtns.forEach(btn => btn.classList.remove('selected')); 
            gradeBtns.forEach(btn => btn.classList.remove('selected')); 
            semesterBtns.forEach(btn => btn.classList.remove('selected')); 
            updateStartButtonState(); // Update start button state

            // Hide speaker button on selection screen
            if (readQuestionBtn) {
                readQuestionBtn.style.display = 'none';
            }
        }

        // --- ADMIN FUNCTIONS ---
        // Shows the admin login modal.
        function showLoginModal() { 
            loginModal.classList.remove('hidden'); 
            // Add a slight delay for the opacity transition to work
            setTimeout(() => loginModal.classList.remove('opacity-0'), 10); 
        }

        // Hides the admin login modal and clears any error messages.
        function hideLoginModal() { 
            loginModal.classList.add('opacity-0'); 
            // Add a slight delay for the opacity transition before hiding completely
            setTimeout(() => loginModal.classList.add('hidden'), 300); 
            loginError.textContent = ''; // Clear any previous error messages
            loginForm.reset(); // Reset form fields
        }

        // Handles the admin login attempt.
        function handleLogin(event) { 
            event.preventDefault(); // Prevent default form submission
            const username = loginForm.username.value; 
            const password = loginForm.password.value; 
            
            // WARNING: Admin credentials are hardcoded for demonstration purposes.
            // In a production application, you MUST implement a secure authentication system
            // (e.g., using Firebase Authentication with user accounts and roles)
            // instead of hardcoding credentials.
            if (username === 'admin' && password === 'admin') { 
                hideLoginModal(); 
                selectionScreen.classList.add('hidden'); // Hide selection screen
                adminPanel.classList.remove('hidden'); // Show admin panel
            } else { 
                loginError.textContent = 'T√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng.'; // Display error message
            } 
        }

        // Handles admin logout, returning to the main selection screen.
        function handleLogout() { 
            adminPanel.classList.add('hidden'); // Hide admin panel
            selectionScreen.classList.remove('hidden'); // Show selection screen
            resetGame(); // Reset game state (clear selections)
        }

        // --- TEXT-TO-SPEECH FUNCTIONALITY ---
        let vietnamVoice = null;
        let voicesLoaded = false;

        // Function to find a Vietnamese voice
        function findVietnameseVoice() {
            if (vietnamVoice) return vietnamVoice; // Return if already found

            const voices = speechSynthesis.getVoices();
            // Try to find a Vietnamese voice first (vi-VN is the most specific)
            vietnamVoice = voices.find(voice => voice.lang === 'vi-VN');
            
            if (!vietnamVoice) {
                // Fallback to any Vietnamese voice if specific 'vi-VN' not found but a 'vi' exists
                vietnamVoice = voices.find(voice => voice.lang.startsWith('vi'));
            }

            if (!vietnamVoice) {
                console.warn("Kh√¥ng t√¨m th·∫•y gi·ªçng ƒë·ªçc ti·∫øng Vi·ªát. Tr√¨nh duy·ªát s·∫Ω s·ª≠ d·ª•ng gi·ªçng m·∫∑c ƒë·ªãnh. Vui l√≤ng ki·ªÉm tra c√†i ƒë·∫∑t ng√¥n ng·ªØ v√† gi·ªçng n√≥i tr√™n h·ªá ƒëi·ªÅu h√†nh c·ªßa b·∫°n.");
            }
            return vietnamVoice;
        }

        // Event listener for when voices are loaded
        speechSynthesis.onvoiceschanged = () => {
            if (!voicesLoaded) {
                findVietnameseVoice(); // Try to find voice once voices are loaded
                voicesLoaded = true;
            }
        };

        // Function to speak the given text
        function speakText(text) { 
            if (!'speechSynthesis' in window) {
                console.warn("API Chuy·ªÉn vƒÉn b·∫£n th√†nh gi·ªçng n√≥i kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£ trong tr√¨nh duy·ªát n√†y.");
                return;
            }

            // Cancel any ongoing speech before starting a new one
            if (speechSynthesis.speaking) {
                speechSynthesis.cancel();
            }

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'vi-VN'; // Set language to Vietnamese

            // Try to set a specific Vietnamese voice
            const voiceToUse = findVietnameseVoice();
            if (voiceToUse) {
                utterance.voice = voiceToUse;
            } else {
                // If no Vietnamese voice is found, it will use the default voice
                console.warn("Kh√¥ng th·ªÉ t√¨m th·∫•y gi·ªçng ƒë·ªçc ti·∫øng Vi·ªát c·ª• th·ªÉ. ƒêang s·ª≠ d·ª•ng gi·ªçng m·∫∑c ƒë·ªãnh.");
            }

            speechSynthesis.speak(utterance);
        }

        // --- EVENT LISTENERS ---
        // Add event listeners to subject, grade, and semester selection buttons.
        subjectBtns.forEach(btn => btn.addEventListener('click', () => { 
            selectedSubject = btn.dataset.subject; 
            subjectBtns.forEach(b => b.classList.remove('selected')); 
            btn.classList.add('selected'); 
            updateStartButtonState(); 
        }));

        gradeBtns.forEach(btn => btn.addEventListener('click', () => { 
            selectedGrade = btn.dataset.grade; 
            gradeBtns.forEach(b => b.classList.remove('selected')); 
            btn.classList.add('selected'); 
            updateStartButtonState(); 
        }));

        semesterBtns.forEach(btn => btn.addEventListener('click', () => { 
            selectedSemester = btn.dataset.semester; 
            semesterBtns.forEach(b => b.classList.remove('selected')); 
            btn.classList.add('selected'); 
            updateStartButtonState(); 
        }));

        // Add event listeners for game flow buttons.
        startBtn.addEventListener('click', () => { 
            if (!startBtn.disabled) startGame(); 
        });
        document.getElementById('next-btn').addEventListener('click', nextQuestion);
        document.getElementById('play-again-btn').addEventListener('click', resetGame);

        // Add event listeners for admin functionality.
        adminLoginBtn.addEventListener('click', showLoginModal);
        closeModalBtn.addEventListener('click', hideLoginModal);
        // Close modal if clicking outside the modal content
        loginModal.addEventListener('click', (e) => { 
            if (e.target === loginModal) hideLoginModal(); 
        });
        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);
        viewHistoryBtn.addEventListener('click', displayHistory);
        backToAdminBtn.addEventListener('click', hideHistory);
        
        // --- INITIAL APPLICATION START ---
        // Initialize Firebase when the script loads.
        initializeFirebase();

        // Initially hide the speaker button (it will be shown only on the game screen)
        if (readQuestionBtn) {
            readQuestionBtn.style.display = 'none';
        }

        // Check if voices are already loaded (can happen if script loads late)
        if (speechSynthesis.getVoices().length > 0) {
            findVietnameseVoice();
            voicesLoaded = true;
        }

    </script>
</body>
</html>